---
title: 重构从 Azure 云服务迁移的 Azure Service Fabric 应用程序
description: 如何重构从 Azure 云服务迁移的现有 Azure Service Fabric 应用程序
author: petertay
ms.date: 02/02/2018
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
ms.openlocfilehash: 1fd6bb5df18b46c8df3719fd107dd53a18dfd4ff
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/23/2019
ms.locfileid: "54487281"
---
# <a name="refactor-an-azure-service-fabric-application-migrated-from-azure-cloud-services"></a><span data-ttu-id="1bd29-103">重构从 Azure 云服务迁移的 Azure Service Fabric 应用程序</span><span class="sxs-lookup"><span data-stu-id="1bd29-103">Refactor an Azure Service Fabric Application migrated from Azure Cloud Services</span></span>

<span data-ttu-id="1bd29-104">[![GitHub](../_images/github.png) 示例代码][sample-code]</span><span class="sxs-lookup"><span data-stu-id="1bd29-104">[![GitHub](../_images/github.png) Sample code][sample-code]</span></span>

<span data-ttu-id="1bd29-105">本文介绍如何将现有的 Azure Service Fabric 应用程序重构为更精细的体系结构。</span><span class="sxs-lookup"><span data-stu-id="1bd29-105">This article describes refactoring an existing Azure Service Fabric application to a more granular architecture.</span></span> <span data-ttu-id="1bd29-106">本文侧重于重构的 Service Fabric 应用程序的设计、打包、性能和部署注意事项。</span><span class="sxs-lookup"><span data-stu-id="1bd29-106">This article focuses on the design, packaging, performance, and deployment considerations of the refactored Service Fabric application.</span></span>

## <a name="scenario"></a><span data-ttu-id="1bd29-107">场景</span><span class="sxs-lookup"><span data-stu-id="1bd29-107">Scenario</span></span>

<span data-ttu-id="1bd29-108">前一篇文章[将 Azure 云服务应用程序迁移到 Azure Service Fabric][migrate-from-cloud-services] 中已经提到，模式和实践团队在 2012 年编写了一篇指南，其中阐述了在 Azure 中设计和实施云服务应用程序的流程。</span><span class="sxs-lookup"><span data-stu-id="1bd29-108">As discussed in the previous article, [Migrating an Azure Cloud Services application to Azure Service Fabric][migrate-from-cloud-services], the patterns & practices team authored a book in 2012 that documented the process for designing and implementing a Cloud Services application in Azure.</span></span> <span data-ttu-id="1bd29-109">该指南介绍了一家名为 Tailspin 的虚构公司，他们想要创建一个名为 **Surveys** 的云服务应用程序。</span><span class="sxs-lookup"><span data-stu-id="1bd29-109">The book describes a fictitious company named Tailspin that wants to create a Cloud Services application named **Surveys**.</span></span> <span data-ttu-id="1bd29-110">用户可以通过 Surveys 应用程序创建和发布可让公众回答的调查表。</span><span class="sxs-lookup"><span data-stu-id="1bd29-110">The Surveys application allows users to create and publish surveys that can be answered by the public.</span></span> <span data-ttu-id="1bd29-111">下图展示了此 Surveys 应用程序版本的体系结构：</span><span class="sxs-lookup"><span data-stu-id="1bd29-111">The following diagram shows the architecture of this version of the Surveys application:</span></span>

![](./images/tailspin01.png)

<span data-ttu-id="1bd29-112">**Tailspin.Web** Web 角色托管一个 ASP.NET MVC 站点，Tailspin 客户可以使用它来：</span><span class="sxs-lookup"><span data-stu-id="1bd29-112">The **Tailspin.Web** web role hosts an ASP.NET MVC site that Tailspin customers use to:</span></span>
* <span data-ttu-id="1bd29-113">注册 Surveys 应用程序；</span><span class="sxs-lookup"><span data-stu-id="1bd29-113">sign up for the Surveys application,</span></span>
* <span data-ttu-id="1bd29-114">创建或删除单个调查表；</span><span class="sxs-lookup"><span data-stu-id="1bd29-114">create or delete a single survey,</span></span>
* <span data-ttu-id="1bd29-115">查看单个调查表的结果；</span><span class="sxs-lookup"><span data-stu-id="1bd29-115">view results for a single survey,</span></span>
* <span data-ttu-id="1bd29-116">请求将调查表结果导出到 SQL；</span><span class="sxs-lookup"><span data-stu-id="1bd29-116">request that survey results be exported to SQL, and</span></span>
* <span data-ttu-id="1bd29-117">查看聚合的调查表结果和分析。</span><span class="sxs-lookup"><span data-stu-id="1bd29-117">view aggregated survey results and analysis.</span></span>

<span data-ttu-id="1bd29-118">**Tailspin.Web.Survey.Public** Web 角色还托管一个可让公众访问的、以便填写调查表的 ASP.NET MVC 站点。</span><span class="sxs-lookup"><span data-stu-id="1bd29-118">The **Tailspin.Web.Survey.Public** web role also hosts an ASP.NET MVC site that the public visits to fill out the surveys.</span></span> <span data-ttu-id="1bd29-119">这些响应将在队列中保存。</span><span class="sxs-lookup"><span data-stu-id="1bd29-119">These responses are put in a queue to be saved.</span></span>

<span data-ttu-id="1bd29-120">**Tailspin.Workers.Survey** 辅助角色通过从多个队列中拾取请求来执行后台处理。</span><span class="sxs-lookup"><span data-stu-id="1bd29-120">The **Tailspin.Workers.Survey** worker role performs background processing by picking up requests from multiple queues.</span></span>

<span data-ttu-id="1bd29-121">后来，模式和实践团队又创建了一个新项目，用于将此应用程序移植到 Azure Service Fabric。</span><span class="sxs-lookup"><span data-stu-id="1bd29-121">The patterns & practices team then created a new project to port this application to Azure Service Fabric.</span></span> <span data-ttu-id="1bd29-122">此项目的目标是只需做出必要的代码更改，就能让应用程序在 Azure Service Fabric 群集中运行。</span><span class="sxs-lookup"><span data-stu-id="1bd29-122">The goal of this project was to make only the necessary code changes to get the application running in an Azure Service Fabric cluster.</span></span> <span data-ttu-id="1bd29-123">因此，原始的 Web 和辅助角色并未分解成更精细的体系结构。</span><span class="sxs-lookup"><span data-stu-id="1bd29-123">As a result, the original web and worker roles were not decomposed into a more granular architecture.</span></span> <span data-ttu-id="1bd29-124">最终的体系结构与云服务版本的应用程序非常类似：</span><span class="sxs-lookup"><span data-stu-id="1bd29-124">The resulting architecture is very similar to the Cloud Service version of the application:</span></span>

![](./images/tailspin02.png)

<span data-ttu-id="1bd29-125">**Tailspin.Web** 服务是从原始 *Tailspin.Web* Web 角色移植的。</span><span class="sxs-lookup"><span data-stu-id="1bd29-125">The **Tailspin.Web** service is ported from the original *Tailspin.Web* web role.</span></span>

<span data-ttu-id="1bd29-126">**Tailspin.Web.Survey.Public** 服务是从原始 *Tailspin.Web.Survey.Public* Web 角色移植的。</span><span class="sxs-lookup"><span data-stu-id="1bd29-126">The **Tailspin.Web.Survey.Public** service is ported from the original *Tailspin.Web.Survey.Public* web role.</span></span>

<span data-ttu-id="1bd29-127">**Tailspin.AnswerAnalysisService** 服务是从原始 *Tailspin.Workers.Survey* 辅助角色移植的。</span><span class="sxs-lookup"><span data-stu-id="1bd29-127">The **Tailspin.AnswerAnalysisService** service is ported from the original *Tailspin.Workers.Survey* worker role.</span></span>

> [!NOTE] 
> <span data-ttu-id="1bd29-128">尽量对每个 Web 角色和辅助角色所做的代码更改极少，但 **Tailspin.Web** 和 **Tailspin.Web.Survey.Public** 经过修改，以便自我托管 [Kestrel] Web 服务器。</span><span class="sxs-lookup"><span data-stu-id="1bd29-128">While minimal code changes were made to each of the web and worker roles, **Tailspin.Web** and **Tailspin.Web.Survey.Public** were modified to self-host a [Kestrel] web server.</span></span> <span data-ttu-id="1bd29-129">初期的 Surveys 应用程序是使用 Interet Information Services (IIS) 托管的 ASP.NET 应用程序，但无法在 Service Fabric 中以服务的形式运行 IIS。</span><span class="sxs-lookup"><span data-stu-id="1bd29-129">The earlier Surveys application is an ASP.NET application that was hosted using Interet Information Services (IIS), but it is not possible to run IIS as a service in Service Fabric.</span></span> <span data-ttu-id="1bd29-130">因此，任何 Web 服务器（例如 [Kestrel]）必须能够自我托管。</span><span class="sxs-lookup"><span data-stu-id="1bd29-130">Therefore, any web server must be capable of being self-hosted, such as [Kestrel].</span></span> <span data-ttu-id="1bd29-131">在某些情况下，可以在 Service Fabric 的容器中运行 IIS。</span><span class="sxs-lookup"><span data-stu-id="1bd29-131">It is possible to run IIS in a container in Service Fabric in some situations.</span></span> <span data-ttu-id="1bd29-132">有关详细信息，请参阅[容器的使用方案][container-scenarios]。</span><span class="sxs-lookup"><span data-stu-id="1bd29-132">See [scenarios for using containers][container-scenarios] for more information.</span></span>  

<span data-ttu-id="1bd29-133">现在，Tailspin 可将 Surveys 应用程序重构为更精细的体系结构。</span><span class="sxs-lookup"><span data-stu-id="1bd29-133">Now, Tailspin is refactoring the Surveys application to a more granular architecture.</span></span> <span data-ttu-id="1bd29-134">Tailspin 的重构动机是更方便地开发、生成和部署 Surveys 应用程序。</span><span class="sxs-lookup"><span data-stu-id="1bd29-134">Tailspin's motivation for refactoring is to make it easier to develop, build, and deploy the Surveys application.</span></span> <span data-ttu-id="1bd29-135">Tailspin 希望通过将现有的 Web 角色和辅助角色分解成更精细的体系结构，来消除现有的紧密耦合通信，以及这些角色之间的数据依赖关系。</span><span class="sxs-lookup"><span data-stu-id="1bd29-135">By decomposing the existing web and worker roles to a more granular architecture, Tailspin wants to remove the existing tightly coupled communication and data dependencies between these roles.</span></span>

<span data-ttu-id="1bd29-136">Tailspin 认识到了将 Surveys 应用程序转换成更精细体系结构所带来的优势：</span><span class="sxs-lookup"><span data-stu-id="1bd29-136">Tailspin sees other benefits in moving the Surveys application to a more granular architecture:</span></span>
* <span data-ttu-id="1bd29-137">可将每个服务打包成独立的项目，其作用范围很小，小型团队即可对其进行管理。</span><span class="sxs-lookup"><span data-stu-id="1bd29-137">Each service can be packaged into independent projects with a scope small enough to be managed by a small team.</span></span>
* <span data-ttu-id="1bd29-138">可以单独对每个服务进行版本控制和部署。</span><span class="sxs-lookup"><span data-stu-id="1bd29-138">Each service can be independently versioned and deployed.</span></span>
* <span data-ttu-id="1bd29-139">可以使用每个服务适用的最佳技术来实现该服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-139">Each service can be implemented using the best technology for that service.</span></span> <span data-ttu-id="1bd29-140">例如，可以在一个 Service Fabric 群集中，包含使用不同版本的 .Net Framework、Java 或其他语言（例如 C 或 C++）生成的服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-140">For example, a service fabric cluster can include services built using different versions of the .Net Frameworks, Java, or other languages such as C or C++.</span></span>
* <span data-ttu-id="1bd29-141">每个服务可以独立缩放，以应对负载的增减。</span><span class="sxs-lookup"><span data-stu-id="1bd29-141">Each service can be independently scaled to respond to increases and decreases in load.</span></span>

> [!NOTE] 
> <span data-ttu-id="1bd29-142">多租户不在此应用程序的重构范围内。</span><span class="sxs-lookup"><span data-stu-id="1bd29-142">Multitenancy is out of scope for the refactoring of this application.</span></span> <span data-ttu-id="1bd29-143">Tailspin 提供多种选项来支持多租户，以后客户可以做出相关的设计决策，而不影响初始设计。</span><span class="sxs-lookup"><span data-stu-id="1bd29-143">Tailspin has several options to support multitenancy and can make these design decisions later without affecting the initial design.</span></span> <span data-ttu-id="1bd29-144">例如，Tailspin 可以针对群集中的每个租户创建单独的服务实例，或者针对每个租户创建单独的群集。</span><span class="sxs-lookup"><span data-stu-id="1bd29-144">For example, Tailspin can create separate instances of the services for each tenant within a cluster or create a separate cluster for each tenant.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="1bd29-145">设计注意事项</span><span class="sxs-lookup"><span data-stu-id="1bd29-145">Design considerations</span></span>
 
<span data-ttu-id="1bd29-146">下图展示了已重构为更精细体系结构的 Surveys 应用程序的体系结构：</span><span class="sxs-lookup"><span data-stu-id="1bd29-146">The following diagram shows the architecture of the Surveys application refactored to a more granular architecture:</span></span>

![](./images/surveys_03.png)

<span data-ttu-id="1bd29-147">**Tailspin.Web** 是一个无状态服务，它自我托管一个可让 Tailspin 客户访问的、以便创建调查表和查看调查表结果的 ASP.NET MVC 应用程序。</span><span class="sxs-lookup"><span data-stu-id="1bd29-147">**Tailspin.Web** is a stateless service self-hosting an ASP.NET MVC application that Tailspin customers visit to create surveys and view survey results.</span></span> <span data-ttu-id="1bd29-148">此服务与已移植的 Service Fabric 应用程序中的 *Tailspin.Web* 服务共享其大部分代码。</span><span class="sxs-lookup"><span data-stu-id="1bd29-148">This service shares most of its code with the *Tailspin.Web* service from the ported Service Fabric application.</span></span> <span data-ttu-id="1bd29-149">如前所述，此服务使用 ASP.NET Core，并改用 Kestrel 作为 Web 前端来实现 WebListener。</span><span class="sxs-lookup"><span data-stu-id="1bd29-149">As mentioned earlier, this service uses ASP.NET core and switches from using Kestrel as web frontend to implementing a WebListener.</span></span>

<span data-ttu-id="1bd29-150">**Tailspin.Web.Survey.Public** 是一个无状态服务，它同样自我托管一个 ASP.NET MVC 站点。</span><span class="sxs-lookup"><span data-stu-id="1bd29-150">**Tailspin.Web.Survey.Public** is a stateless service also self-hosting an ASP.NET MVC site.</span></span> <span data-ttu-id="1bd29-151">用户可以访问此站点，从列表中选择调查表，然后填写调查表。此服务与已移植的 Service Fabric 应用程序中的 *Tailspin.Web.Survey.Public* 服务共享其大部分代码。</span><span class="sxs-lookup"><span data-stu-id="1bd29-151">Users visit this site to select surveys from a list and then fill them out. This service shares most of its code with the *Tailspin.Web.Survey.Public* service from the ported Service Fabric application.</span></span> <span data-ttu-id="1bd29-152">此服务也使用 ASP.NET Core，并改用 Kestrel 作为 Web 前端来实现 WebListener。</span><span class="sxs-lookup"><span data-stu-id="1bd29-152">This service also uses ASP.NET Core and also switches from using Kestrel as web frontend to implementing a WebListener.</span></span>

<span data-ttu-id="1bd29-153">**Tailspin.SurveyResponseService** 是一个有状态服务，它在 Azure Blob 存储中存储调查表答案。</span><span class="sxs-lookup"><span data-stu-id="1bd29-153">**Tailspin.SurveyResponseService** is a stateful service that stores survey answers in Azure Blob Storage.</span></span> <span data-ttu-id="1bd29-154">此外，它还将答案合并到调查表分析数据中。</span><span class="sxs-lookup"><span data-stu-id="1bd29-154">It also merges answers into the survey analysis data.</span></span> <span data-ttu-id="1bd29-155">之所以将该服务实现为有状态服务，是因为它使用 [ReliableConcurrentQueue][reliable-concurrent-queue] 来分批处理调查表答案。</span><span class="sxs-lookup"><span data-stu-id="1bd29-155">The service is implemented as a stateful service because it uses a [ReliableConcurrentQueue][reliable-concurrent-queue] to process survey answers in batches.</span></span> <span data-ttu-id="1bd29-156">此功能最初在移植的 Service Fabric 应用程序中的 *Tailspin.AnswerAnalysisService* 服务中实现。</span><span class="sxs-lookup"><span data-stu-id="1bd29-156">This functionality was originally implemented in the *Tailspin.AnswerAnalysisService* service in the ported Service Fabric application.</span></span>

<span data-ttu-id="1bd29-157">**Tailspin.SurveyManagementService** 是一个无状态服务，用于存储和检索调查表与调查表的问题。</span><span class="sxs-lookup"><span data-stu-id="1bd29-157">**Tailspin.SurveyManagementService** is a stateless service that stores and retrieves surveys and survey questions.</span></span> <span data-ttu-id="1bd29-158">服务使用 Azure Blob 存储。</span><span class="sxs-lookup"><span data-stu-id="1bd29-158">The service uses Azure Blob storage.</span></span> <span data-ttu-id="1bd29-159">此功能最初也在移植的 Service Fabric 应用程序中的 *Tailspin.Web* 和 *Tailspin.Web.Survey.Public* 服务的数据访问组件中实现。</span><span class="sxs-lookup"><span data-stu-id="1bd29-159">This functionality was also originally implemented in the data access components of the *Tailspin.Web* and *Tailspin.Web.Survey.Public* services in the ported Service Fabric application.</span></span> <span data-ttu-id="1bd29-160">Tailspin 将原始功能重构为此服务，使其能够独立缩放。</span><span class="sxs-lookup"><span data-stu-id="1bd29-160">Tailspin refactored the original functionality into this service to allow it to scale independently.</span></span>

<span data-ttu-id="1bd29-161">**Tailspin.SurveyAnswerService** 是一个无状态服务，用于检索调查表答案和调查表分析。</span><span class="sxs-lookup"><span data-stu-id="1bd29-161">**Tailspin.SurveyAnswerService** is a stateless service that retrieves survey answers and survey analysis.</span></span> <span data-ttu-id="1bd29-162">该服务也使用 Azure Blob 存储。</span><span class="sxs-lookup"><span data-stu-id="1bd29-162">The service also uses Azure Blob storage.</span></span> <span data-ttu-id="1bd29-163">此功能最初也在移植的 Service Fabric 应用程序中的 *Tailspin.Web* 服务的数据访问组件中实现。</span><span class="sxs-lookup"><span data-stu-id="1bd29-163">This functionality was also originally implemented in the data access components of the *Tailspin.Web* service in the ported Service Fabric application.</span></span> <span data-ttu-id="1bd29-164">Tailspin 将原始功能重构为此服务，因为它预期负载更小，因此希望使用更少的实例以节省资源。</span><span class="sxs-lookup"><span data-stu-id="1bd29-164">Tailspin refactored the original functionality into this service because it expects less load and wants to use fewer instances to conserve resources.</span></span>

<span data-ttu-id="1bd29-165">**Tailspin.SurveyAnalysisService** 是一个无状态服务，用于在 Redis 缓存中保存调查表答案摘要数据，以提高检索的速度。</span><span class="sxs-lookup"><span data-stu-id="1bd29-165">**Tailspin.SurveyAnalysisService** is a stateless service that persists survey answer summary data in a Redis cache for quick retrieval.</span></span> <span data-ttu-id="1bd29-166">每当回答了某份调查表并将新的调查表答案数据合并到摘要数据中时，*Tailspin.SurveyResponseService* 就会调用此服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-166">This service is called by the *Tailspin.SurveyResponseService* each time a survey is answered and the new survey answer data is merged in the summary data.</span></span> <span data-ttu-id="1bd29-167">此服务包括最初在移植的 Service Fabric 应用程序中的 *Tailspin.AnswerAnalysisService* 服务中实现的功能。</span><span class="sxs-lookup"><span data-stu-id="1bd29-167">This service includes the functionality originally implemented in the *Tailspin.AnswerAnalysisService* service from the ported Service Fabric application.</span></span>

## <a name="stateless-versus-stateful-services"></a><span data-ttu-id="1bd29-168">无状态服务与有状态服务</span><span class="sxs-lookup"><span data-stu-id="1bd29-168">Stateless versus stateful services</span></span>

<span data-ttu-id="1bd29-169">Azure Service Fabric 支持以下编程模型：</span><span class="sxs-lookup"><span data-stu-id="1bd29-169">Azure Service Fabric supports the following programming models:</span></span>
* <span data-ttu-id="1bd29-170">来宾可执行文件模式允许将任何可执行文件打包成服务并将其部署到 Service Fabric 群集。</span><span class="sxs-lookup"><span data-stu-id="1bd29-170">The guest executable model allows any executable to be packaged as a service and deployed to a Service Fabric cluster.</span></span> <span data-ttu-id="1bd29-171">Service Fabric 协调和管理来宾可执行文件的执行。</span><span class="sxs-lookup"><span data-stu-id="1bd29-171">Service Fabric orchestrates and manages execution of the guest executable.</span></span>
* <span data-ttu-id="1bd29-172">容器模型允许在容器映像中部署服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-172">The container model allows for deployment of services in container images.</span></span> <span data-ttu-id="1bd29-173">Service Fabric 支持在 Linux 内核容器和 Windows Server 容器的基础上创建和管理容器。</span><span class="sxs-lookup"><span data-stu-id="1bd29-173">Service Fabric supports creation and management of containers on top of Linux kernel containers as well as Windows Server containers.</span></span> 
* <span data-ttu-id="1bd29-174">Reliable Services 编程模型允许创建可与所有 Service Fabric 平台功能集成的无状态服务或有状态服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-174">The reliable services programming model allows for the creation of stateless or stateful services that integrate with all Service Fabric platform features.</span></span> <span data-ttu-id="1bd29-175">有状态服务允许将复制状态存储在 Service Fabric 群集中，</span><span class="sxs-lookup"><span data-stu-id="1bd29-175">Stateful services allow for replicated state to be stored in the Service Fabric cluster.</span></span> <span data-ttu-id="1bd29-176">而无状态服务则不允许。</span><span class="sxs-lookup"><span data-stu-id="1bd29-176">Stateless services do not.</span></span>
* <span data-ttu-id="1bd29-177">Reliable Actors 编程模型允许创建可实现虚拟执行组件模式的服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-177">The reliable actors programming model allows for the creation of services that implement the virtual actor pattern.</span></span>

<span data-ttu-id="1bd29-178">在 Surveys 应用程序中，除 *Tailspin.SurveyResponseService* 服务以外，其他所有服务都是无状态的 Reliable Services。</span><span class="sxs-lookup"><span data-stu-id="1bd29-178">All the services in the Surveys application are stateless reliable services, except for the *Tailspin.SurveyResponseService* service.</span></span> <span data-ttu-id="1bd29-179">此服务实现 [ReliableConcurrentQueue][reliable-concurrent-queue] 来处理收到的调查表答案。</span><span class="sxs-lookup"><span data-stu-id="1bd29-179">This service implements a [ReliableConcurrentQueue][reliable-concurrent-queue] to process survey answers when they are received.</span></span> <span data-ttu-id="1bd29-180">ReliableConcurrentQueue 中的响应保存到 Azure Blob 存储，并传递给 *Tailspin.SurveyAnalysisService* 进行分析。</span><span class="sxs-lookup"><span data-stu-id="1bd29-180">Responses in the ReliableConcurrentQueue are saved into Azure Blob Storage and passed to the *Tailspin.SurveyAnalysisService* for analysis.</span></span> <span data-ttu-id="1bd29-181">Tailspin 之所以选择 ReliableConcurrentQueue，是因为响应不需要遵循队列（例如 Azure 服务总线）提供的严格先进先出 (FIFO) 排序规则。</span><span class="sxs-lookup"><span data-stu-id="1bd29-181">Tailspin chooses a ReliableConcurrentQueue because responses do not require strict first-in-first-out (FIFO) ordering provided by a queue such as Azure Service Bus.</span></span> <span data-ttu-id="1bd29-182">ReliableConcurrentQueue 在设计上还能提供高吞吐量和低延迟来执行排队与取消排队操作。</span><span class="sxs-lookup"><span data-stu-id="1bd29-182">A ReliableConcurrentQueue is also designed to deliver high throughput and low latency for queue and dequeue operations.</span></span>

<span data-ttu-id="1bd29-183">请注意，保存已在 ReliableConcurrentQueue 中取消排队的项的操作最好是幂等的。</span><span class="sxs-lookup"><span data-stu-id="1bd29-183">Note that operations to persist dequeued items from a ReliableConcurrentQueue should ideally be idempotent.</span></span> <span data-ttu-id="1bd29-184">如果在处理队列中的某个项期间引发了异常，可以多次处理同一个项。</span><span class="sxs-lookup"><span data-stu-id="1bd29-184">If an exception is thrown during the processing of an item from the queue, the same item may be processed more than once.</span></span> <span data-ttu-id="1bd29-185">在 Surveys 应用程序中，将调查表答案合并到 *Tailspin.SurveyAnalysisService* 的操作不是幂等的，因为 Tailspin 判定调查表分析数据只是当前分析数据的快照，而不需要保持一致。</span><span class="sxs-lookup"><span data-stu-id="1bd29-185">In the Surveys application, the operation to merge survey answers to the *Tailspin.SurveyAnalysisService* is not idempotent because Tailspin decided that the survey analysis data is only a current snapshot of the analysis data and does not need to be consistent.</span></span> <span data-ttu-id="1bd29-186">保存到 Azure Blob 存储的调查表答案最终是一致的，因此，始终能够基于这些数据正确地重新计算调查表最终分析结果。</span><span class="sxs-lookup"><span data-stu-id="1bd29-186">The survey answers saved to Azure Blob Storage are eventually consistent, so the survey final analysis can always be recalculated correctly from this data.</span></span>

## <a name="communication-framework"></a><span data-ttu-id="1bd29-187">通信框架</span><span class="sxs-lookup"><span data-stu-id="1bd29-187">Communication framework</span></span>

<span data-ttu-id="1bd29-188">Surveys 应用程序中的每个服务使用 RESTful Web API 通信。</span><span class="sxs-lookup"><span data-stu-id="1bd29-188">Each service in the Surveys application communicates using a RESTful web API.</span></span> <span data-ttu-id="1bd29-189">RESTful API 提供以下优势：</span><span class="sxs-lookup"><span data-stu-id="1bd29-189">RESTful APIs offer the following benefits:</span></span>
* <span data-ttu-id="1bd29-190">易用性：使用原生支持创建 Web API 的 ASP.NET Core MVC 生成每个服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-190">Ease of use: each service is built using ASP.NET Core MVC, which natively supports the creation of Web APIs.</span></span>
* <span data-ttu-id="1bd29-191">安全性：尽管每个服务不需要 SSL，但 Tailspin 可能会要求每个服务使用 SSL。</span><span class="sxs-lookup"><span data-stu-id="1bd29-191">Security: While each service does not require SSL, Tailspin could require each service to do so.</span></span> 
* <span data-ttu-id="1bd29-192">版本控制：可以针对特定版本的 Web API 编写和测试客户端。</span><span class="sxs-lookup"><span data-stu-id="1bd29-192">Versioning: clients can be written and tested against a specific version of a web API.</span></span>

<span data-ttu-id="1bd29-193">Surveys 应用程序中的服务利用 Service Fabric 实现的[反向代理][reverse-proxy]。</span><span class="sxs-lookup"><span data-stu-id="1bd29-193">Services in the Survey application make use of the [reverse proxy][reverse-proxy] implemented by Service Fabric.</span></span> <span data-ttu-id="1bd29-194">反向代理是在 Service Fabric 群集中每个节点上运行的服务，可以提供终结点解析、自动重试和处理其他类型的连接故障。</span><span class="sxs-lookup"><span data-stu-id="1bd29-194">Reverse proxy is a service that runs on each node in the Service Fabric cluster and provides endpoint resolution, automatic retry, and handles other types of connection failures.</span></span> <span data-ttu-id="1bd29-195">若要使用反向代理，可以使用预定义的反向代理端口对特定的服务发出每个 RESTful API 调用。</span><span class="sxs-lookup"><span data-stu-id="1bd29-195">To use the reverse proxy, each RESTful API call to a specific service is made using a predefined reverse proxy port.</span></span>  <span data-ttu-id="1bd29-196">例如，如果反向代理端口设置为 **19081**，则可按如下所示调用 *Tailspin.SurveyAnswerService*：</span><span class="sxs-lookup"><span data-stu-id="1bd29-196">For example, if the reverse proxy port has been set to **19081**, a call to the *Tailspin.SurveyAnswerService* can be made as follows:</span></span>

```csharp
static SurveyAnswerService()
{
    httpClient = new HttpClient
    {
        BaseAddress = new Uri("http://localhost:19081/Tailspin/SurveyAnswerService/")
    };
}
```
<span data-ttu-id="1bd29-197">若要启用反向代理，请在创建 Service Fabric 群集期间指定反向代理端口。</span><span class="sxs-lookup"><span data-stu-id="1bd29-197">To enable reverse proxy, specify a reverse proxy port during creation of the Service Fabric cluster.</span></span> <span data-ttu-id="1bd29-198">有关详细信息，请参阅 Azure Service Fabric 中的[反向代理][reverse-proxy]。</span><span class="sxs-lookup"><span data-stu-id="1bd29-198">For more information, see [reverse proxy][reverse-proxy] in Azure Service Fabric.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="1bd29-199">性能注意事项</span><span class="sxs-lookup"><span data-stu-id="1bd29-199">Performance considerations</span></span>

<span data-ttu-id="1bd29-200">Tailspin 使用 Visual Studio 模板为 *Tailspin.Web* 和 *Tailspin.Web.Surveys.Public* 创建了 ASP.NET Core 服务。</span><span class="sxs-lookup"><span data-stu-id="1bd29-200">Tailspin created the ASP.NET Core services for *Tailspin.Web* and *Tailspin.Web.Surveys.Public* using Visual Studio templates.</span></span> <span data-ttu-id="1bd29-201">默认情况下，这些模板会将日志输出到控制台。</span><span class="sxs-lookup"><span data-stu-id="1bd29-201">By default, these templates include logging to the console.</span></span> <span data-ttu-id="1bd29-202">在开发和调试期间，可将日志输出到控制台；但是，在将应用程序部署到生产环境后，应该禁用将所有日志输出到控制台。</span><span class="sxs-lookup"><span data-stu-id="1bd29-202">Logging to the console may be done during development and debugging, but all logging to the console should be removed when the application is deployed to production.</span></span>

> [!NOTE]
> <span data-ttu-id="1bd29-203">有关对生产环境中运行的 Service Fabric 应用程序设置监视和诊断的详细信息，请参阅 Azure Service Fabric 的[监视和诊断][monitoring-diagnostics]。</span><span class="sxs-lookup"><span data-stu-id="1bd29-203">For more information about setting up monitoring and diagnostics for Service Fabric applications running in production, see [monitoring and diagnostics][monitoring-diagnostics] for Azure Service Fabric.</span></span>

<span data-ttu-id="1bd29-204">例如，应该在 *startup.cs* 中注释掉与每个 Web 前端服务对应的以下行：</span><span class="sxs-lookup"><span data-stu-id="1bd29-204">For example, the following lines in *startup.cs* for each of the web front end services should be commented out:</span></span>

```csharp
// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
    //loggerFactory.AddConsole(Configuration.GetSection("Logging"));
    //loggerFactory.AddDebug();

    app.UseMvc();
}
```

> [!NOTE]
> <span data-ttu-id="1bd29-205">将 Visual Studio 设置为“release”（发布）时，可以根据条件排除这些行。</span><span class="sxs-lookup"><span data-stu-id="1bd29-205">These lines may be conditionally excluded when Visual Studio is set to “release” when publishing.</span></span>

<span data-ttu-id="1bd29-206">最后，当 Tailspin 在生产环境中部署 Tailspin 应用程序时，会将 Visual Studio 切换到 **release** 模式。</span><span class="sxs-lookup"><span data-stu-id="1bd29-206">Finally, when Tailspin deploys the Tailspin application to production, they switch Visual Studio to **release** mode.</span></span>

## <a name="deployment-considerations"></a><span data-ttu-id="1bd29-207">部署注意事项</span><span class="sxs-lookup"><span data-stu-id="1bd29-207">Deployment considerations</span></span>

<span data-ttu-id="1bd29-208">重构的 Surveys 应用程序由五个无状态服务和一个有状态服务构成，因此，群集规划仅限于确定正确的 VM 大小和节点数。</span><span class="sxs-lookup"><span data-stu-id="1bd29-208">The refactored Surveys application is composed of five stateless services and one stateful service, so cluster planning is limited to determining the correct VM size and number of nodes.</span></span> <span data-ttu-id="1bd29-209">在描述群集的 *applicationmanifest.xml* 文件中，Tailspin 将每个服务的 *StatelessService* 标记的 *InstanceCount* 属性设置为 -1。</span><span class="sxs-lookup"><span data-stu-id="1bd29-209">In the *applicationmanifest.xml* file that describes the cluster, Tailspin sets the *InstanceCount* attribute of the *StatelessService* tag to -1 for each of the services.</span></span> <span data-ttu-id="1bd29-210">值 -1 指示 Service Fabric 在群集中的每个节点上创建一个服务实例。</span><span class="sxs-lookup"><span data-stu-id="1bd29-210">A value of -1 directs Service Fabric to create an instance of the service on each node in the cluster.</span></span>

> [!NOTE]
> <span data-ttu-id="1bd29-211">有状态服务要求执行额外的步骤来规划正确的分区数和分区的数据副本数。</span><span class="sxs-lookup"><span data-stu-id="1bd29-211">Stateful services require the additional step of planning the correct number of partitions and replicas for their data.</span></span>

<span data-ttu-id="1bd29-212">Tailspin 使用 Azure 门户部署群集。</span><span class="sxs-lookup"><span data-stu-id="1bd29-212">Tailspin deploys the cluster using the Azure Portal.</span></span> <span data-ttu-id="1bd29-213">Service Fabric 群集资源类型部署所有必要的基础结构，包括 VM 规模集和负载均衡器。</span><span class="sxs-lookup"><span data-stu-id="1bd29-213">The Service Fabric Cluster resource type deploys all of the necessary infrastructure, including VM scale sets and a load balancer.</span></span> <span data-ttu-id="1bd29-214">在 Service Fabric 群集的预配过程中，建议的 VM 大小会显示在 Azure 门户中。</span><span class="sxs-lookup"><span data-stu-id="1bd29-214">The recommended VM sizes are displayed in the Azure portal during the provisioning process for the Service Fabric cluster.</span></span> <span data-ttu-id="1bd29-215">请注意，由于 VM 部署在 VM 规模集中，因此，当用户负载增大时，这些 VM 既可纵向扩展，也可横向扩展。</span><span class="sxs-lookup"><span data-stu-id="1bd29-215">Note that because the VMs are deployed in a VM scale set, they can be both scaled up and out as user load increases.</span></span>

> [!NOTE]
> <span data-ttu-id="1bd29-216">如前所述，在迁移版本的 Surveys 应用程序中，两个 Web 前端使用 ASP.NET Core 和充当 Web 服务器的 Kestrel 自我托管。</span><span class="sxs-lookup"><span data-stu-id="1bd29-216">As discussed earlier, in the migrated version of the Surveys application the two web front ends were self-hosted using ASP.NET Core and Kestrel as a web server.</span></span> <span data-ttu-id="1bd29-217">尽管迁移版本的 Surveys 应用程序不使用反向代理，但我们强烈建议使用 IIS、Nginx 或 Apache 等反向代理。</span><span class="sxs-lookup"><span data-stu-id="1bd29-217">While the migrated version of the Survey application does not use a reverse proxy, it is strongly recommended to use a reverse proxy such as IIS, Nginx, or Apache.</span></span> <span data-ttu-id="1bd29-218">有关详细信息，请参阅 [ASP.NET Core 中的 Kestrel Web 服务器实现简介][kestrel-intro]。</span><span class="sxs-lookup"><span data-stu-id="1bd29-218">For more information see [introduction to Kestrel web server implementation in ASP.NET core][kestrel-intro].</span></span>
> <span data-ttu-id="1bd29-219">在重构的 Surveys 应用程序中，两个 Web 前端使用 ASP.NET Core 和充当 Web 服务器的 [WebListener][weblistener] 自我托管，因此不需要反向代理。</span><span class="sxs-lookup"><span data-stu-id="1bd29-219">In the refactored Surveys application, the two web front ends are self-hosted using ASP.NET Core with [WebListener][weblistener] as a web server so a reverse proxy is not necessary.</span></span>

## <a name="next-steps"></a><span data-ttu-id="1bd29-220">后续步骤</span><span class="sxs-lookup"><span data-stu-id="1bd29-220">Next steps</span></span>

<span data-ttu-id="1bd29-221">[GitHub][sample-code] 上提供了 Surveys 应用程序代码。</span><span class="sxs-lookup"><span data-stu-id="1bd29-221">The Surveys application code is available on [GitHub][sample-code].</span></span>

<span data-ttu-id="1bd29-222">如果你使用 [Azure Service Fabric][service-fabric] 不久，请先设置开发环境，然后下载最新的 [Azure SDK][azure-sdk] 和 [Azure Service Fabric SDK][service-fabric-sdk]。</span><span class="sxs-lookup"><span data-stu-id="1bd29-222">If you are just getting started with [Azure Service Fabric][service-fabric], first set up your development environment then download the latest [Azure SDK][azure-sdk] and the [Azure Service Fabric SDK][service-fabric-sdk].</span></span> <span data-ttu-id="1bd29-223">SDK 包含 OneBox 群集管理器，用于在本地部署和测试 Surveys 应用程序，并完全支持 F5 调试。</span><span class="sxs-lookup"><span data-stu-id="1bd29-223">The SDK includes the OneBox cluster manager so you can deploy and test the Surveys application locally with full F5 debugging.</span></span>

<!-- links -->
[azure-sdk]: https://azure.microsoft.com/downloads/archive-net-downloads/
[container-scenarios]: /azure/service-fabric/service-fabric-containers-overview
[kestrel]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore2x
[kestrel-intro]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore1x
[migrate-from-cloud-services]: migrate-from-cloud-services.md
[monitoring-diagnostics]: /azure/service-fabric/service-fabric-diagnostics-overview
[reliable-concurrent-queue]: /azure/service-fabric/service-fabric-reliable-services-reliable-concurrent-queue
[reverse-proxy]: /azure/service-fabric/service-fabric-reverseproxy
[sample-code]: https://github.com/mspnp/cloud-services-to-service-fabric/tree/master/servicefabric-phase-2
[service-fabric]: /azure/service-fabric/service-fabric-get-started
[service-fabric-sdk]: /azure/service-fabric/service-fabric-get-started
[weblistener]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/weblistener
