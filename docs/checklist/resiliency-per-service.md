---
title: Azure 服务的复原能力检查表
titleSuffix: Azure Design Review Framework
description: 一个检查表，提供各种 Azure 服务的复原能力指南。
author: petertaylor9999
ms.date: 11/26/2018
ms.topic: checklist
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: resiliency, checklist
ms.openlocfilehash: fbb7501a663c8b5e326b2b601685419c8e5a0806
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/23/2019
ms.locfileid: "54486907"
---
# <a name="resiliency-checklist-for-specific-azure-services"></a><span data-ttu-id="c7246-103">特定 Azure 服务的复原能力检查表</span><span class="sxs-lookup"><span data-stu-id="c7246-103">Resiliency checklist for specific Azure services</span></span>

<span data-ttu-id="c7246-104">复原能力是指系统能够在发生故障后进行恢复，然后继续正常运行，它是[软件质量的构成要素](../guide/pillars.md)之一。</span><span class="sxs-lookup"><span data-stu-id="c7246-104">Resiliency is the ability of a system to recover from failures and continue to function, and is one of the [pillars of software quality](../guide/pillars.md).</span></span> <span data-ttu-id="c7246-105">每项技术都有自己的特定故障模式，这是在设计和实现应用程序时必须考虑的。</span><span class="sxs-lookup"><span data-stu-id="c7246-105">Every technology has its own particular failure modes, which you must consider when designing and implementing your application.</span></span> <span data-ttu-id="c7246-106">请使用此检查表查看特定 Azure 服务的复原能力注意事项。</span><span class="sxs-lookup"><span data-stu-id="c7246-106">Use this checklist to review the resiliency considerations for specific Azure services.</span></span> <span data-ttu-id="c7246-107">另请查看[常规复原能力检查表](./resiliency.md)。</span><span class="sxs-lookup"><span data-stu-id="c7246-107">Also review the [general resiliency checklist](./resiliency.md).</span></span>

## <a name="app-service"></a><span data-ttu-id="c7246-108">应用服务</span><span class="sxs-lookup"><span data-stu-id="c7246-108">App Service</span></span>

<span data-ttu-id="c7246-109">**使用“标准”或“高级”层。**</span><span class="sxs-lookup"><span data-stu-id="c7246-109">**Use Standard or Premium tier.**</span></span> <span data-ttu-id="c7246-110">这些层支持过渡槽位和自动备份。</span><span class="sxs-lookup"><span data-stu-id="c7246-110">These tiers support staging slots and automated backups.</span></span> <span data-ttu-id="c7246-111">有关详细信息，请参阅 [Azure 应用服务计划深入概述](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)</span><span class="sxs-lookup"><span data-stu-id="c7246-111">For more information, see [Azure App Service plans in-depth overview](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)</span></span>

<span data-ttu-id="c7246-112">**避免纵向扩展或缩减。**</span><span class="sxs-lookup"><span data-stu-id="c7246-112">**Avoid scaling up or down.**</span></span> <span data-ttu-id="c7246-113">应选择满足典型负载下的性能要求的层和实例大小，然后[横向扩展](/azure/app-service-web/web-sites-scale/)实例来处理流量的更改。</span><span class="sxs-lookup"><span data-stu-id="c7246-113">Instead, select a tier and instance size that meet your performance requirements under typical load, and then [scale out](/azure/app-service-web/web-sites-scale/) the instances to handle changes in traffic volume.</span></span> <span data-ttu-id="c7246-114">纵向扩展或缩减可能触发应用程序重启。</span><span class="sxs-lookup"><span data-stu-id="c7246-114">Scaling up and down may trigger an application restart.</span></span>

<span data-ttu-id="c7246-115">**将配置存储为应用设置。**</span><span class="sxs-lookup"><span data-stu-id="c7246-115">**Store configuration as app settings.**</span></span> <span data-ttu-id="c7246-116">使用应用设置将配置设置保存为应用设置。</span><span class="sxs-lookup"><span data-stu-id="c7246-116">Use app settings to hold configuration settings as app settings.</span></span> <span data-ttu-id="c7246-117">在资源管理器模板中或使用 PowerShell 定义设置，以便可以在更可靠的自动部署/更新过程中应用这些设置。</span><span class="sxs-lookup"><span data-stu-id="c7246-117">Define the settings in your Resource Manager templates, or using PowerShell, so that you can apply them as part of an automated deployment / update process, which is more reliable.</span></span> <span data-ttu-id="c7246-118">有关详细信息，请参阅[在 Azure 应用服务中配置 Web 应用](/azure/app-service-web/web-sites-configure/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-118">For more information, see [Configure web apps in Azure App Service](/azure/app-service-web/web-sites-configure/).</span></span>

<span data-ttu-id="c7246-119">**为生产和测试创建单独的应用服务计划。**</span><span class="sxs-lookup"><span data-stu-id="c7246-119">**Create separate App Service plans for production and test.**</span></span> <span data-ttu-id="c7246-120">不要使用生产部署中的槽位进行测试。</span><span class="sxs-lookup"><span data-stu-id="c7246-120">Don't use slots on your production deployment for testing.</span></span>  <span data-ttu-id="c7246-121">同一应用服务计划中的所有应用共享相同的 VM 实例。</span><span class="sxs-lookup"><span data-stu-id="c7246-121">All apps within the same App Service plan share the same VM instances.</span></span> <span data-ttu-id="c7246-122">如果将生产和测试部署放在同一个计划中，可能会对生产部署产生负面影响。</span><span class="sxs-lookup"><span data-stu-id="c7246-122">If you put production and test deployments in the same plan, it can negatively affect the production deployment.</span></span> <span data-ttu-id="c7246-123">例如，负载测试可能使实时生产站点降级。</span><span class="sxs-lookup"><span data-stu-id="c7246-123">For example, load tests might degrade the live production site.</span></span> <span data-ttu-id="c7246-124">如果将测试部署放入单独的计划，则可将其与生产版本相隔离。</span><span class="sxs-lookup"><span data-stu-id="c7246-124">By putting test deployments into a separate plan, you isolate them from the production version.</span></span>

<span data-ttu-id="c7246-125">**将 Web 应用与 Web API 相区分。**</span><span class="sxs-lookup"><span data-stu-id="c7246-125">**Separate web apps from web APIs.**</span></span> <span data-ttu-id="c7246-126">如果解决方案包含 Web 前端和 Web API，请考虑将它们分解为单独的应用服务应用。</span><span class="sxs-lookup"><span data-stu-id="c7246-126">If your solution has both a web front-end and a web API, consider decomposing them into separate App Service apps.</span></span> <span data-ttu-id="c7246-127">使用这种设计可以更方便地按工作负荷分解解决方案。</span><span class="sxs-lookup"><span data-stu-id="c7246-127">This design makes it easier to decompose the solution by workload.</span></span> <span data-ttu-id="c7246-128">可以在单独的应用服务计划中运行 Web 应用和 API，以便对它们进行单独缩放。</span><span class="sxs-lookup"><span data-stu-id="c7246-128">You can run the web app and the API in separate App Service plans, so they can be scaled independently.</span></span> <span data-ttu-id="c7246-129">如果一开始不需要该级别的可伸缩性，可以先将应用部署到同一计划中，以后再根据需要将其移至独立的计划中。</span><span class="sxs-lookup"><span data-stu-id="c7246-129">If you don't need that level of scalability at first, you can deploy the apps into the same plan, and move them into separate plans later, if needed.</span></span>

<span data-ttu-id="c7246-130">**避免使用应用服务备份功能来备份 Azure SQL 数据库。**</span><span class="sxs-lookup"><span data-stu-id="c7246-130">**Avoid using the App Service backup feature to back up Azure SQL databases.**</span></span> <span data-ttu-id="c7246-131">应该使用 [SQL 数据库自动备份][sql-backup]。</span><span class="sxs-lookup"><span data-stu-id="c7246-131">Instead, use [SQL Database automated backups][sql-backup].</span></span> <span data-ttu-id="c7246-132">应用服务备份会将数据库导出到 SQL .bacpac 文件，这会消耗 DTU。</span><span class="sxs-lookup"><span data-stu-id="c7246-132">App Service backup exports the database to a SQL .bacpac file, which costs DTUs.</span></span>

<span data-ttu-id="c7246-133">**部署到过渡槽位。**</span><span class="sxs-lookup"><span data-stu-id="c7246-133">**Deploy to a staging slot.**</span></span> <span data-ttu-id="c7246-134">创建部署槽位用于过渡。</span><span class="sxs-lookup"><span data-stu-id="c7246-134">Create a deployment slot for staging.</span></span> <span data-ttu-id="c7246-135">将应用程序更新部署到过渡槽位，并在交换到生产环境之前验证部署。</span><span class="sxs-lookup"><span data-stu-id="c7246-135">Deploy application updates to the staging slot, and verify the deployment before swapping it into production.</span></span> <span data-ttu-id="c7246-136">这可以减少生产环境中出现更新不当的可能性。</span><span class="sxs-lookup"><span data-stu-id="c7246-136">This reduces the chance of a bad update in production.</span></span> <span data-ttu-id="c7246-137">此外，可确保所有实例在交换到生产环境之前已预热。</span><span class="sxs-lookup"><span data-stu-id="c7246-137">It also ensures that all instances are warmed up before being swapped into production.</span></span> <span data-ttu-id="c7246-138">许多应用程序的预热和冷启动时间很长。</span><span class="sxs-lookup"><span data-stu-id="c7246-138">Many applications have a significant warmup and cold-start time.</span></span> <span data-ttu-id="c7246-139">有关详细信息，请参阅[为 Azure 应用服务中的 Web 应用设置过渡环境](/azure/app-service-web/web-sites-staged-publishing/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-139">For more information, see [Set up staging environments for web apps in Azure App Service](/azure/app-service-web/web-sites-staged-publishing/).</span></span>

<span data-ttu-id="c7246-140">**创建一个部署槽位用于保存上次已知正常 (LKG) 的部署。**</span><span class="sxs-lookup"><span data-stu-id="c7246-140">**Create a deployment slot to hold the last-known-good (LKG) deployment.**</span></span> <span data-ttu-id="c7246-141">将更新部署到生产环境时，请将前一个生产部署移到 LKG 槽位中。</span><span class="sxs-lookup"><span data-stu-id="c7246-141">When you deploy an update to production, move the previous production deployment into the LKG slot.</span></span> <span data-ttu-id="c7246-142">这可以更方便地回滚错误部署。</span><span class="sxs-lookup"><span data-stu-id="c7246-142">This makes it easier to roll back a bad deployment.</span></span> <span data-ttu-id="c7246-143">如果以后发现问题，可以快速还原到 LKG 版本。</span><span class="sxs-lookup"><span data-stu-id="c7246-143">If you discover a problem later, you can quickly revert to the LKG version.</span></span> <span data-ttu-id="c7246-144">有关详细信息，请参阅[基本 Web 应用程序](../reference-architectures/app-service-web-app/basic-web-app.md)。</span><span class="sxs-lookup"><span data-stu-id="c7246-144">For more information, see [Basic web application](../reference-architectures/app-service-web-app/basic-web-app.md).</span></span>

<span data-ttu-id="c7246-145">**启用诊断日志记录**，包括应用程序日志记录和 Web 服务器日志记录。</span><span class="sxs-lookup"><span data-stu-id="c7246-145">**Enable diagnostics logging**, including application logging and web server logging.</span></span> <span data-ttu-id="c7246-146">日志记录对于监视和诊断很重要。</span><span class="sxs-lookup"><span data-stu-id="c7246-146">Logging is important for monitoring and diagnostics.</span></span> <span data-ttu-id="c7246-147">请参阅[在 Azure 应用服务中为 Web 应用启用诊断日志记录](/azure/app-service-web/web-sites-enable-diagnostic-log/)</span><span class="sxs-lookup"><span data-stu-id="c7246-147">See [Enable diagnostics logging for web apps in Azure App Service](/azure/app-service-web/web-sites-enable-diagnostic-log/)</span></span>

<span data-ttu-id="c7246-148">**记录 Blob 存储的日志。**</span><span class="sxs-lookup"><span data-stu-id="c7246-148">**Log to blob storage.**</span></span> <span data-ttu-id="c7246-149">这可以更方便地收集和分析数据。</span><span class="sxs-lookup"><span data-stu-id="c7246-149">This makes it easier to collect and analyze the data.</span></span>

<span data-ttu-id="c7246-150">**为日志创建单独的存储帐户。**</span><span class="sxs-lookup"><span data-stu-id="c7246-150">**Create a separate storage account for logs.**</span></span> <span data-ttu-id="c7246-151">不要对日志和应用程序数据使用相同的存储帐户。</span><span class="sxs-lookup"><span data-stu-id="c7246-151">Don't use the same storage account for logs and application data.</span></span> <span data-ttu-id="c7246-152">这有助于防止日志记录降低应用程序的性能。</span><span class="sxs-lookup"><span data-stu-id="c7246-152">This helps to prevent logging from reducing application performance.</span></span>

<span data-ttu-id="c7246-153">**监视性能。**</span><span class="sxs-lookup"><span data-stu-id="c7246-153">**Monitor performance.**</span></span> <span data-ttu-id="c7246-154">使用 [New Relic](https://newrelic.com/) 或 [Application Insights](/azure/application-insights/app-insights-overview/) 等性能监视服务来监视承受负载时的应用程序性能和行为。</span><span class="sxs-lookup"><span data-stu-id="c7246-154">Use a performance monitoring service such as [New Relic](https://newrelic.com/) or [Application Insights](/azure/application-insights/app-insights-overview/) to monitor application performance and behavior under load.</span></span>  <span data-ttu-id="c7246-155">性能监视提供应用程序的实时深入信息。</span><span class="sxs-lookup"><span data-stu-id="c7246-155">Performance monitoring gives you real-time insight into the application.</span></span> <span data-ttu-id="c7246-156">可以使用它来诊断问题，以及执行故障根本原因分析。</span><span class="sxs-lookup"><span data-stu-id="c7246-156">It enables you to diagnose issues and perform root-cause analysis of failures.</span></span>

## <a name="application-gateway"></a><span data-ttu-id="c7246-157">应用程序网关</span><span class="sxs-lookup"><span data-stu-id="c7246-157">Application Gateway</span></span>

<span data-ttu-id="c7246-158">**至少预配两个实例。**</span><span class="sxs-lookup"><span data-stu-id="c7246-158">**Provision at least two instances.**</span></span> <span data-ttu-id="c7246-159">部署至少包含两个实例的应用程序网关。</span><span class="sxs-lookup"><span data-stu-id="c7246-159">Deploy Application Gateway with at least two instances.</span></span> <span data-ttu-id="c7246-160">单个实例会成为单一故障点。</span><span class="sxs-lookup"><span data-stu-id="c7246-160">A single instance is a single point of failure.</span></span> <span data-ttu-id="c7246-161">使用两个或更多个实例实现冗余和可伸缩性。</span><span class="sxs-lookup"><span data-stu-id="c7246-161">Use two or more instances for redundancy and scalability.</span></span> <span data-ttu-id="c7246-162">若要满足 [SLA](https://azure.microsoft.com/support/legal/sla/application-gateway)，必须预配两个或更多个中型或大型实例。</span><span class="sxs-lookup"><span data-stu-id="c7246-162">In order to qualify for the [SLA](https://azure.microsoft.com/support/legal/sla/application-gateway), you must provision two or more medium or larger instances.</span></span>

## <a name="cosmos-db"></a><span data-ttu-id="c7246-163">Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="c7246-163">Cosmos DB</span></span>

<span data-ttu-id="c7246-164">**跨区域复制数据库。**</span><span class="sxs-lookup"><span data-stu-id="c7246-164">**Replicate the database across regions.**</span></span> <span data-ttu-id="c7246-165">Cosmos DB 允许将任意数量的 Azure 区域与 Cosmos DB 数据库帐户关联。</span><span class="sxs-lookup"><span data-stu-id="c7246-165">Cosmos DB allows you to associate any number of Azure regions with a Cosmos DB database account.</span></span> <span data-ttu-id="c7246-166">Cosmos DB 数据库可以包含一个写入区域和多个读取区域。</span><span class="sxs-lookup"><span data-stu-id="c7246-166">A Cosmos DB database can have one write region and multiple read regions.</span></span> <span data-ttu-id="c7246-167">如果写入区域发生故障，可以从另一个副本读取。</span><span class="sxs-lookup"><span data-stu-id="c7246-167">If there is a failure in the write region, you can read from another replica.</span></span> <span data-ttu-id="c7246-168">客户端 SDK 会自动处理此操作。</span><span class="sxs-lookup"><span data-stu-id="c7246-168">The Client SDK handles this automatically.</span></span> <span data-ttu-id="c7246-169">还可以将写入区域故障转移到另一个区域。</span><span class="sxs-lookup"><span data-stu-id="c7246-169">You can also fail over the write region to another region.</span></span> <span data-ttu-id="c7246-170">有关详细信息，请参阅[如何使用 Azure Cosmos DB 进行全局数据分配](/azure/cosmos-db/distribute-data-globally)。</span><span class="sxs-lookup"><span data-stu-id="c7246-170">For more information, see [How to distribute data globally with Azure Cosmos DB](/azure/cosmos-db/distribute-data-globally).</span></span>

## <a name="event-hubs"></a><span data-ttu-id="c7246-171">事件中心</span><span class="sxs-lookup"><span data-stu-id="c7246-171">Event Hubs</span></span>

<span data-ttu-id="c7246-172">**使用检查点**。</span><span class="sxs-lookup"><span data-stu-id="c7246-172">**Use checkpoints**.</span></span>  <span data-ttu-id="c7246-173">事件使用者应该根据某种预定义的间隔将其当前位置写入持久性存储。</span><span class="sxs-lookup"><span data-stu-id="c7246-173">An event consumer should write its current position to persistent storage at some predefined interval.</span></span> <span data-ttu-id="c7246-174">这样，如果使用者遇到故障（例如，使用者崩溃，或主机故障），则新实例可以继续从上一个记录的位置读取流。</span><span class="sxs-lookup"><span data-stu-id="c7246-174">That way, if the consumer experiences a fault (for example, the consumer crashes, or the host fails), then a new instance can resume reading the stream from the last recorded position.</span></span> <span data-ttu-id="c7246-175">有关详细信息，请参阅[事件使用者](/azure/event-hubs/event-hubs-features#event-consumers)。</span><span class="sxs-lookup"><span data-stu-id="c7246-175">For more information, see [Event consumers](/azure/event-hubs/event-hubs-features#event-consumers).</span></span>

<span data-ttu-id="c7246-176">**处理重复消息。**</span><span class="sxs-lookup"><span data-stu-id="c7246-176">**Handle duplicate messages.**</span></span> <span data-ttu-id="c7246-177">如果某个事件使用者故障，则会从上一个记录的检查点恢复消息处理。</span><span class="sxs-lookup"><span data-stu-id="c7246-177">If an event consumer fails, message processing is resumed from the last recorded checkpoint.</span></span> <span data-ttu-id="c7246-178">在上一个检查点之后已经处理的任何消息都会重新处理。</span><span class="sxs-lookup"><span data-stu-id="c7246-178">Any messages that were already processed after the last checkpoint will be processed again.</span></span> <span data-ttu-id="c7246-179">因此，消息处理逻辑必须是幂等的，否则应用程序必须能够删除重复消息。</span><span class="sxs-lookup"><span data-stu-id="c7246-179">Therefore, your message processing logic must be idempotent, or the application must be able to deduplicate messages.</span></span>

<span data-ttu-id="c7246-180">**处理异常。**</span><span class="sxs-lookup"><span data-stu-id="c7246-180">**Handle exceptions.**.</span></span> <span data-ttu-id="c7246-181">事件使用者通常以循环的方式处理一批消息。</span><span class="sxs-lookup"><span data-stu-id="c7246-181">An event consumer typically processes a batch of messages in a loop.</span></span> <span data-ttu-id="c7246-182">应该在该处理循环内处理异常，避免在单个消息导致异常的情况下丢失一整批消息。</span><span class="sxs-lookup"><span data-stu-id="c7246-182">You should handle exceptions within this processing loop to avoid losing an entire batch of messages if a single message causes an exception.</span></span>

<span data-ttu-id="c7246-183">**使用死信队列。**</span><span class="sxs-lookup"><span data-stu-id="c7246-183">**Use a dead-letter queue.**</span></span> <span data-ttu-id="c7246-184">如果处理消息时出现非暂时性故障，请将该消息置于死信队列中，以便跟踪状态。</span><span class="sxs-lookup"><span data-stu-id="c7246-184">If processing a message results in a non-transient failure, put the message onto a dead-letter queue, so that you can track the status.</span></span> <span data-ttu-id="c7246-185">可以根据情况在以后重试消息、应用补偿事务，或者执行其他操作。</span><span class="sxs-lookup"><span data-stu-id="c7246-185">Depending on the scenario, you might retry the message later, apply a compensating transaction, or take some other action.</span></span> <span data-ttu-id="c7246-186">请注意，事件中心没有任何内置的死信队列功能。</span><span class="sxs-lookup"><span data-stu-id="c7246-186">Note that Event Hubs does not have any built-in dead-letter queue functionality.</span></span> <span data-ttu-id="c7246-187">可以使用 Azure 队列存储或服务总线来实现死信队列，也可以使用 Azure Functions 或某个其他的事件处理机制。</span><span class="sxs-lookup"><span data-stu-id="c7246-187">You can use Azure Queue Storage or Service Bus to implement a dead-letter queue, or use Azure Functions or some other eventing mechanism.</span></span>

<span data-ttu-id="c7246-188">**通过故障转移到辅助的事件中心命名空间实施灾难恢复。**</span><span class="sxs-lookup"><span data-stu-id="c7246-188">**Implement disaster recovery by failing over to a secondary Event Hubs namespace.**</span></span> <span data-ttu-id="c7246-189">有关详细信息，请参阅 [Azure 事件中心异地灾难恢复](/azure/event-hubs/event-hubs-geo-dr)。</span><span class="sxs-lookup"><span data-stu-id="c7246-189">For more information, see [Azure Event Hubs Geo-disaster recovery](/azure/event-hubs/event-hubs-geo-dr).</span></span>

## <a name="redis-cache"></a><span data-ttu-id="c7246-190">Redis 缓存</span><span class="sxs-lookup"><span data-stu-id="c7246-190">Redis Cache</span></span>

<span data-ttu-id="c7246-191">**配置异地复制**。</span><span class="sxs-lookup"><span data-stu-id="c7246-191">**Configure Geo-replication**.</span></span> <span data-ttu-id="c7246-192">异地复制提供一种用于链接两个高级层 Azure Redis 缓存实例的机制。</span><span class="sxs-lookup"><span data-stu-id="c7246-192">Geo-replication provides a mechanism for linking two Premium tier Azure Redis Cache instances.</span></span> <span data-ttu-id="c7246-193">写入主缓存的数据将复制到辅助只读缓存。</span><span class="sxs-lookup"><span data-stu-id="c7246-193">Data written to the primary cache is replicated to a secondary read-only cache.</span></span> <span data-ttu-id="c7246-194">有关详细信息，请参阅[如何为 Azure Redis 缓存配置异地复制功能](/azure/redis-cache/cache-how-to-geo-replication)</span><span class="sxs-lookup"><span data-stu-id="c7246-194">For more information, see [How to configure Geo-replication for Azure Redis Cache](/azure/redis-cache/cache-how-to-geo-replication)</span></span>

<span data-ttu-id="c7246-195">**配置数据持久性。**</span><span class="sxs-lookup"><span data-stu-id="c7246-195">**Configure data persistence.**</span></span> <span data-ttu-id="c7246-196">使用 Redis 持久性可以在 Redis 中持久存储数据。</span><span class="sxs-lookup"><span data-stu-id="c7246-196">Redis persistence allows you to persist data stored in Redis.</span></span> <span data-ttu-id="c7246-197">还可以获取快照并备份数据，以便在出现硬件故障时进行加载。</span><span class="sxs-lookup"><span data-stu-id="c7246-197">You can also take snapshots and back up the data, which you can load in case of a hardware failure.</span></span> <span data-ttu-id="c7246-198">有关详细信息，请参阅[如何为高级 Azure Redis 缓存配置数据持久性](/azure/redis-cache/cache-how-to-premium-persistence)</span><span class="sxs-lookup"><span data-stu-id="c7246-198">For more information, see [How to configure data persistence for a Premium Azure Redis Cache](/azure/redis-cache/cache-how-to-premium-persistence)</span></span>

<span data-ttu-id="c7246-199">如果将 Redis 缓存使用临时数据缓存而不是持久性存储，则这些建议可能不适用。</span><span class="sxs-lookup"><span data-stu-id="c7246-199">If you are using Redis Cache as a temporary data cache and not as a persistent store, these recommendations may not apply.</span></span>

## <a name="search"></a><span data-ttu-id="c7246-200">搜索</span><span class="sxs-lookup"><span data-stu-id="c7246-200">Search</span></span>

<span data-ttu-id="c7246-201">**预配多个副本。**</span><span class="sxs-lookup"><span data-stu-id="c7246-201">**Provision more than one replica.**</span></span> <span data-ttu-id="c7246-202">至少使用两个副本实现读取高可用性，或至少使用三个副本实现读写高可用性。</span><span class="sxs-lookup"><span data-stu-id="c7246-202">Use at least two replicas for read high-availability, or three for read-write high-availability.</span></span>

<span data-ttu-id="c7246-203">**为多区域部署配置索引器。**</span><span class="sxs-lookup"><span data-stu-id="c7246-203">**Configure indexers for multi-region deployments.**</span></span> <span data-ttu-id="c7246-204">若要进行多区域部署，请考虑使用索引连续性选项。</span><span class="sxs-lookup"><span data-stu-id="c7246-204">If you have a multi-region deployment, consider your options for continuity in indexing.</span></span>

- <span data-ttu-id="c7246-205">如果数据源是异地复制的，通常应该将每个区域性 Azure 搜索服务的每个索引器指向其本地数据源副本。</span><span class="sxs-lookup"><span data-stu-id="c7246-205">If the data source is geo-replicated, you should generally point each indexer of each regional Azure Search service to its local data source replica.</span></span> <span data-ttu-id="c7246-206">但是，对于存储在 Azure SQL 数据库的大型数据集，不建议使用此方法。</span><span class="sxs-lookup"><span data-stu-id="c7246-206">However, that approach is not recommended for large datasets stored in Azure SQL Database.</span></span> <span data-ttu-id="c7246-207">原因在于，Azure 搜索无法从辅助 SQL 数据库副本执行增量索引，而只能从主副本执行。</span><span class="sxs-lookup"><span data-stu-id="c7246-207">The reason is that Azure Search cannot perform incremental indexing from secondary SQL Database replicas, only from primary replicas.</span></span> <span data-ttu-id="c7246-208">应该将所有索引器指向主副本。</span><span class="sxs-lookup"><span data-stu-id="c7246-208">Instead, point all indexers to the primary replica.</span></span> <span data-ttu-id="c7246-209">故障转移后，请将 Azure 搜索索引器指向新的主副本。</span><span class="sxs-lookup"><span data-stu-id="c7246-209">After a failover, point the Azure Search indexers at the new primary replica.</span></span>

- <span data-ttu-id="c7246-210">如果数据源不是异地复制的，请将多个索引器指向同一个数据源，以便多个区域中的 Azure 搜索服务可从数据源连续独立地编制索引。</span><span class="sxs-lookup"><span data-stu-id="c7246-210">If the data source is not geo-replicated, point multiple indexers at the same data source, so that Azure Search services in multiple regions continuously and independently index from the data source.</span></span> <span data-ttu-id="c7246-211">有关详细信息，请参阅 [Azure 搜索性能和优化注意事项][search-optimization]。</span><span class="sxs-lookup"><span data-stu-id="c7246-211">For more information, see [Azure Search performance and optimization considerations][search-optimization].</span></span>

## <a name="service-bus"></a><span data-ttu-id="c7246-212">服务总线</span><span class="sxs-lookup"><span data-stu-id="c7246-212">Service Bus</span></span>

<span data-ttu-id="c7246-213">**对生产工作负荷使用高级层**。</span><span class="sxs-lookup"><span data-stu-id="c7246-213">**Use Premium tier for production workloads**.</span></span> <span data-ttu-id="c7246-214">[服务总线高级消息传送](/azure/service-bus-messaging/service-bus-premium-messaging)提供专用和预留的处理资源与内存容量来支持可预测的性能和吞吐量。</span><span class="sxs-lookup"><span data-stu-id="c7246-214">[Service Bus Premium Messaging](/azure/service-bus-messaging/service-bus-premium-messaging) provides dedicated and reserved processing resources, and memory capacity to support predictable performance and throughput.</span></span> <span data-ttu-id="c7246-215">使用高级消息传送层还能访问最初只为高级用户提供的新功能。</span><span class="sxs-lookup"><span data-stu-id="c7246-215">Premium Messaging tier also gives you access to new features that are available only to premium customers at first.</span></span> <span data-ttu-id="c7246-216">可以根据预期工作负荷确定消息传送单元数。</span><span class="sxs-lookup"><span data-stu-id="c7246-216">You can decide the number of messaging units based on expected workloads.</span></span>

<span data-ttu-id="c7246-217">**处理重复消息**。</span><span class="sxs-lookup"><span data-stu-id="c7246-217">**Handle duplicate messages**.</span></span> <span data-ttu-id="c7246-218">如果发布者在发送消息后立即失败，或者遇到网络或系统问题，它可能无法记录该消息已送达，而是将同一条消息发送到系统两次。</span><span class="sxs-lookup"><span data-stu-id="c7246-218">If a publisher fails immediately after sending a message, or experiences network or system issues, it may erroneously fail to record that the message was delivered, and may send the same message to the system twice.</span></span> <span data-ttu-id="c7246-219">启用重复检测后，服务总线可以处理此问题。</span><span class="sxs-lookup"><span data-stu-id="c7246-219">Service Bus can handle this issue by enabling duplicate detection.</span></span> <span data-ttu-id="c7246-220">有关详细信息，请参阅[重复检测](/azure/service-bus-messaging/duplicate-detection)。</span><span class="sxs-lookup"><span data-stu-id="c7246-220">For more information, see [Duplicate detection](/azure/service-bus-messaging/duplicate-detection).</span></span>

<span data-ttu-id="c7246-221">**处理异常**。</span><span class="sxs-lookup"><span data-stu-id="c7246-221">**Handle exceptions**.</span></span> <span data-ttu-id="c7246-222">发生用户错误、配置错误或其他错误时，消息传送 API 会生成异常。</span><span class="sxs-lookup"><span data-stu-id="c7246-222">Messaging APIs generate exceptions when a user error, configuration error, or other error occurs.</span></span> <span data-ttu-id="c7246-223">客户端代码（发送方和接收方）应在其代码中处理这些异常。</span><span class="sxs-lookup"><span data-stu-id="c7246-223">The client code (senders and receivers) should handle these exceptions in their code.</span></span> <span data-ttu-id="c7246-224">此机制在批处理中尤为重要，在其中可以使用异常处理来避免丢失整批消息。</span><span class="sxs-lookup"><span data-stu-id="c7246-224">This is especially important in batch processing, where exception handling can be used to avoid losing an entire batch of messages.</span></span> <span data-ttu-id="c7246-225">有关详细信息，请参阅[服务总线消息传送异常](/azure/service-bus-messaging/service-bus-messaging-exceptions)。</span><span class="sxs-lookup"><span data-stu-id="c7246-225">For more information, see [Service Bus messaging exceptions](/azure/service-bus-messaging/service-bus-messaging-exceptions).</span></span>

<span data-ttu-id="c7246-226">**重试策略**。</span><span class="sxs-lookup"><span data-stu-id="c7246-226">**Retry policy**.</span></span> <span data-ttu-id="c7246-227">服务总线允许为应用程序选择最佳的重试策略。</span><span class="sxs-lookup"><span data-stu-id="c7246-227">Service Bus allows you to pick the best retry policy for your applications.</span></span> <span data-ttu-id="c7246-228">默认策略是最多允许重试 9 次，并等待 30 秒，但可以进一步调整此策略。</span><span class="sxs-lookup"><span data-stu-id="c7246-228">The default policy is to allow 9 maximum retry attempts, and wait for 30 seconds but this can be further adjusted.</span></span> <span data-ttu-id="c7246-229">有关详细信息，请参阅[重试策略 - 服务总线](/azure/architecture/best-practices/retry-service-specific#service-bus)。</span><span class="sxs-lookup"><span data-stu-id="c7246-229">For more information, see [Retry policy – Service Bus](/azure/architecture/best-practices/retry-service-specific#service-bus).</span></span>

<span data-ttu-id="c7246-230">**使用死信队列**。</span><span class="sxs-lookup"><span data-stu-id="c7246-230">**Use a dead-letter queue**.</span></span> <span data-ttu-id="c7246-231">如果多次重试后仍然无法处理某条消息或将其传送给任何接收方，该消息将移到死信队列。</span><span class="sxs-lookup"><span data-stu-id="c7246-231">If a message cannot be processed or delivered to any receiver after multiple retries, it is moved to a dead letter queue.</span></span> <span data-ttu-id="c7246-232">实施一个过程以从死信队列读取消息、检查消息，并解决问题。</span><span class="sxs-lookup"><span data-stu-id="c7246-232">Implement a process to read messages from the dead letter queue, inspect them, and remediate the problem.</span></span> <span data-ttu-id="c7246-233">根据具体的场景，可按原样重试发送消息、对其进行更改并重试，或放弃消息。</span><span class="sxs-lookup"><span data-stu-id="c7246-233">Depending on the scenario, you might retry the message as-is, make changes and retry, or discard the message.</span></span> <span data-ttu-id="c7246-234">有关详细信息，请参阅[服务总线死信队列概述](/azure/service-bus-messaging/service-bus-dead-letter-queues)。</span><span class="sxs-lookup"><span data-stu-id="c7246-234">For more information, see [Overview of Service Bus dead-letter queues](/azure/service-bus-messaging/service-bus-dead-letter-queues).</span></span>

<span data-ttu-id="c7246-235">**使用异地灾难恢复**。</span><span class="sxs-lookup"><span data-stu-id="c7246-235">**Use Geo-Disaster Recovery**.</span></span> <span data-ttu-id="c7246-236">异地灾难恢复确保在整个 Azure 区域或数据中心由于灾难而不可用时，数据处理可以继续在不同的区域或数据中心进行。</span><span class="sxs-lookup"><span data-stu-id="c7246-236">Geo-disaster recovery ensures that data processing continues to operate in a different region or datacenter if an entire Azure region or datacenter becomes unavailable due to a disaster.</span></span> <span data-ttu-id="c7246-237">有关详细信息，请参阅 [Azure 服务总线异地灾难恢复](/azure/service-bus-messaging/service-bus-geo-dr)。</span><span class="sxs-lookup"><span data-stu-id="c7246-237">For more information, see [Azure Service Bus Geo-disaster recovery](/azure/service-bus-messaging/service-bus-geo-dr).</span></span>

## <a name="storage"></a><span data-ttu-id="c7246-238">存储</span><span class="sxs-lookup"><span data-stu-id="c7246-238">Storage</span></span>

<span data-ttu-id="c7246-239">**对于应用程序数据，请使用读取访问异地冗余存储 (RA-GRS)。**</span><span class="sxs-lookup"><span data-stu-id="c7246-239">**For application data, use read-access geo-redundant storage (RA-GRS).**</span></span> <span data-ttu-id="c7246-240">RA-GRS 存储将数据复制到次要区域，并提供从次要区域的只读访问权限。</span><span class="sxs-lookup"><span data-stu-id="c7246-240">RA-GRS storage replicates the data to a secondary region, and provides read-only access from the secondary region.</span></span> <span data-ttu-id="c7246-241">如果主要区域中发生存储故障，应用程序可以从次要区域读取数据。</span><span class="sxs-lookup"><span data-stu-id="c7246-241">If there is a storage outage in the primary region, the application can read the data from the secondary region.</span></span> <span data-ttu-id="c7246-242">有关详细信息，请参阅 [Azure 存储复制](/azure/storage/storage-redundancy/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-242">For more information, see [Azure Storage replication](/azure/storage/storage-redundancy/).</span></span>

<span data-ttu-id="c7246-243">**对于 VM 磁盘，请使用托管磁盘。**</span><span class="sxs-lookup"><span data-stu-id="c7246-243">**For VM disks, use Managed Disks.**</span></span> <span data-ttu-id="c7246-244">[托管磁盘][managed-disks]为可用性集中的 VM 提供更高的可靠性，因为这些磁盘彼此充分隔离，可避免单一故障点。</span><span class="sxs-lookup"><span data-stu-id="c7246-244">[Managed Disks][managed-disks] provide better reliability for VMs in an availability set, because the disks are sufficiently isolated from each other to avoid single points of failure.</span></span> <span data-ttu-id="c7246-245">此外，托管磁盘不受存储帐户中创建的 VHD 的 IOPS 限制。</span><span class="sxs-lookup"><span data-stu-id="c7246-245">Also, Managed Disks aren't subject to the IOPS limits of VHDs created in a storage account.</span></span> <span data-ttu-id="c7246-246">有关详细信息，请参阅[在 Azure 中管理 Windows 虚拟机的可用性][vm-manage-availability]。</span><span class="sxs-lookup"><span data-stu-id="c7246-246">For more information, see [Manage the availability of Windows virtual machines in Azure][vm-manage-availability].</span></span>

<span data-ttu-id="c7246-247">**对于队列存储，请在另一个区域中创建备份队列。**</span><span class="sxs-lookup"><span data-stu-id="c7246-247">**For Queue storage, create a backup queue in another region.**</span></span> <span data-ttu-id="c7246-248">对于队列存储，只读副本的作用有限，因为无法将项排队或取消排队。</span><span class="sxs-lookup"><span data-stu-id="c7246-248">For Queue storage, a read-only replica has limited use, because you can't queue or dequeue items.</span></span> <span data-ttu-id="c7246-249">应在另一个区域中的某个存储帐户中创建备份队列。</span><span class="sxs-lookup"><span data-stu-id="c7246-249">Instead, create a backup queue in a storage account in another region.</span></span> <span data-ttu-id="c7246-250">如果发生存储故障，应用程序可以使用备份队列，直到主要区域重新可用。</span><span class="sxs-lookup"><span data-stu-id="c7246-250">If there is a storage outage, the application can use the backup queue, until the primary region becomes available again.</span></span> <span data-ttu-id="c7246-251">这样，应用程序仍可处理新请求。</span><span class="sxs-lookup"><span data-stu-id="c7246-251">That way, the application can still process new requests.</span></span>

## <a name="sql-database"></a><span data-ttu-id="c7246-252">SQL 数据库</span><span class="sxs-lookup"><span data-stu-id="c7246-252">SQL Database</span></span>

<span data-ttu-id="c7246-253">**使用“标准”或“高级”层。**</span><span class="sxs-lookup"><span data-stu-id="c7246-253">**Use Standard or Premium tier.**</span></span> <span data-ttu-id="c7246-254">这些层提供更长的时间点还原期限（35 天）。</span><span class="sxs-lookup"><span data-stu-id="c7246-254">These tiers provide a longer point-in-time restore period (35 days).</span></span> <span data-ttu-id="c7246-255">有关详细信息，请参阅 [SQL 数据库选项和性能](/azure/sql-database/sql-database-service-tiers/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-255">For more information, see [SQL Database options and performance](/azure/sql-database/sql-database-service-tiers/).</span></span>

<span data-ttu-id="c7246-256">**启用 SQL 数据库审核。**</span><span class="sxs-lookup"><span data-stu-id="c7246-256">**Enable SQL Database auditing.**</span></span> <span data-ttu-id="c7246-257">审核可用于诊断恶意攻击或人为错误。</span><span class="sxs-lookup"><span data-stu-id="c7246-257">Auditing can be used to diagnose malicious attacks or human error.</span></span> <span data-ttu-id="c7246-258">有关详细信息，请参阅 [SQL 数据库审核入门](/azure/sql-database/sql-database-auditing-get-started/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-258">For more information, see [Get started with SQL database auditing](/azure/sql-database/sql-database-auditing-get-started/).</span></span>

<span data-ttu-id="c7246-259">**使用活动异地复制**使用活动异地复制在一个不同的区域中创建可读取的辅助副本。</span><span class="sxs-lookup"><span data-stu-id="c7246-259">**Use Active Geo-Replication** Use Active Geo-Replication to create a readable secondary in a different region.</span></span>  <span data-ttu-id="c7246-260">如果主数据库出现故障，或者只是需要脱机，可以手动故障转移到任何辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="c7246-260">If your primary database fails, or simply needs to be taken offline, perform a manual failover to the secondary database.</span></span>  <span data-ttu-id="c7246-261">在故障转移之前，辅助数据库将保持只读状态。</span><span class="sxs-lookup"><span data-stu-id="c7246-261">Until you fail over, the secondary database remains read-only.</span></span>  <span data-ttu-id="c7246-262">有关详细信息，请参阅 [SQL 数据库活动异地复制](/azure/sql-database/sql-database-geo-replication-overview/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-262">For more information, see [SQL Database Active Geo-Replication](/azure/sql-database/sql-database-geo-replication-overview/).</span></span>

<span data-ttu-id="c7246-263">**使用分片。**</span><span class="sxs-lookup"><span data-stu-id="c7246-263">**Use sharding.**</span></span> <span data-ttu-id="c7246-264">考虑使用分片将数据库横向分区。</span><span class="sxs-lookup"><span data-stu-id="c7246-264">Consider using sharding to partition the database horizontally.</span></span> <span data-ttu-id="c7246-265">分片可提供故障隔离。</span><span class="sxs-lookup"><span data-stu-id="c7246-265">Sharding can provide fault isolation.</span></span> <span data-ttu-id="c7246-266">有关详细信息，请参阅[使用 Azure SQL 数据库进行横向扩展](/azure/sql-database/sql-database-elastic-scale-introduction/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-266">For more information, see [Scaling out with Azure SQL Database](/azure/sql-database/sql-database-elastic-scale-introduction/).</span></span>

<span data-ttu-id="c7246-267">**发生人为错误后使用时间点还原进行恢复。**</span><span class="sxs-lookup"><span data-stu-id="c7246-267">**Use point-in-time restore to recover from human error.**</span></span>  <span data-ttu-id="c7246-268">时间点还原可将数据库还原到以前的某个时间点。</span><span class="sxs-lookup"><span data-stu-id="c7246-268">Point-in-time restore returns your database to an earlier point in time.</span></span> <span data-ttu-id="c7246-269">有关详细信息，请参阅[使用自动数据库备份恢复 Azure SQL 数据库][sql-restore]。</span><span class="sxs-lookup"><span data-stu-id="c7246-269">For more information, see [Recover an Azure SQL database using automated database backups][sql-restore].</span></span>

<span data-ttu-id="c7246-270">**发生服务中断后使用异地还原进行恢复。**</span><span class="sxs-lookup"><span data-stu-id="c7246-270">**Use geo-restore to recover from a service outage.**</span></span> <span data-ttu-id="c7246-271">异地还原可从异地冗余的备份还原数据库。</span><span class="sxs-lookup"><span data-stu-id="c7246-271">Geo-restore restores a database from a geo-redundant backup.</span></span>  <span data-ttu-id="c7246-272">有关详细信息，请参阅[使用自动数据库备份恢复 Azure SQL 数据库][sql-restore]。</span><span class="sxs-lookup"><span data-stu-id="c7246-272">For more information, see [Recover an Azure SQL database using automated database backups][sql-restore].</span></span>

## <a name="sql-data-warehouse"></a><span data-ttu-id="c7246-273">SQL 数据仓库</span><span class="sxs-lookup"><span data-stu-id="c7246-273">SQL Data Warehouse</span></span>

<span data-ttu-id="c7246-274">**不要禁用异地备份。**</span><span class="sxs-lookup"><span data-stu-id="c7246-274">**Do not disable geo-backup.**</span></span> <span data-ttu-id="c7246-275">默认情况下，SQL 数据仓库每 24 小时就创建数据的完整备份以用于灾难恢复。</span><span class="sxs-lookup"><span data-stu-id="c7246-275">By default, SQL Data Warehouse takes a full backup of your data every 24 hours for disaster recovery.</span></span> <span data-ttu-id="c7246-276">建议不要关闭此功能。</span><span class="sxs-lookup"><span data-stu-id="c7246-276">It is not recommended to turn this feature off.</span></span> <span data-ttu-id="c7246-277">有关详细信息，请参阅[异地备份](/azure/sql-data-warehouse/backup-and-restore#geo-backups)。</span><span class="sxs-lookup"><span data-stu-id="c7246-277">For more information, see [Geo-backups](/azure/sql-data-warehouse/backup-and-restore#geo-backups).</span></span>

## <a name="sql-server-running-in-a-vm"></a><span data-ttu-id="c7246-278">VM 中运行的 SQL Server</span><span class="sxs-lookup"><span data-stu-id="c7246-278">SQL Server running in a VM</span></span>

<span data-ttu-id="c7246-279">**复制数据库。**</span><span class="sxs-lookup"><span data-stu-id="c7246-279">**Replicate the database.**</span></span> <span data-ttu-id="c7246-280">使用 SQL Server Always On 可用性组复制数据库。</span><span class="sxs-lookup"><span data-stu-id="c7246-280">Use SQL Server Always On Availability Groups to replicate the database.</span></span> <span data-ttu-id="c7246-281">当某个 SQL Server 实例发生故障时可提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="c7246-281">Provides high availability if one SQL Server instance fails.</span></span> <span data-ttu-id="c7246-282">有关详细信息，请参阅[对 N 层应用程序运行 Windows VM](../reference-architectures/virtual-machines-windows/n-tier.md)</span><span class="sxs-lookup"><span data-stu-id="c7246-282">For more information, see [Run Windows VMs for an N-tier application](../reference-architectures/virtual-machines-windows/n-tier.md)</span></span>

<span data-ttu-id="c7246-283">**备份数据库**。</span><span class="sxs-lookup"><span data-stu-id="c7246-283">**Back up the database**.</span></span> <span data-ttu-id="c7246-284">如果已在使用 [Azure 备份](/azure/backup/)来备份 VM，请考虑[使用 DPM 为 SQL 工作负荷配置 Azure 备份](/azure/backup/backup-azure-backup-sql/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-284">If you are already using [Azure Backup](/azure/backup/) to back up your VMs, consider using [Azure Backup for SQL Server workloads using DPM](/azure/backup/backup-azure-backup-sql/).</span></span> <span data-ttu-id="c7246-285">使用此方法时，将为组织配置一个备份管理员角色，并为 VM 和 SQL Server 创建统一的恢复过程。</span><span class="sxs-lookup"><span data-stu-id="c7246-285">With this approach, there is one backup administrator role for the organization and a unified recovery procedure for VMs and SQL Server.</span></span> <span data-ttu-id="c7246-286">否则，请使用 [Microsoft Azure 的 SQL Server 托管备份](https://msdn.microsoft.com/library/dn449496.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c7246-286">Otherwise, use [SQL Server Managed Backup to Microsoft Azure](https://msdn.microsoft.com/library/dn449496.aspx).</span></span>

## <a name="traffic-manager"></a><span data-ttu-id="c7246-287">流量管理器</span><span class="sxs-lookup"><span data-stu-id="c7246-287">Traffic Manager</span></span>

<span data-ttu-id="c7246-288">**执行手动故障回复。**</span><span class="sxs-lookup"><span data-stu-id="c7246-288">**Perform manual failback.**</span></span> <span data-ttu-id="c7246-289">流量管理器故障转移后，请执行手动故障回复而不是自动故障回复。</span><span class="sxs-lookup"><span data-stu-id="c7246-289">After a Traffic Manager failover, perform manual failback, rather than automatically failing back.</span></span> <span data-ttu-id="c7246-290">在故障回复之前，请验证是否所有应用程序子系统的运行状况都正常。</span><span class="sxs-lookup"><span data-stu-id="c7246-290">Before failing back, verify that all application subsystems are healthy.</span></span>  <span data-ttu-id="c7246-291">否则，可能会造成应用程序在数据中心之间来回转移的情况。</span><span class="sxs-lookup"><span data-stu-id="c7246-291">Otherwise, you can create a situation where the application flips back and forth between data centers.</span></span> <span data-ttu-id="c7246-292">有关详细信息，请参阅[在多个区域中运行 VM 以实现高可用性](../reference-architectures/virtual-machines-windows/multi-region-application.md)。</span><span class="sxs-lookup"><span data-stu-id="c7246-292">For more information, see [Run VMs in multiple regions for high availability](../reference-architectures/virtual-machines-windows/multi-region-application.md).</span></span>

<span data-ttu-id="c7246-293">**创建运行状况探测终结点。**</span><span class="sxs-lookup"><span data-stu-id="c7246-293">**Create a health probe endpoint.**</span></span> <span data-ttu-id="c7246-294">创建一个自定义终结点用于报告应用程序的总体运行状况。</span><span class="sxs-lookup"><span data-stu-id="c7246-294">Create a custom endpoint that reports on the overall health of the application.</span></span> <span data-ttu-id="c7246-295">这样，当任何关键路径（而不仅仅是前端）发生故障时，流量管理器可故障转移。</span><span class="sxs-lookup"><span data-stu-id="c7246-295">This enables Traffic Manager to fail over if any critical path fails, not just the front end.</span></span> <span data-ttu-id="c7246-296">如果任何关键依赖项不正常或不可访问，终结点应返回 HTTP 错误代码。</span><span class="sxs-lookup"><span data-stu-id="c7246-296">The endpoint should return an HTTP error code if any critical dependency is unhealthy or unreachable.</span></span> <span data-ttu-id="c7246-297">但是，不会报告非关键服务发生的错误。</span><span class="sxs-lookup"><span data-stu-id="c7246-297">Don't report errors for non-critical services, however.</span></span> <span data-ttu-id="c7246-298">否则，运行状况探测可能触发不必要的故障转移，并产生误报。</span><span class="sxs-lookup"><span data-stu-id="c7246-298">Otherwise, the health probe might trigger failover when it's not needed, creating false positives.</span></span> <span data-ttu-id="c7246-299">有关详细信息，请参阅[流量管理器终结点监视和故障转移](/azure/traffic-manager/traffic-manager-monitoring/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-299">For more information, see [Traffic Manager endpoint monitoring and failover](/azure/traffic-manager/traffic-manager-monitoring/).</span></span>

## <a name="virtual-machines"></a><span data-ttu-id="c7246-300">虚拟机</span><span class="sxs-lookup"><span data-stu-id="c7246-300">Virtual Machines</span></span>

<span data-ttu-id="c7246-301">**避免在单个 VM 上运行生产工作负荷。**</span><span class="sxs-lookup"><span data-stu-id="c7246-301">**Avoid running a production workload on a single VM.**</span></span> <span data-ttu-id="c7246-302">单个 VM 部署不能弹性应对计划内或计划外维护。</span><span class="sxs-lookup"><span data-stu-id="c7246-302">A single VM deployment is not resilient to planned or unplanned maintenance.</span></span> <span data-ttu-id="c7246-303">应该将多个 VM 放入一个可用性集或 [VM 规模集](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/)，并在其前面使用负载均衡器。</span><span class="sxs-lookup"><span data-stu-id="c7246-303">Instead, put multiple VMs in an availability set or [VM scale set](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/), with a load balancer in front.</span></span>

<span data-ttu-id="c7246-304">**预配 VM 时指定可用性集。**</span><span class="sxs-lookup"><span data-stu-id="c7246-304">**Specify an availability set when you provision the VM.**</span></span> <span data-ttu-id="c7246-305">目前，没有任何方法可以在预配 VM 后将 VM 添加到可用性集。</span><span class="sxs-lookup"><span data-stu-id="c7246-305">Currently, there is no way to add a VM to an availability set after the VM is provisioned.</span></span> <span data-ttu-id="c7246-306">将新的 VM 添加到现有的可用性集时，请务必为该 VM 创建一个 NIC，并将该 NIC 添加到负载均衡器上的后端地址池。</span><span class="sxs-lookup"><span data-stu-id="c7246-306">When you add a new VM to an existing availability set, make sure to create a NIC for the VM, and add the NIC to the back-end address pool on the load balancer.</span></span> <span data-ttu-id="c7246-307">否则，负载均衡器不会将网络流量路由到该 VM。</span><span class="sxs-lookup"><span data-stu-id="c7246-307">Otherwise, the load balancer won't route network traffic to that VM.</span></span>

<span data-ttu-id="c7246-308">**将每个应用程序层放入不同的可用性集。**</span><span class="sxs-lookup"><span data-stu-id="c7246-308">**Put each application tier into a separate Availability Set.**</span></span> <span data-ttu-id="c7246-309">在 N 层应用程序中，不要将不同层中的 VM 放入同一个可用性集。</span><span class="sxs-lookup"><span data-stu-id="c7246-309">In an N-tier application, don't put VMs from different tiers into the same availability set.</span></span> <span data-ttu-id="c7246-310">可用性集中的 VM 放置在不同的容错域 (FD) 和更新域 (UD) 中。</span><span class="sxs-lookup"><span data-stu-id="c7246-310">VMs in an availability set are placed across fault domains (FDs) and update domains (UD).</span></span> <span data-ttu-id="c7246-311">但是，为了获得 FD 与 UD 的冗余优势，可用性集中的每个 VM 必须能够处理相同的客户端请求。</span><span class="sxs-lookup"><span data-stu-id="c7246-311">However, to get the redundancy benefit of FDs and UDs, every VM in the availability set must be able to handle the same client requests.</span></span>

<span data-ttu-id="c7246-312">**使用 Azure Site Recovery 复制 VM。**</span><span class="sxs-lookup"><span data-stu-id="c7246-312">**Replicate VMs using Azure Site Recovery.**</span></span> <span data-ttu-id="c7246-313">使用 [Site Recovery][site-recovery] 复制 Azure VM 时，所有 VM 磁盘将以异步方式持续复制到目标区域。</span><span class="sxs-lookup"><span data-stu-id="c7246-313">When you replicate Azure VMs using [Site Recovery][site-recovery], all the VM disks are continuously replicated to the target region asynchronously.</span></span> <span data-ttu-id="c7246-314">每隔几分钟就会创建恢复点。</span><span class="sxs-lookup"><span data-stu-id="c7246-314">The recovery points are created every few minutes.</span></span> <span data-ttu-id="c7246-315">这可以实现分钟量级的恢复点目标 (RPO)。</span><span class="sxs-lookup"><span data-stu-id="c7246-315">This gives you a Recovery Point Objective (RPO) in the order of minutes.</span></span> <span data-ttu-id="c7246-316">可以开展灾难恢复演练任意次，这不会影响生产应用程序或正在进行的复制。</span><span class="sxs-lookup"><span data-stu-id="c7246-316">You can conduct disaster recovery drills as many times as you want, without impacting the production application or the ongoing replication.</span></span> <span data-ttu-id="c7246-317">有关详细信息，请参阅[运行灾难恢复到 Azure 的演练][site-recovery-test]。</span><span class="sxs-lookup"><span data-stu-id="c7246-317">For more information, see [Run a disaster recovery drill to Azure][site-recovery-test].</span></span>

<span data-ttu-id="c7246-318">**根据性能要求选择适当的 VM 大小。**</span><span class="sxs-lookup"><span data-stu-id="c7246-318">**Choose the right VM size based on performance requirements.**</span></span> <span data-ttu-id="c7246-319">将现有工作负荷转移到 Azure 时，首先请使用与本地服务器最匹配的 VM 大小。</span><span class="sxs-lookup"><span data-stu-id="c7246-319">When moving an existing workload to Azure, start with the VM size that's the closest match to your on-premises servers.</span></span> <span data-ttu-id="c7246-320">然后测量与 CPU、内存和磁盘 IOPS 有关的实际工作负荷的性能，并根据需要调整大小。</span><span class="sxs-lookup"><span data-stu-id="c7246-320">Then measure the performance of your actual workload with respect to CPU, memory, and disk IOPS, and adjust the size if needed.</span></span> <span data-ttu-id="c7246-321">这有助于确保应用程序在云环境中的行为符合预期。</span><span class="sxs-lookup"><span data-stu-id="c7246-321">This helps to ensure the application behaves as expected in a cloud environment.</span></span> <span data-ttu-id="c7246-322">此外，如果需要多个 NIC，请注意每种大小的 NIC 限制。</span><span class="sxs-lookup"><span data-stu-id="c7246-322">Also, if you need multiple NICs, be aware of the NIC limit for each size.</span></span>

<span data-ttu-id="c7246-323">**对 VHD 使用托管磁盘。**</span><span class="sxs-lookup"><span data-stu-id="c7246-323">**Use Managed Disks for VHDs.**</span></span> <span data-ttu-id="c7246-324">[托管磁盘][managed-disks]为可用性集中的 VM 提供更高的可靠性，因为这些磁盘彼此充分隔离，可避免单一故障点。</span><span class="sxs-lookup"><span data-stu-id="c7246-324">[Managed Disks][managed-disks] provide better reliability for VMs in an availability set, because the disks are sufficiently isolated from each other to avoid single points of failure.</span></span> <span data-ttu-id="c7246-325">此外，托管磁盘不受存储帐户中创建的 VHD 的 IOPS 限制。</span><span class="sxs-lookup"><span data-stu-id="c7246-325">Also, Managed Disks aren't subject to the IOPS limits of VHDs created in a storage account.</span></span> <span data-ttu-id="c7246-326">有关详细信息，请参阅[在 Azure 中管理 Windows 虚拟机的可用性][vm-manage-availability]。</span><span class="sxs-lookup"><span data-stu-id="c7246-326">For more information, see [Manage the availability of Windows virtual machines in Azure][vm-manage-availability].</span></span>

<span data-ttu-id="c7246-327">**将应用程序安装在数据磁盘而不是 OS 磁盘上。**</span><span class="sxs-lookup"><span data-stu-id="c7246-327">**Install applications on a data disk, not the OS disk.**</span></span> <span data-ttu-id="c7246-328">否则，可能会达到磁盘大小限制。</span><span class="sxs-lookup"><span data-stu-id="c7246-328">Otherwise, you may reach the disk size limit.</span></span>

<span data-ttu-id="c7246-329">**使用 Azure 备份来备份 VM。**</span><span class="sxs-lookup"><span data-stu-id="c7246-329">**Use Azure Backup to back up VMs.**</span></span> <span data-ttu-id="c7246-330">备份可防范意外的数据丢失。</span><span class="sxs-lookup"><span data-stu-id="c7246-330">Backups protect against accidental data loss.</span></span> <span data-ttu-id="c7246-331">有关详细信息，请参阅[使用恢复服务保管库保护 Azure VM](/azure/backup/backup-azure-vms-first-look-arm/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-331">For more information, see [Protect Azure VMs with a recovery services vault](/azure/backup/backup-azure-vms-first-look-arm/).</span></span>

<span data-ttu-id="c7246-332">**启用监视日志**，包括基本运行状况指标、基础结构日志和[启动诊断][boot-diagnostics]。</span><span class="sxs-lookup"><span data-stu-id="c7246-332">**Enable diagnostic logs**, including basic health metrics, infrastructure logs, and [boot diagnostics][boot-diagnostics].</span></span> <span data-ttu-id="c7246-333">如果 VM 陷入不可启动状态，启动诊断有助于诊断启动故障。</span><span class="sxs-lookup"><span data-stu-id="c7246-333">Boot diagnostics can help you diagnose a boot failure if your VM gets into a non-bootable state.</span></span> <span data-ttu-id="c7246-334">有关详细信息，请参阅 [Azure 诊断日志概述][diagnostics-logs]。</span><span class="sxs-lookup"><span data-stu-id="c7246-334">For more information, see [Overview of Azure Diagnostic Logs][diagnostics-logs].</span></span>

<span data-ttu-id="c7246-335">**使用 AzureLogCollector 扩展。**</span><span class="sxs-lookup"><span data-stu-id="c7246-335">**Use the AzureLogCollector extension.**</span></span> <span data-ttu-id="c7246-336">（仅限 Windows VM。）此扩展可聚合 Azure 平台日志并将其上传到 Azure 存储，而无需操作员远程登录到 VM。</span><span class="sxs-lookup"><span data-stu-id="c7246-336">(Windows VMs only.) This extension aggregates Azure platform logs and uploads them to Azure storage, without the operator remotely logging into the VM.</span></span> <span data-ttu-id="c7246-337">有关详细信息，请参阅 [AzureLogCollector 扩展](/azure/virtual-machines/virtual-machines-windows-log-collector-extension/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)。</span><span class="sxs-lookup"><span data-stu-id="c7246-337">For more information, see [AzureLogCollector Extension](/azure/virtual-machines/virtual-machines-windows-log-collector-extension/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span></span>

## <a name="virtual-network"></a><span data-ttu-id="c7246-338">虚拟网络</span><span class="sxs-lookup"><span data-stu-id="c7246-338">Virtual Network</span></span>

<span data-ttu-id="c7246-339">**要将公共 IP 地址加入允许列表或阻止，请将 NSG 添加到子网。**</span><span class="sxs-lookup"><span data-stu-id="c7246-339">**To whitelist or block public IP addresses, add an NSG to the subnet.**</span></span> <span data-ttu-id="c7246-340">阻止恶意用户的访问，或只允许有权访问应用程序的用户访问。</span><span class="sxs-lookup"><span data-stu-id="c7246-340">Block access from malicious users, or allow access only from users who have privilege to access the application.</span></span>

<span data-ttu-id="c7246-341">**创建自定义运行状况探测。**</span><span class="sxs-lookup"><span data-stu-id="c7246-341">**Create a custom health probe.**</span></span> <span data-ttu-id="c7246-342">负载均衡器运行状况探测可以测试 HTTP 或 TCP。</span><span class="sxs-lookup"><span data-stu-id="c7246-342">Load Balancer Health Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="c7246-343">如果 VM 运行 HTTP 服务器，HTTP 探测的运行状况指示效果比 TCP 探测更好。</span><span class="sxs-lookup"><span data-stu-id="c7246-343">If a VM runs an HTTP server, the HTTP probe is a better indicator of health status than a TCP probe.</span></span> <span data-ttu-id="c7246-344">对于 HTTP 探测，请使用自定义终结点来报告应用程序（包括所有关键依赖项）的总体运行状况。</span><span class="sxs-lookup"><span data-stu-id="c7246-344">For an HTTP probe, use a custom endpoint that reports the overall health of the application, including all critical dependencies.</span></span> <span data-ttu-id="c7246-345">有关详细信息，请参阅 [Azure 负载均衡器概述](/azure/load-balancer/load-balancer-overview/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-345">For more information, see [Azure Load Balancer overview](/azure/load-balancer/load-balancer-overview/).</span></span>

<span data-ttu-id="c7246-346">**不要阻止运行状况探测。**</span><span class="sxs-lookup"><span data-stu-id="c7246-346">**Don't block the health probe.**</span></span> <span data-ttu-id="c7246-347">负载均衡器运行状况探测信息从已知 IP 地址 168.63.129.16 发送。</span><span class="sxs-lookup"><span data-stu-id="c7246-347">The Load Balancer Health probe is sent from a known IP address, 168.63.129.16.</span></span> <span data-ttu-id="c7246-348">不要在任何防火墙策略或网络安全组 (NSG) 规则中阻止与此 IP 之间的流量。</span><span class="sxs-lookup"><span data-stu-id="c7246-348">Don't block traffic to or from this IP in any firewall policies or network security group (NSG) rules.</span></span> <span data-ttu-id="c7246-349">阻止运行状况探测会导致负载均衡器从轮转项目中删除 VM。</span><span class="sxs-lookup"><span data-stu-id="c7246-349">Blocking the health probe would cause the load balancer to remove the VM from rotation.</span></span>

<span data-ttu-id="c7246-350">**启用负载均衡器日志记录。**</span><span class="sxs-lookup"><span data-stu-id="c7246-350">**Enable Load Balancer logging.**</span></span> <span data-ttu-id="c7246-351">这些日志显示后端有多少个 VM 由于失败的探测响应而未收到网络流量。</span><span class="sxs-lookup"><span data-stu-id="c7246-351">The logs show how many VMs on the back-end are not receiving network traffic due to failed probe responses.</span></span> <span data-ttu-id="c7246-352">有关详细信息，请参阅 [Azure 负载均衡器的 Log Analytics](/azure/load-balancer/load-balancer-monitor-log/)。</span><span class="sxs-lookup"><span data-stu-id="c7246-352">For more information, see [Log analytics for Azure Load Balancer](/azure/load-balancer/load-balancer-monitor-log/).</span></span>

<!-- links -->
[boot-diagnostics]: https://azure.microsoft.com/blog/boot-diagnostics-for-virtual-machines-v2/
[diagnostics-logs]: /azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs/
[managed-disks]: /azure/storage/storage-managed-disks-overview
[search-optimization]: /azure/search/search-performance-optimization/
[site-recovery]: /azure/site-recovery/
[site-recovery-test]: /azure/site-recovery/site-recovery-test-failover-to-azure
[sql-backup]: /azure/sql-database/sql-database-automated-backups/
[sql-restore]: /azure/sql-database/sql-database-recovery-using-backups/
[vm-manage-availability]: /azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set
