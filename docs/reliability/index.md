---
title: 设计可靠的 Azure 应用程序
description: 介绍如何使 Azure 应用程序可靠且高度可用
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: ''
ms.openlocfilehash: 16c1daeed9b1d79f33051eb69571f1574bf9be4d
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59644002"
---
# <a name="designing-reliable-azure-applications"></a>设计可靠的 Azure 应用程序

在云中生成可靠的应用程序不同于传统的应用程序开发。 尽管在传统上我们可以采购可纵向扩展的高端硬件，但在云环境中，我们只能横向扩展而不能纵向扩展。 我们的目标不是试图防止各种故障，而是最大程度地减轻单个组件故障造成的影响。

可靠的应用程序具有以下特征：

- **可复原**，能够在故障后正常恢复，并且在完全恢复之前可以继续运行，且只会造成极短的停机时间和极少量的数据丢失。
- **高度可用 (HA)**，可按照设计以正常状态运行，且不会造成很长的停机时间。

了解这些要素如何协同工作 &mdash; 及其对成本造成的影响 &mdash; 是生成可靠应用程序的关键所在。 这可以帮助你确定多长的停机时间是可接受的、可能对业务造成的代价，以及在恢复期间需要保留哪些功能。

本文将会简要概述如何在 Azure 应用程序设计流程的每个步骤中融入可靠性要素。 每个部分都会提供深度文章的链接，其中介绍了如何将可靠性集成到该特定流程步骤。 如需了解各个 Azure 服务的可靠性注意事项，请查看[特定 Azure 服务的复原能力查检表](../checklist/resiliency-per-service.md)。

## <a name="build-for-reliability"></a>可靠性设计

本部分介绍生成可靠 Azure 应用程序的六个步骤。 每个步骤链接到进一步定义流程和术语的部分。

1. [**定义要求。**](#define-requirements) 根据分解的工作负荷与业务需求制定可用性和恢复要求。
1. [**使用体系结构最佳做法。**](#use-architectural-best-practices) 遵循经过证实的做法，在体系结构中识别出潜在的故障点，并确定应用程序如何应对故障。
1. [**使用模拟和强制故障转移进行测试。**](#test-with-simulations-and-forced-failovers) 模拟故障，触发强制故障转移，测试故障检测并在故障后予以恢复。
1. [**以一致的方式部署应用程序。**](#deploy-the-application-consistently) 使用可靠且可重复的流程发布到生产环境。
1. [**监视应用程序运行状况。**](#monitor-application-health) 检测故障，监视潜在故障的迹象，度量应用程序的运行状况。
1. [**应对故障和灾难。**](#respond-to-failures-and-disasters) 识别出故障何时发生，并根据建立的策略确定如何解决该故障。

## <a name="define-requirements"></a>定义要求

确定业务需求，并生成可靠性计划来解决这些需求。 请注意以下几点：

- **识别工作负荷和用法。** 从业务逻辑和数据存储要求的角度讲，工作负荷是逻辑上与其他任务截然不同的功能或任务。 每个工作负荷在可用性、可伸缩性、数据一致性和灾难恢复方面具有不同的要求。
- **规划使用模式。** 使用模式在要求中也发挥了作用。 识别关键和非关键时段的要求差异。 例如，税务申报应用程序在申报截止时间之前不能发生故障。 为了确保正常运行，请规划跨多个区域的冗余，以防其中一个区域发生故障。 相反，为了尽量降低非关键时段的成本，可以在单个区域中运行应用程序。
- **建立可用性指标 &mdash; 平均恢复时间 (MTTR) 和 平均故障间隔时间 (MTBF)。** MTTR 是指发生故障后，还原某个组件所需的平均时间。 MTBF 是指某个组件在两次中断之间按预期方式合理运行的持续时间。 使用这些度量值可以确定要在何处添加冗余，并确定客户的服务级别协议 (SLA)。  
- **建立恢复目标 &mdash; 恢复时间目标和恢复点目标 (RPO)。** *RTO* 是指发生某个事件后，可接受应用程序不可用的最长时间。 *RPO* 是指发生灾难期间，可接受数据丢失的最长持续时间。 若要派生这些值，请展开风险评估，并确保了解组织中发生停机和数据丢失所带来的成本与风险。
    > [!NOTE]
    > 如果高可用性设置中任一关键组件的 MTTR 超过系统 RTO，则系统中的故障可能会导致出现不可接受的业务中断。 即，无法在定义的 RTO 内还原系统。
- **确定工作负荷可用性目标。** 为了确保应用程序体系结构符合业务要求，请定义每个工作负荷的目标 SLA。 除了应用程序依赖关系以外，还应该考虑到满足可用性要求所需的成本与复杂性。
- **了解服务级别协议。** 在 Azure 中，SLA 描述 Microsoft 在运行时间和连接性方面所做的承诺。 如果针对特定服务的 SLA 为 99.9%，则应该预期该服务在 99.9% 的时间内可用。  

    针对解决方案中的每个工作负荷定义你自己的目标 SLA，以便可以确定体系结构是否符合业务要求。 例如，如果某个工作负荷的运行时间需要达到 99.99%，但它依赖于 SLA 为 99.9 % 的某个服务，那么，该服务不能是系统中的单一故障点。

有关为可靠应用程序制定要求的详细信息，请参阅[为可复原的 Azure 应用程序制定要求](./requirements.md)。

## <a name="use-architectural-best-practices"></a>使用体系结构最佳做法

在体系结构阶段，请注重根据业务要求实施最佳做法，识别出故障点，并最大程度地减小故障范围。

- **执行故障模式分析 (FMA)。** FMA 在设计阶段提前将复原能力融入到应用程序中。 它可以帮助你识别出应用程序可能遇到的故障类型、每种故障的潜在影响，以及可能的恢复策略。
- **创建冗余计划。** 每个工作负荷所需的冗余级别取决于业务需求，它会考虑到应用程序的总体成本。 
- **可伸缩性设计。** 云应用程序必须能够根据用途的变化进行缩放。 从离散的组件着手，尽量将应用程序设计为自动应对负载变化。 设计期间请考虑到缩放限制，以便将来可以轻松扩展。
- **规划订阅和服务要求。** 你可能需要使用更多的订阅来预配足够的资源，以满足存储、连接、吞吐量等方面的业务要求。 
- **使用负载均衡来分发请求。** 负载均衡通过从循环列表中删除不正常的实例，将应用程序请求分发到正常的服务实例。
- **实施复原策略。** *复原*是指系统能够在发生故障后进行恢复，然后继续正常运行。 实施[复原能力设计模式](../patterns/category/resiliency.md)，例如，隔离关键资源、使用补偿事务，以及尽可能地执行异步操作。
- **将可用性要求融入到设计中。** 可用性是指系统正常工作时间所占的比例。 采取措施来确保应用程序可用性符合服务级别协议。 例如，避免单一故障点、按服务级别目标分解工作负荷，以及限制高流量用户。
- **管理数据。** 数据的存储、备份和复制方式至关重要。

  - **选择应用程序数据的复制方法。** 应用程序数据将存储在各种数据存储中，因此可能具有不同的可用性要求。 评估每种数据存储的复制方法和位置，确保它们满足要求。
  - **阐述并测试故障转移和故障回复流程。** 明确阐述有关故障转移到新数据存储的说明，并定期对其进行测试，确保这些说明准确且易于遵循。
  - **保护数据。** 定期备份并验证数据，确保没有任何一个用户帐户既可以访问生产数据，也可以访问备份数据。
  - **规划数据恢复。** 确保备份和复制策略提供的数据恢复时间可以满足服务级别要求。 考虑到应用程序使用的所有数据类型，包括引用数据和数据库。

有关构建可靠应用程序的详细信息，请参阅[构建具有复原能力和高可用性的 Azure 应用程序](./architect.md)。

## <a name="test-with-simulations-and-forced-failovers"></a>使用模拟和强制故障转移进行测试

可靠性测试需要在故障状态下度量端到端工作负荷的执行情况，而这种状态只能间歇性地出现。

- **通过触发实际故障或模拟故障来测试常见故障场景。** 使用故障注入测试来测试常见场景（包括故障组合）和恢复时间。
- **识别仅在承受负载的情况下才出现的故障。** 使用生产数据或尽量与生产数据接近的合成数据测试峰值负载，以了解应用程序在真实条件下的行为。
- **运行灾难恢复演练。** 制定灾难恢复计划并定期测试，以确保该计划可正常运行。
- **执行故障转移和故障回复测试。** 确保应用程序的依赖服务按正确的顺序故障转移和故障回复。
- **运行模拟测试。** 测试真实场景可以突显需要解决的问题。 场景应该可控，且不会中断业务。 告知管理层将要模拟测试计划。
- **测试运行状况探测。** 为负载均衡器和流量管理器配置运行状况探测，以检查关键系统组件。 测试这些探测，确保它们正确做出响应。
- **测试监视系统。** 确保监视系统可靠报告关键信息和准确的数据来帮助识别潜在故障。
- **在测试场景中包含第三方服务。** 除了测试恢复功能以外，还要测试第三方服务中断可能造成的故障点。

测试是一个迭代过程。 需要测试应用程序、度量结果、分析并解决任何故障，并重复该流程。

有关测试应用程序可靠性的详细信息，请参阅[测试 Azure 应用程序的复原能力和可用性](./testing.md)。

## <a name="deploy-the-application-consistently"></a>以一致的方式部署应用程序

部署包括预配 Azure 资源、部署应用程序代码和应用配置设置。 更新可能涉及到上述所有三个任务，或其中的一部分。

将应用程序部署到生产环境后，更新操作就成了一个可能的出错来源。 使用可预测且可重复的部署过程来尽量减少错误。

- **将应用程序部署流程自动化。** 将尽可能多的流程自动化。
- **设计发布流程以尽量提高可用性。** 如果发布流程要求服务在部署期间脱机，应用程序只能在重新联机后才可用。 利用平台过渡和生产功能。 使用蓝绿发布或 Canary 发布方法来部署更新，以便在失败时可以快速回滚更新。
- **为部署创建回滚计划。** 设计回滚流程，以便在发生部署失败时还原到上次已知正确的版本，并尽量减少停机时间。
- **记录并审核部署。** 如果使用分阶段部署方法，则生产环境中会运行应用程序的多个版本。 实施可靠的日志记录策略来尽量多地捕获版本特定的信息。
- **阐述应用程序发布流程。** 明确定义和阐述发布过程，并确保将其提供给整个运营团队。

有关应用程序可靠性和部署的详细信息，请参阅[部署具有复原能力和高可用性的 Azure 应用程序](./deploy.md)。

## <a name="monitor-application-health"></a>监视应用程序运行状况

在应用程序中实施有关监视和警报的最佳做法，以便可以检测故障，并提醒操作员解决这些故障。

- **实施运行状况探测和检查功能。** 在应用程序外部定期运行这些功能，以识别应用程序运行状况和性能下降的问题。
- **检查长时间运行的工作流。** 提前检测到问题可以尽量减少回滚整个工作流或执行多个补偿事务的需要。
- **维护应用程序日志。**

  - 在生产环境在和服务边界处记录应用程序。
  - 使用语义和异步日志记录。
  - 将应用程序日志与审核日志区分开来。

- **度量远程调用统计信息，并与应用程序团队共享数据。** 为了让运营团队即时查看应用程序运行状况，请汇总远程调用指标，例如延迟、吞吐量，以及第 99 和 95 百分位的错误。 针对指标执行统计分析，以发现每个百分位中发生的错误。
- **跟踪适当时间范围内的暂时性异常和重试次数。** 在一段时间内异常的增加趋势指示此服务有问题，并可能发生故障。
- **设置提前警告系统。** 识别应用程序运行状况的关键性能指标 (KPI)，例如暂时性异常和远程调用延迟，并为每个指标设置适当的阈值。 达到阈值时，将警报发送到操作员。
- **在 Azure 订阅限制范围内操作**。 Azure 订阅限制特定的资源类型，例如资源组、核心和存储帐户的数目。 监视资源类型的用法。
- **监视第三方服务。** 记录调用，并使用唯一标识符将其关联到应用程序的运行状况和诊断日志记录。
- **为多个操作员提供培训，使他们能够监视应用程序并执行手动恢复步骤。** 确保始终至少有一名经过培训的操作员在值勤。

有关监视应用程序可靠性的详细信息，请参阅[监视 Azure 应用程序运行状况](./monitoring.md)。

## <a name="respond-to-failures-and-disasters"></a>应对故障和灾难

创建恢复计划，确保其中涵盖了数据还原、网络中断、依赖服务故障和区域范围的服务中断。 在恢复策略中考虑到 VM、存储、数据库和其他 Azure 平台服务。

- **规划 Azure 支持交互。** 在需求出现之前，请建立有关联系 Azure 支持部门的流程。
- **阐述并测试灾难恢复计划。** 编写一个灾难恢复计划来反映应用程序故障对业务造成的影响。 尽可能地将恢复流程自动化，并阐述任何手动步骤。 定期测试灾难恢复过程，以验证并改进计划。
- **根据需要手动故障转移。** 某些系统无法自动故障转移，需要手动故障转移。 如果应用程序故障转移到次要区域，请执行操作就绪性测试。 故障回复之前，请验证主要区域是否正常，并可以再次接收流量。 确定有哪些应用程序功能减弱，以及应用如何告知用户出现了暂时性问题。
- **针对应用程序故障做好准备。** 准备好应对一系列故障，包括系统自动处理的故障、导致功能减弱的故障，以及导致应用程序不可用的故障。 应用程序应该告知用户出现了暂时性问题。
- **数据损坏后进行恢复。** 如果数据存储发生故障，请在该存储再次可用后检查数据不一致情况，尤其是数据是复制过来的情况下。 从备份还原已损坏的数据。
- **网络中断后进行恢复。** 你也许可以使用缓存的数据在本地运行应用程序，但应用程序的功能会减弱。 否则，请考虑关闭应用程序，或故障转移到另一个区域。 将数据存储在备用位置，直到连接恢复。
- **发生依赖服务故障后进行恢复。** 确定哪些功能仍然可用，以及应用程序如何做出响应。
- **发生区域范围的服务中断后进行恢复。** 区域范围的服务中断并不常见，但你应该制定一个策略来应对此类问题，尤其是针对关键应用程序。 你也许可以将应用程序重新部署到另一个区域，或重新分发流量。

有关应对故障和灾难恢复的详细信息，请参阅 [Azure 应用程序的故障和灾难恢复](./disaster-recovery.md)。

## <a name="next-steps"></a>后续步骤

> [!div class="nextstepaction"]
> [制定可复原应用程序的要求](./requirements.md)
