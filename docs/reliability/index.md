---
title: 设计可靠的 Azure 应用程序
description: 介绍如何使 Azure 应用程序可靠且高度可用
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: ''
ms.openlocfilehash: 16c1daeed9b1d79f33051eb69571f1574bf9be4d
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59644002"
---
# <a name="designing-reliable-azure-applications"></a><span data-ttu-id="74da0-103">设计可靠的 Azure 应用程序</span><span class="sxs-lookup"><span data-stu-id="74da0-103">Designing reliable Azure applications</span></span>

<span data-ttu-id="74da0-104">在云中生成可靠的应用程序不同于传统的应用程序开发。</span><span class="sxs-lookup"><span data-stu-id="74da0-104">Building a reliable application in the cloud is different from traditional application development.</span></span> <span data-ttu-id="74da0-105">尽管在传统上我们可以采购可纵向扩展的高端硬件，但在云环境中，我们只能横向扩展而不能纵向扩展。</span><span class="sxs-lookup"><span data-stu-id="74da0-105">While historically you may have purchased higher-end hardware to scale up, in a cloud environment you scale out instead of up.</span></span> <span data-ttu-id="74da0-106">我们的目标不是试图防止各种故障，而是最大程度地减轻单个组件故障造成的影响。</span><span class="sxs-lookup"><span data-stu-id="74da0-106">Instead of trying to prevent failures altogether, the goal is to minimize the effects of a single failing component.</span></span>

<span data-ttu-id="74da0-107">可靠的应用程序具有以下特征：</span><span class="sxs-lookup"><span data-stu-id="74da0-107">Reliable applications are:</span></span>

- <span data-ttu-id="74da0-108">**可复原**，能够在故障后正常恢复，并且在完全恢复之前可以继续运行，且只会造成极短的停机时间和极少量的数据丢失。</span><span class="sxs-lookup"><span data-stu-id="74da0-108">**Resilient** and recover gracefully from failures, and they continue to function with minimal downtime and data loss before full recovery.</span></span>
- <span data-ttu-id="74da0-109">**高度可用 (HA)**，可按照设计以正常状态运行，且不会造成很长的停机时间。</span><span class="sxs-lookup"><span data-stu-id="74da0-109">**Highly available (HA)** and run as designed in a healthy state with no significant downtime.</span></span>

<span data-ttu-id="74da0-110">了解这些要素如何协同工作 &mdash; 及其对成本造成的影响 &mdash; 是生成可靠应用程序的关键所在。</span><span class="sxs-lookup"><span data-stu-id="74da0-110">Understanding how these elements work together &mdash; and how they affect cost &mdash; is essential to building a reliable application.</span></span> <span data-ttu-id="74da0-111">这可以帮助你确定多长的停机时间是可接受的、可能对业务造成的代价，以及在恢复期间需要保留哪些功能。</span><span class="sxs-lookup"><span data-stu-id="74da0-111">It can help you determine how much downtime is acceptable, the potential cost to your business, and which functions are necessary during a recovery.</span></span>

<span data-ttu-id="74da0-112">本文将会简要概述如何在 Azure 应用程序设计流程的每个步骤中融入可靠性要素。</span><span class="sxs-lookup"><span data-stu-id="74da0-112">This article provides a brief overview of building reliability into each step of the Azure application design process.</span></span> <span data-ttu-id="74da0-113">每个部分都会提供深度文章的链接，其中介绍了如何将可靠性集成到该特定流程步骤。</span><span class="sxs-lookup"><span data-stu-id="74da0-113">Each section includes a link to an in-depth article on how to integrate reliability into that specific step in the process.</span></span> <span data-ttu-id="74da0-114">如需了解各个 Azure 服务的可靠性注意事项，请查看[特定 Azure 服务的复原能力查检表](../checklist/resiliency-per-service.md)。</span><span class="sxs-lookup"><span data-stu-id="74da0-114">If you're looking for reliability considerations for individual Azure services, review the [Resiliency checklist for specific Azure services](../checklist/resiliency-per-service.md).</span></span>

## <a name="build-for-reliability"></a><span data-ttu-id="74da0-115">可靠性设计</span><span class="sxs-lookup"><span data-stu-id="74da0-115">Build for reliability</span></span>

<span data-ttu-id="74da0-116">本部分介绍生成可靠 Azure 应用程序的六个步骤。</span><span class="sxs-lookup"><span data-stu-id="74da0-116">This section describes six steps for building a reliable Azure application.</span></span> <span data-ttu-id="74da0-117">每个步骤链接到进一步定义流程和术语的部分。</span><span class="sxs-lookup"><span data-stu-id="74da0-117">Each step links to a section that further defines the process and terms.</span></span>

1. [<span data-ttu-id="74da0-118">**定义要求。**</span><span class="sxs-lookup"><span data-stu-id="74da0-118">**Define requirements.**</span></span>](#define-requirements) <span data-ttu-id="74da0-119">根据分解的工作负荷与业务需求制定可用性和恢复要求。</span><span class="sxs-lookup"><span data-stu-id="74da0-119">Develop availability and recovery requirements based on decomposed workloads and business needs.</span></span>
1. [<span data-ttu-id="74da0-120">**使用体系结构最佳做法。**</span><span class="sxs-lookup"><span data-stu-id="74da0-120">**Use architectural best practices.**</span></span>](#use-architectural-best-practices) <span data-ttu-id="74da0-121">遵循经过证实的做法，在体系结构中识别出潜在的故障点，并确定应用程序如何应对故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-121">Follow proven practices, identify possible failure points in the architecture, and determine how the application will respond to failure.</span></span>
1. [<span data-ttu-id="74da0-122">**使用模拟和强制故障转移进行测试。**</span><span class="sxs-lookup"><span data-stu-id="74da0-122">**Test with simulations and forced failovers.**</span></span>](#test-with-simulations-and-forced-failovers) <span data-ttu-id="74da0-123">模拟故障，触发强制故障转移，测试故障检测并在故障后予以恢复。</span><span class="sxs-lookup"><span data-stu-id="74da0-123">Simulate faults, trigger forced failovers, and test detection and recovery from these failures.</span></span>
1. [<span data-ttu-id="74da0-124">**以一致的方式部署应用程序。**</span><span class="sxs-lookup"><span data-stu-id="74da0-124">**Deploy the application consistently.**</span></span>](#deploy-the-application-consistently) <span data-ttu-id="74da0-125">使用可靠且可重复的流程发布到生产环境。</span><span class="sxs-lookup"><span data-stu-id="74da0-125">Release to production using reliable and repeatable processes.</span></span>
1. [<span data-ttu-id="74da0-126">**监视应用程序运行状况。**</span><span class="sxs-lookup"><span data-stu-id="74da0-126">**Monitor application health.**</span></span>](#monitor-application-health) <span data-ttu-id="74da0-127">检测故障，监视潜在故障的迹象，度量应用程序的运行状况。</span><span class="sxs-lookup"><span data-stu-id="74da0-127">Detect failures, monitor indicators of potential failures, and gauge the health of your applications.</span></span>
1. [<span data-ttu-id="74da0-128">**应对故障和灾难。**</span><span class="sxs-lookup"><span data-stu-id="74da0-128">**Respond to failures and disasters.**</span></span>](#respond-to-failures-and-disasters) <span data-ttu-id="74da0-129">识别出故障何时发生，并根据建立的策略确定如何解决该故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-129">Identify when a failure occurs, and determine how to address it based on established strategies.</span></span>

## <a name="define-requirements"></a><span data-ttu-id="74da0-130">定义要求</span><span class="sxs-lookup"><span data-stu-id="74da0-130">Define requirements</span></span>

<span data-ttu-id="74da0-131">确定业务需求，并生成可靠性计划来解决这些需求。</span><span class="sxs-lookup"><span data-stu-id="74da0-131">Identify your business needs, and build your reliability plan to address them.</span></span> <span data-ttu-id="74da0-132">请注意以下几点：</span><span class="sxs-lookup"><span data-stu-id="74da0-132">Consider the following:</span></span>

- <span data-ttu-id="74da0-133">**识别工作负荷和用法。**</span><span class="sxs-lookup"><span data-stu-id="74da0-133">**Identify workloads and usage.**</span></span> <span data-ttu-id="74da0-134">从业务逻辑和数据存储要求的角度讲，工作负荷是逻辑上与其他任务截然不同的功能或任务。</span><span class="sxs-lookup"><span data-stu-id="74da0-134">A *workload* is a distinct capability or task that is logically separated from other tasks, in terms of business logic and data storage requirements.</span></span> <span data-ttu-id="74da0-135">每个工作负荷在可用性、可伸缩性、数据一致性和灾难恢复方面具有不同的要求。</span><span class="sxs-lookup"><span data-stu-id="74da0-135">Each workload has different requirements for availability, scalability, data consistency, and disaster recovery.</span></span>
- <span data-ttu-id="74da0-136">**规划使用模式。**</span><span class="sxs-lookup"><span data-stu-id="74da0-136">**Plan for usage patterns.**</span></span> <span data-ttu-id="74da0-137">使用模式在要求中也发挥了作用。</span><span class="sxs-lookup"><span data-stu-id="74da0-137">*Usage patterns* also play a role in requirements.</span></span> <span data-ttu-id="74da0-138">识别关键和非关键时段的要求差异。</span><span class="sxs-lookup"><span data-stu-id="74da0-138">Identify differences in requirements during critical and non-critical periods.</span></span> <span data-ttu-id="74da0-139">例如，税务申报应用程序在申报截止时间之前不能发生故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-139">For example, a tax-filing application can't fail during a filing deadline.</span></span> <span data-ttu-id="74da0-140">为了确保正常运行，请规划跨多个区域的冗余，以防其中一个区域发生故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-140">To ensure uptime, plan redundancy across several regions in case one fails.</span></span> <span data-ttu-id="74da0-141">相反，为了尽量降低非关键时段的成本，可以在单个区域中运行应用程序。</span><span class="sxs-lookup"><span data-stu-id="74da0-141">Conversely, to minimize costs during non-critical periods, you can run your application in a single region.</span></span>
- <span data-ttu-id="74da0-142">**建立可用性指标 &mdash; 平均恢复时间 (MTTR) 和 平均故障间隔时间 (MTBF)。**</span><span class="sxs-lookup"><span data-stu-id="74da0-142">**Establish availability metrics &mdash; *mean time to recovery* (MTTR) and *mean time between failures* (MTBF).**</span></span> <span data-ttu-id="74da0-143">MTTR 是指发生故障后，还原某个组件所需的平均时间。</span><span class="sxs-lookup"><span data-stu-id="74da0-143">MTTR is the average time it takes to restore a component after a failure.</span></span> <span data-ttu-id="74da0-144">MTBF 是指某个组件在两次中断之间按预期方式合理运行的持续时间。</span><span class="sxs-lookup"><span data-stu-id="74da0-144">MTBF is now long a component can reasonably expect to last between outages.</span></span> <span data-ttu-id="74da0-145">使用这些度量值可以确定要在何处添加冗余，并确定客户的服务级别协议 (SLA)。</span><span class="sxs-lookup"><span data-stu-id="74da0-145">Use these measures to determine where to add redundancy and to determine service-level agreements (SLAs) for customers.</span></span>  
- <span data-ttu-id="74da0-146">**建立恢复目标 &mdash; 恢复时间目标和恢复点目标 (RPO)。**</span><span class="sxs-lookup"><span data-stu-id="74da0-146">**Establish recovery metrics &mdash; recovery time objective and recovery point objective (RPO).**</span></span> <span data-ttu-id="74da0-147">*RTO* 是指发生某个事件后，可接受应用程序不可用的最长时间。</span><span class="sxs-lookup"><span data-stu-id="74da0-147">*RTO* is the maximum acceptable time an application can be unavailable after an incident.</span></span> <span data-ttu-id="74da0-148">*RPO* 是指发生灾难期间，可接受数据丢失的最长持续时间。</span><span class="sxs-lookup"><span data-stu-id="74da0-148">*RPO* is the maximum duration of data loss that is acceptable during a disaster.</span></span> <span data-ttu-id="74da0-149">若要派生这些值，请展开风险评估，并确保了解组织中发生停机和数据丢失所带来的成本与风险。</span><span class="sxs-lookup"><span data-stu-id="74da0-149">To derive these values, conduct a risk assessment and make sure you understand the cost and risk of downtime or data loss in your organization.</span></span>
    > [!NOTE]
    > <span data-ttu-id="74da0-150">如果高可用性设置中任一关键组件的 MTTR 超过系统 RTO，则系统中的故障可能会导致出现不可接受的业务中断。</span><span class="sxs-lookup"><span data-stu-id="74da0-150">If the MTTR of *any* critical component in a highly available setup exceeds the system RTO, a failure in the system might cause an unacceptable business disruption.</span></span> <span data-ttu-id="74da0-151">即，无法在定义的 RTO 内还原系统。</span><span class="sxs-lookup"><span data-stu-id="74da0-151">That is, you can't restore the system within the defined RTO.</span></span>
- <span data-ttu-id="74da0-152">**确定工作负荷可用性目标。**</span><span class="sxs-lookup"><span data-stu-id="74da0-152">**Determine workload availability targets.**</span></span> <span data-ttu-id="74da0-153">为了确保应用程序体系结构符合业务要求，请定义每个工作负荷的目标 SLA。</span><span class="sxs-lookup"><span data-stu-id="74da0-153">To ensure that application architecture meets your business requirements, define target SLAs for each workload.</span></span> <span data-ttu-id="74da0-154">除了应用程序依赖关系以外，还应该考虑到满足可用性要求所需的成本与复杂性。</span><span class="sxs-lookup"><span data-stu-id="74da0-154">Account for the cost and complexity of meeting availability requirements, in addition to application dependencies.</span></span>
- <span data-ttu-id="74da0-155">**了解服务级别协议。**</span><span class="sxs-lookup"><span data-stu-id="74da0-155">**Understand service-level agreements.**</span></span> <span data-ttu-id="74da0-156">在 Azure 中，SLA 描述 Microsoft 在运行时间和连接性方面所做的承诺。</span><span class="sxs-lookup"><span data-stu-id="74da0-156">In Azure, the SLA describes the Microsoft commitments for uptime and connectivity.</span></span> <span data-ttu-id="74da0-157">如果针对特定服务的 SLA 为 99.9%，则应该预期该服务在 99.9% 的时间内可用。</span><span class="sxs-lookup"><span data-stu-id="74da0-157">If the SLA for a particular service is 99.9 percent, you should expect the service to be available 99.9 percent of the time.</span></span>  

    <span data-ttu-id="74da0-158">针对解决方案中的每个工作负荷定义你自己的目标 SLA，以便可以确定体系结构是否符合业务要求。</span><span class="sxs-lookup"><span data-stu-id="74da0-158">Define your own target SLAs for each workload in your solution, so you can determine whether the architecture meets the business requirements.</span></span> <span data-ttu-id="74da0-159">例如，如果某个工作负荷的运行时间需要达到 99.99%，但它依赖于 SLA 为 99.9 % 的某个服务，那么，该服务不能是系统中的单一故障点。</span><span class="sxs-lookup"><span data-stu-id="74da0-159">For example, if a workload requires 99.99 percent uptime but depends on a service with a 99.9 percent SLA, that service can't be a single point of failure in the system.</span></span>

<span data-ttu-id="74da0-160">有关为可靠应用程序制定要求的详细信息，请参阅[为可复原的 Azure 应用程序制定要求](./requirements.md)。</span><span class="sxs-lookup"><span data-stu-id="74da0-160">For more information about developing requirements for reliable applications, see [Developing requirements for resilient Azure applications](./requirements.md).</span></span>

## <a name="use-architectural-best-practices"></a><span data-ttu-id="74da0-161">使用体系结构最佳做法</span><span class="sxs-lookup"><span data-stu-id="74da0-161">Use architectural best practices</span></span>

<span data-ttu-id="74da0-162">在体系结构阶段，请注重根据业务要求实施最佳做法，识别出故障点，并最大程度地减小故障范围。</span><span class="sxs-lookup"><span data-stu-id="74da0-162">During the architectural phase, focus on implementing practices that meet your business requirements, identify failure points, and minimize the scope of failures.</span></span>

- <span data-ttu-id="74da0-163">**执行故障模式分析 (FMA)。**</span><span class="sxs-lookup"><span data-stu-id="74da0-163">**Perform a failure mode analysis (FMA).**</span></span> <span data-ttu-id="74da0-164">FMA 在设计阶段提前将复原能力融入到应用程序中。</span><span class="sxs-lookup"><span data-stu-id="74da0-164">FMA builds resiliency into an application early in the design stage.</span></span> <span data-ttu-id="74da0-165">它可以帮助你识别出应用程序可能遇到的故障类型、每种故障的潜在影响，以及可能的恢复策略。</span><span class="sxs-lookup"><span data-stu-id="74da0-165">It helps you identify the types of failures your application might experience, the potential effects of each, and possible recovery strategies.</span></span>
- <span data-ttu-id="74da0-166">**创建冗余计划。**</span><span class="sxs-lookup"><span data-stu-id="74da0-166">**Create a redundancy plan.**</span></span> <span data-ttu-id="74da0-167">每个工作负荷所需的冗余级别取决于业务需求，它会考虑到应用程序的总体成本。</span><span class="sxs-lookup"><span data-stu-id="74da0-167">The level of redundancy required for each workload depends on your business needs and factors into the overall cost of your application.</span></span> 
- <span data-ttu-id="74da0-168">**可伸缩性设计。**</span><span class="sxs-lookup"><span data-stu-id="74da0-168">**Design for scalability.**</span></span> <span data-ttu-id="74da0-169">云应用程序必须能够根据用途的变化进行缩放。</span><span class="sxs-lookup"><span data-stu-id="74da0-169">A cloud application must be able to scale to accommodate changes in usage.</span></span> <span data-ttu-id="74da0-170">从离散的组件着手，尽量将应用程序设计为自动应对负载变化。</span><span class="sxs-lookup"><span data-stu-id="74da0-170">Begin with discrete components, and design the application to respond automatically to load changes whenever possible.</span></span> <span data-ttu-id="74da0-171">设计期间请考虑到缩放限制，以便将来可以轻松扩展。</span><span class="sxs-lookup"><span data-stu-id="74da0-171">Keep scaling limits in mind during design so you can expand easily in the future.</span></span>
- <span data-ttu-id="74da0-172">**规划订阅和服务要求。**</span><span class="sxs-lookup"><span data-stu-id="74da0-172">**Plan for subscription and service requirements.**</span></span> <span data-ttu-id="74da0-173">你可能需要使用更多的订阅来预配足够的资源，以满足存储、连接、吞吐量等方面的业务要求。</span><span class="sxs-lookup"><span data-stu-id="74da0-173">You might need additional subscriptions to provision enough resources to meet your business requirements for storage, connections, throughput, and more.</span></span> 
- <span data-ttu-id="74da0-174">**使用负载均衡来分发请求。**</span><span class="sxs-lookup"><span data-stu-id="74da0-174">**Use load-balancing to distribute requests.**</span></span> <span data-ttu-id="74da0-175">负载均衡通过从循环列表中删除不正常的实例，将应用程序请求分发到正常的服务实例。</span><span class="sxs-lookup"><span data-stu-id="74da0-175">Load-balancing distributes your application's requests to healthy service instances by removing unhealthy instances from rotation.</span></span>
- <span data-ttu-id="74da0-176">**实施复原策略。**</span><span class="sxs-lookup"><span data-stu-id="74da0-176">**Implement resiliency strategies.**</span></span> <span data-ttu-id="74da0-177">*复原*是指系统能够在发生故障后进行恢复，然后继续正常运行。</span><span class="sxs-lookup"><span data-stu-id="74da0-177">*Resiliency* is the ability of a system to recover from failures and continue to function.</span></span> <span data-ttu-id="74da0-178">实施[复原能力设计模式](../patterns/category/resiliency.md)，例如，隔离关键资源、使用补偿事务，以及尽可能地执行异步操作。</span><span class="sxs-lookup"><span data-stu-id="74da0-178">Implement [resiliency design patterns](../patterns/category/resiliency.md), such as isolating critical resources, using compensating transactions, and performing asynchronous operations whenever possible.</span></span>
- <span data-ttu-id="74da0-179">**将可用性要求融入到设计中。**</span><span class="sxs-lookup"><span data-stu-id="74da0-179">**Build availability requirements into your design.**</span></span> <span data-ttu-id="74da0-180">可用性是指系统正常工作时间所占的比例。</span><span class="sxs-lookup"><span data-stu-id="74da0-180">*Availability* is the proportion of time your system is functional and working.</span></span> <span data-ttu-id="74da0-181">采取措施来确保应用程序可用性符合服务级别协议。</span><span class="sxs-lookup"><span data-stu-id="74da0-181">Take steps to ensure that application availability conforms to your service-level agreement.</span></span> <span data-ttu-id="74da0-182">例如，避免单一故障点、按服务级别目标分解工作负荷，以及限制高流量用户。</span><span class="sxs-lookup"><span data-stu-id="74da0-182">For example, avoid single points of failure, decompose workloads by service-level objective, and throttle high-volume users.</span></span>
- <span data-ttu-id="74da0-183">**管理数据。**</span><span class="sxs-lookup"><span data-stu-id="74da0-183">**Manage your data.**</span></span> <span data-ttu-id="74da0-184">数据的存储、备份和复制方式至关重要。</span><span class="sxs-lookup"><span data-stu-id="74da0-184">How you store, back up, and replicate data is critical.</span></span>

  - <span data-ttu-id="74da0-185">**选择应用程序数据的复制方法。**</span><span class="sxs-lookup"><span data-stu-id="74da0-185">**Choose replication methods for your application data.**</span></span> <span data-ttu-id="74da0-186">应用程序数据将存储在各种数据存储中，因此可能具有不同的可用性要求。</span><span class="sxs-lookup"><span data-stu-id="74da0-186">Your application data is stored in various data stores and might have different availability requirements.</span></span> <span data-ttu-id="74da0-187">评估每种数据存储的复制方法和位置，确保它们满足要求。</span><span class="sxs-lookup"><span data-stu-id="74da0-187">Evaluate the replication methods and locations for each type of data store to ensure that they satisfy your requirements.</span></span>
  - <span data-ttu-id="74da0-188">**阐述并测试故障转移和故障回复流程。**</span><span class="sxs-lookup"><span data-stu-id="74da0-188">**Document and test your failover and failback processes.**</span></span> <span data-ttu-id="74da0-189">明确阐述有关故障转移到新数据存储的说明，并定期对其进行测试，确保这些说明准确且易于遵循。</span><span class="sxs-lookup"><span data-stu-id="74da0-189">Clearly document instructions to fail over to a new data store, and test them regularly to make sure they are accurate and easy to follow.</span></span>
  - <span data-ttu-id="74da0-190">**保护数据。**</span><span class="sxs-lookup"><span data-stu-id="74da0-190">**Protect your data.**</span></span> <span data-ttu-id="74da0-191">定期备份并验证数据，确保没有任何一个用户帐户既可以访问生产数据，也可以访问备份数据。</span><span class="sxs-lookup"><span data-stu-id="74da0-191">Back up and validate data regularly, and make sure no single user account has access to both production and backup data.</span></span>
  - <span data-ttu-id="74da0-192">**规划数据恢复。**</span><span class="sxs-lookup"><span data-stu-id="74da0-192">**Plan for data recovery.**</span></span> <span data-ttu-id="74da0-193">确保备份和复制策略提供的数据恢复时间可以满足服务级别要求。</span><span class="sxs-lookup"><span data-stu-id="74da0-193">Make sure that your backup and replication strategy provides for data recovery times that meet your service-level requirements.</span></span> <span data-ttu-id="74da0-194">考虑到应用程序使用的所有数据类型，包括引用数据和数据库。</span><span class="sxs-lookup"><span data-stu-id="74da0-194">Account for all types of data your application uses, including reference data and databases.</span></span>

<span data-ttu-id="74da0-195">有关构建可靠应用程序的详细信息，请参阅[构建具有复原能力和高可用性的 Azure 应用程序](./architect.md)。</span><span class="sxs-lookup"><span data-stu-id="74da0-195">For more information about architecting reliable applications, see [Architecting Azure applications for resiliency and availability](./architect.md).</span></span>

## <a name="test-with-simulations-and-forced-failovers"></a><span data-ttu-id="74da0-196">使用模拟和强制故障转移进行测试</span><span class="sxs-lookup"><span data-stu-id="74da0-196">Test with simulations and forced failovers</span></span>

<span data-ttu-id="74da0-197">可靠性测试需要在故障状态下度量端到端工作负荷的执行情况，而这种状态只能间歇性地出现。</span><span class="sxs-lookup"><span data-stu-id="74da0-197">Testing for reliability requires measuring how the end-to-end workload performs under failure conditions that only occur intermittently.</span></span>

- <span data-ttu-id="74da0-198">**通过触发实际故障或模拟故障来测试常见故障场景。**</span><span class="sxs-lookup"><span data-stu-id="74da0-198">**Test for common failure scenarios by triggering actual failures or by simulating them.**</span></span> <span data-ttu-id="74da0-199">使用故障注入测试来测试常见场景（包括故障组合）和恢复时间。</span><span class="sxs-lookup"><span data-stu-id="74da0-199">Use fault injection testing to test common scenarios (including combinations of failures) and recovery time.</span></span>
- <span data-ttu-id="74da0-200">**识别仅在承受负载的情况下才出现的故障。**</span><span class="sxs-lookup"><span data-stu-id="74da0-200">**Identify failures that occur only under load.**</span></span> <span data-ttu-id="74da0-201">使用生产数据或尽量与生产数据接近的合成数据测试峰值负载，以了解应用程序在真实条件下的行为。</span><span class="sxs-lookup"><span data-stu-id="74da0-201">Test for peak load, using production data or synthetic data that is as close to production data as possible, to see how the application behaves under real-world conditions.</span></span>
- <span data-ttu-id="74da0-202">**运行灾难恢复演练。**</span><span class="sxs-lookup"><span data-stu-id="74da0-202">**Run disaster recovery drills.**</span></span> <span data-ttu-id="74da0-203">制定灾难恢复计划并定期测试，以确保该计划可正常运行。</span><span class="sxs-lookup"><span data-stu-id="74da0-203">Have a disaster recovery plan in place, and test it periodically to make sure it works.</span></span>
- <span data-ttu-id="74da0-204">**执行故障转移和故障回复测试。**</span><span class="sxs-lookup"><span data-stu-id="74da0-204">**Perform failover and failback testing.**</span></span> <span data-ttu-id="74da0-205">确保应用程序的依赖服务按正确的顺序故障转移和故障回复。</span><span class="sxs-lookup"><span data-stu-id="74da0-205">Ensure that your application's dependent services fail over and fail back in the correct order.</span></span>
- <span data-ttu-id="74da0-206">**运行模拟测试。**</span><span class="sxs-lookup"><span data-stu-id="74da0-206">**Run simulation tests.**</span></span> <span data-ttu-id="74da0-207">测试真实场景可以突显需要解决的问题。</span><span class="sxs-lookup"><span data-stu-id="74da0-207">Testing real-life scenarios can highlight issues that need to be addressed.</span></span> <span data-ttu-id="74da0-208">场景应该可控，且不会中断业务。</span><span class="sxs-lookup"><span data-stu-id="74da0-208">Scenarios should be controllable and non-disruptive to the business.</span></span> <span data-ttu-id="74da0-209">告知管理层将要模拟测试计划。</span><span class="sxs-lookup"><span data-stu-id="74da0-209">Inform management of simulation testing plans.</span></span>
- <span data-ttu-id="74da0-210">**测试运行状况探测。**</span><span class="sxs-lookup"><span data-stu-id="74da0-210">**Test health probes.**</span></span> <span data-ttu-id="74da0-211">为负载均衡器和流量管理器配置运行状况探测，以检查关键系统组件。</span><span class="sxs-lookup"><span data-stu-id="74da0-211">Configure health probes for load balancers and traffic managers to check critical system components.</span></span> <span data-ttu-id="74da0-212">测试这些探测，确保它们正确做出响应。</span><span class="sxs-lookup"><span data-stu-id="74da0-212">Test them to make sure that they respond appropriately.</span></span>
- <span data-ttu-id="74da0-213">**测试监视系统。**</span><span class="sxs-lookup"><span data-stu-id="74da0-213">**Test monitoring systems.**</span></span> <span data-ttu-id="74da0-214">确保监视系统可靠报告关键信息和准确的数据来帮助识别潜在故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-214">Be sure that monitoring systems are reliably reporting critical information and accurate data to help identify potential failures.</span></span>
- <span data-ttu-id="74da0-215">**在测试场景中包含第三方服务。**</span><span class="sxs-lookup"><span data-stu-id="74da0-215">**Include third-party services in test scenarios.**</span></span> <span data-ttu-id="74da0-216">除了测试恢复功能以外，还要测试第三方服务中断可能造成的故障点。</span><span class="sxs-lookup"><span data-stu-id="74da0-216">Test possible points of failure due to third-party service disruption, in addition to recovery.</span></span>

<span data-ttu-id="74da0-217">测试是一个迭代过程。</span><span class="sxs-lookup"><span data-stu-id="74da0-217">Testing is an iterative process.</span></span> <span data-ttu-id="74da0-218">需要测试应用程序、度量结果、分析并解决任何故障，并重复该流程。</span><span class="sxs-lookup"><span data-stu-id="74da0-218">Test the application, measure the outcome, analyze and address any failures, and repeat the process.</span></span>

<span data-ttu-id="74da0-219">有关测试应用程序可靠性的详细信息，请参阅[测试 Azure 应用程序的复原能力和可用性](./testing.md)。</span><span class="sxs-lookup"><span data-stu-id="74da0-219">For more information about testing for application reliability, see [Testing Azure applications for resiliency and availability](./testing.md).</span></span>

## <a name="deploy-the-application-consistently"></a><span data-ttu-id="74da0-220">以一致的方式部署应用程序</span><span class="sxs-lookup"><span data-stu-id="74da0-220">Deploy the application consistently</span></span>

<span data-ttu-id="74da0-221">部署包括预配 Azure 资源、部署应用程序代码和应用配置设置。</span><span class="sxs-lookup"><span data-stu-id="74da0-221">*Deployment* includes provisioning Azure resources, deploying application code, and applying configuration settings.</span></span> <span data-ttu-id="74da0-222">更新可能涉及到上述所有三个任务，或其中的一部分。</span><span class="sxs-lookup"><span data-stu-id="74da0-222">An update may involve all three tasks or a subset of them.</span></span>

<span data-ttu-id="74da0-223">将应用程序部署到生产环境后，更新操作就成了一个可能的出错来源。</span><span class="sxs-lookup"><span data-stu-id="74da0-223">After an application is deployed to production, updates are a possible source of errors.</span></span> <span data-ttu-id="74da0-224">使用可预测且可重复的部署过程来尽量减少错误。</span><span class="sxs-lookup"><span data-stu-id="74da0-224">Minimize errors with predictable and repeatable deployment processes.</span></span>

- <span data-ttu-id="74da0-225">**将应用程序部署流程自动化。**</span><span class="sxs-lookup"><span data-stu-id="74da0-225">**Automate your application deployment process.**</span></span> <span data-ttu-id="74da0-226">将尽可能多的流程自动化。</span><span class="sxs-lookup"><span data-stu-id="74da0-226">Automate as many processes as possible.</span></span>
- <span data-ttu-id="74da0-227">**设计发布流程以尽量提高可用性。**</span><span class="sxs-lookup"><span data-stu-id="74da0-227">**Design your release process to maximize availability.**</span></span> <span data-ttu-id="74da0-228">如果发布流程要求服务在部署期间脱机，应用程序只能在重新联机后才可用。</span><span class="sxs-lookup"><span data-stu-id="74da0-228">If your release process requires services to go offline during deployment, your application is unavailable until they come back online.</span></span> <span data-ttu-id="74da0-229">利用平台过渡和生产功能。</span><span class="sxs-lookup"><span data-stu-id="74da0-229">Take advantage of platform staging and production features.</span></span> <span data-ttu-id="74da0-230">使用蓝绿发布或 Canary 发布方法来部署更新，以便在失败时可以快速回滚更新。</span><span class="sxs-lookup"><span data-stu-id="74da0-230">Use blue-green or canary releases to deploy updates, so if a failure occurs, you can quickly roll back the update.</span></span>
- <span data-ttu-id="74da0-231">**为部署创建回滚计划。**</span><span class="sxs-lookup"><span data-stu-id="74da0-231">**Have a rollback plan for deployment.**</span></span> <span data-ttu-id="74da0-232">设计回滚流程，以便在发生部署失败时还原到上次已知正确的版本，并尽量减少停机时间。</span><span class="sxs-lookup"><span data-stu-id="74da0-232">Design a rollback process to return to a last known good version and to minimize downtime if a deployment fails.</span></span>
- <span data-ttu-id="74da0-233">**记录并审核部署。**</span><span class="sxs-lookup"><span data-stu-id="74da0-233">**Log and audit deployments.**</span></span> <span data-ttu-id="74da0-234">如果使用分阶段部署方法，则生产环境中会运行应用程序的多个版本。</span><span class="sxs-lookup"><span data-stu-id="74da0-234">If you use staged deployment techniques, more than one version of your application is running in production.</span></span> <span data-ttu-id="74da0-235">实施可靠的日志记录策略来尽量多地捕获版本特定的信息。</span><span class="sxs-lookup"><span data-stu-id="74da0-235">Implement a robust logging strategy to capture as much version-specific information as possible.</span></span>
- <span data-ttu-id="74da0-236">**阐述应用程序发布流程。**</span><span class="sxs-lookup"><span data-stu-id="74da0-236">**Document the application release process.**</span></span> <span data-ttu-id="74da0-237">明确定义和阐述发布过程，并确保将其提供给整个运营团队。</span><span class="sxs-lookup"><span data-stu-id="74da0-237">Clearly define and document your release process, and ensure that it's available to the entire operations team.</span></span>

<span data-ttu-id="74da0-238">有关应用程序可靠性和部署的详细信息，请参阅[部署具有复原能力和高可用性的 Azure 应用程序](./deploy.md)。</span><span class="sxs-lookup"><span data-stu-id="74da0-238">For more information about application reliability and deployment, see [Deploying Azure applications for resiliency and availability](./deploy.md).</span></span>

## <a name="monitor-application-health"></a><span data-ttu-id="74da0-239">监视应用程序运行状况</span><span class="sxs-lookup"><span data-stu-id="74da0-239">Monitor application health</span></span>

<span data-ttu-id="74da0-240">在应用程序中实施有关监视和警报的最佳做法，以便可以检测故障，并提醒操作员解决这些故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-240">Implement best practices for monitoring and alerts in your application so you can detect failures and alert an operator to fix them.</span></span>

- <span data-ttu-id="74da0-241">**实施运行状况探测和检查功能。**</span><span class="sxs-lookup"><span data-stu-id="74da0-241">**Implement health probes and check functions.**</span></span> <span data-ttu-id="74da0-242">在应用程序外部定期运行这些功能，以识别应用程序运行状况和性能下降的问题。</span><span class="sxs-lookup"><span data-stu-id="74da0-242">Run them regularly from outside the application to identify degradation of application health and performance.</span></span>
- <span data-ttu-id="74da0-243">**检查长时间运行的工作流。**</span><span class="sxs-lookup"><span data-stu-id="74da0-243">**Check long-running workflows.**</span></span> <span data-ttu-id="74da0-244">提前检测到问题可以尽量减少回滚整个工作流或执行多个补偿事务的需要。</span><span class="sxs-lookup"><span data-stu-id="74da0-244">Catching issues early can minimize the need to roll back the entire workflow or to execute multiple compensating transactions.</span></span>
- <span data-ttu-id="74da0-245">**维护应用程序日志。**</span><span class="sxs-lookup"><span data-stu-id="74da0-245">**Maintain application logs.**</span></span>

  - <span data-ttu-id="74da0-246">在生产环境在和服务边界处记录应用程序。</span><span class="sxs-lookup"><span data-stu-id="74da0-246">Log applications in production and at service boundaries.</span></span>
  - <span data-ttu-id="74da0-247">使用语义和异步日志记录。</span><span class="sxs-lookup"><span data-stu-id="74da0-247">Use semantic and asynchronous logging.</span></span>
  - <span data-ttu-id="74da0-248">将应用程序日志与审核日志区分开来。</span><span class="sxs-lookup"><span data-stu-id="74da0-248">Separate application logs from audit logs.</span></span>

- <span data-ttu-id="74da0-249">**度量远程调用统计信息，并与应用程序团队共享数据。**</span><span class="sxs-lookup"><span data-stu-id="74da0-249">**Measure remote call statistics, and share the data with the application team.**</span></span> <span data-ttu-id="74da0-250">为了让运营团队即时查看应用程序运行状况，请汇总远程调用指标，例如延迟、吞吐量，以及第 99 和 95 百分位的错误。</span><span class="sxs-lookup"><span data-stu-id="74da0-250">To give your operations team an instantaneous view into application health, summarize remote call metrics, such as latency, throughput, and errors in the 99 and 95 percentiles.</span></span> <span data-ttu-id="74da0-251">针对指标执行统计分析，以发现每个百分位中发生的错误。</span><span class="sxs-lookup"><span data-stu-id="74da0-251">Perform statistical analysis on the metrics to uncover errors that occur within each percentile.</span></span>
- <span data-ttu-id="74da0-252">**跟踪适当时间范围内的暂时性异常和重试次数。**</span><span class="sxs-lookup"><span data-stu-id="74da0-252">**Track transient exceptions and retries over an appropriate time frame.**</span></span> <span data-ttu-id="74da0-253">在一段时间内异常的增加趋势指示此服务有问题，并可能发生故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-253">A trend of increasing exceptions over time indicates that the service is having an issue and may fail.</span></span>
- <span data-ttu-id="74da0-254">**设置提前警告系统。**</span><span class="sxs-lookup"><span data-stu-id="74da0-254">**Set up an early warning system.**</span></span> <span data-ttu-id="74da0-255">识别应用程序运行状况的关键性能指标 (KPI)，例如暂时性异常和远程调用延迟，并为每个指标设置适当的阈值。</span><span class="sxs-lookup"><span data-stu-id="74da0-255">Identify the key performance indicators (KPIs) of an application's health, such as transient exceptions and remote call latency, and set appropriate threshold values for each of them.</span></span> <span data-ttu-id="74da0-256">达到阈值时，将警报发送到操作员。</span><span class="sxs-lookup"><span data-stu-id="74da0-256">Send an alert to operations when the threshold value is reached.</span></span>
- <span data-ttu-id="74da0-257">**在 Azure 订阅限制范围内操作**。</span><span class="sxs-lookup"><span data-stu-id="74da0-257">**Operate within Azure subscription limits.**</span></span> <span data-ttu-id="74da0-258">Azure 订阅限制特定的资源类型，例如资源组、核心和存储帐户的数目。</span><span class="sxs-lookup"><span data-stu-id="74da0-258">Azure subscriptions have limits on certain resource types, such as the number of resource groups, cores, and storage accounts.</span></span> <span data-ttu-id="74da0-259">监视资源类型的用法。</span><span class="sxs-lookup"><span data-stu-id="74da0-259">Watch your use of resource types.</span></span>
- <span data-ttu-id="74da0-260">**监视第三方服务。**</span><span class="sxs-lookup"><span data-stu-id="74da0-260">**Monitor third-party services.**</span></span> <span data-ttu-id="74da0-261">记录调用，并使用唯一标识符将其关联到应用程序的运行状况和诊断日志记录。</span><span class="sxs-lookup"><span data-stu-id="74da0-261">Log your invocations and correlate them with your application's health and diagnostic logging using a unique identifier.</span></span>
- <span data-ttu-id="74da0-262">**为多个操作员提供培训，使他们能够监视应用程序并执行手动恢复步骤。**</span><span class="sxs-lookup"><span data-stu-id="74da0-262">**Train multiple operators to monitor the application and to perform manual recovery steps.**</span></span> <span data-ttu-id="74da0-263">确保始终至少有一名经过培训的操作员在值勤。</span><span class="sxs-lookup"><span data-stu-id="74da0-263">Make sure there is always at least one trained operator active.</span></span>

<span data-ttu-id="74da0-264">有关监视应用程序可靠性的详细信息，请参阅[监视 Azure 应用程序运行状况](./monitoring.md)。</span><span class="sxs-lookup"><span data-stu-id="74da0-264">For more information about monitoring for application reliability, see [Monitoring Azure application health](./monitoring.md).</span></span>

## <a name="respond-to-failures-and-disasters"></a><span data-ttu-id="74da0-265">应对故障和灾难</span><span class="sxs-lookup"><span data-stu-id="74da0-265">Respond to failures and disasters</span></span>

<span data-ttu-id="74da0-266">创建恢复计划，确保其中涵盖了数据还原、网络中断、依赖服务故障和区域范围的服务中断。</span><span class="sxs-lookup"><span data-stu-id="74da0-266">Create a recovery plan, and make sure that it covers data restoration, network outages, dependent service failures, and region-wide service disruptions.</span></span> <span data-ttu-id="74da0-267">在恢复策略中考虑到 VM、存储、数据库和其他 Azure 平台服务。</span><span class="sxs-lookup"><span data-stu-id="74da0-267">Consider your VMs, storage, databases, and other Azure platform services in your recovery strategy.</span></span>

- <span data-ttu-id="74da0-268">**规划 Azure 支持交互。**</span><span class="sxs-lookup"><span data-stu-id="74da0-268">**Plan for Azure support interactions.**</span></span> <span data-ttu-id="74da0-269">在需求出现之前，请建立有关联系 Azure 支持部门的流程。</span><span class="sxs-lookup"><span data-stu-id="74da0-269">Before the need arises, establish a process for contacting Azure support.</span></span>
- <span data-ttu-id="74da0-270">**阐述并测试灾难恢复计划。**</span><span class="sxs-lookup"><span data-stu-id="74da0-270">**Document and test your disaster recovery plan.**</span></span> <span data-ttu-id="74da0-271">编写一个灾难恢复计划来反映应用程序故障对业务造成的影响。</span><span class="sxs-lookup"><span data-stu-id="74da0-271">Write a disaster recovery plan that reflects the business impact of application failures.</span></span> <span data-ttu-id="74da0-272">尽可能地将恢复流程自动化，并阐述任何手动步骤。</span><span class="sxs-lookup"><span data-stu-id="74da0-272">Automate the recovery process as much as possible, and document any manual steps.</span></span> <span data-ttu-id="74da0-273">定期测试灾难恢复过程，以验证并改进计划。</span><span class="sxs-lookup"><span data-stu-id="74da0-273">Regularly test your disaster recovery process to validate and improve the plan.</span></span>
- <span data-ttu-id="74da0-274">**根据需要手动故障转移。**</span><span class="sxs-lookup"><span data-stu-id="74da0-274">**Fail over manually when required.**</span></span> <span data-ttu-id="74da0-275">某些系统无法自动故障转移，需要手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="74da0-275">Some systems can't fail over automatically and require a manual failover.</span></span> <span data-ttu-id="74da0-276">如果应用程序故障转移到次要区域，请执行操作就绪性测试。</span><span class="sxs-lookup"><span data-stu-id="74da0-276">If an application fails over to a secondary region, perform an operational readiness test.</span></span> <span data-ttu-id="74da0-277">故障回复之前，请验证主要区域是否正常，并可以再次接收流量。</span><span class="sxs-lookup"><span data-stu-id="74da0-277">Verify that the primary region is healthy and ready to receive traffic again before failing back.</span></span> <span data-ttu-id="74da0-278">确定有哪些应用程序功能减弱，以及应用如何告知用户出现了暂时性问题。</span><span class="sxs-lookup"><span data-stu-id="74da0-278">Determine what the reduced application functionality is and how the app informs users of temporary problems.</span></span>
- <span data-ttu-id="74da0-279">**针对应用程序故障做好准备。**</span><span class="sxs-lookup"><span data-stu-id="74da0-279">**Prepare for application failure.**</span></span> <span data-ttu-id="74da0-280">准备好应对一系列故障，包括系统自动处理的故障、导致功能减弱的故障，以及导致应用程序不可用的故障。</span><span class="sxs-lookup"><span data-stu-id="74da0-280">Prepare for a range of failures, including faults that are handled automatically, those that result in reduced functionality, and those that cause the application to become unavailable.</span></span> <span data-ttu-id="74da0-281">应用程序应该告知用户出现了暂时性问题。</span><span class="sxs-lookup"><span data-stu-id="74da0-281">The application should inform users of temporary issues.</span></span>
- <span data-ttu-id="74da0-282">**数据损坏后进行恢复。**</span><span class="sxs-lookup"><span data-stu-id="74da0-282">**Recover from data corruption.**</span></span> <span data-ttu-id="74da0-283">如果数据存储发生故障，请在该存储再次可用后检查数据不一致情况，尤其是数据是复制过来的情况下。</span><span class="sxs-lookup"><span data-stu-id="74da0-283">If a failure happens in a data store, check for data inconsistencies when the store becomes available again, especially if the data was replicated.</span></span> <span data-ttu-id="74da0-284">从备份还原已损坏的数据。</span><span class="sxs-lookup"><span data-stu-id="74da0-284">Restore corrupt data from a backup.</span></span>
- <span data-ttu-id="74da0-285">**网络中断后进行恢复。**</span><span class="sxs-lookup"><span data-stu-id="74da0-285">**Recover from a network outage.**</span></span> <span data-ttu-id="74da0-286">你也许可以使用缓存的数据在本地运行应用程序，但应用程序的功能会减弱。</span><span class="sxs-lookup"><span data-stu-id="74da0-286">You might be able to use cached data to run locally with reduced application functionality.</span></span> <span data-ttu-id="74da0-287">否则，请考虑关闭应用程序，或故障转移到另一个区域。</span><span class="sxs-lookup"><span data-stu-id="74da0-287">If not, consider application downtime or fail over to another region.</span></span> <span data-ttu-id="74da0-288">将数据存储在备用位置，直到连接恢复。</span><span class="sxs-lookup"><span data-stu-id="74da0-288">Store your data in an alternate location until connectivity is restored.</span></span>
- <span data-ttu-id="74da0-289">**发生依赖服务故障后进行恢复。**</span><span class="sxs-lookup"><span data-stu-id="74da0-289">**Recover from a dependent service failure.**</span></span> <span data-ttu-id="74da0-290">确定哪些功能仍然可用，以及应用程序如何做出响应。</span><span class="sxs-lookup"><span data-stu-id="74da0-290">Determine which functionality is still available and how the application should respond.</span></span>
- <span data-ttu-id="74da0-291">**发生区域范围的服务中断后进行恢复。**</span><span class="sxs-lookup"><span data-stu-id="74da0-291">**Recover from a region-wide service disruption.**</span></span> <span data-ttu-id="74da0-292">区域范围的服务中断并不常见，但你应该制定一个策略来应对此类问题，尤其是针对关键应用程序。</span><span class="sxs-lookup"><span data-stu-id="74da0-292">Region-wide service disruptions are uncommon, but you should have a strategy to address them, especially for critical applications.</span></span> <span data-ttu-id="74da0-293">你也许可以将应用程序重新部署到另一个区域，或重新分发流量。</span><span class="sxs-lookup"><span data-stu-id="74da0-293">You might be able to redeploy the application to another region or redistribute traffic.</span></span>

<span data-ttu-id="74da0-294">有关应对故障和灾难恢复的详细信息，请参阅 [Azure 应用程序的故障和灾难恢复](./disaster-recovery.md)。</span><span class="sxs-lookup"><span data-stu-id="74da0-294">For more information about responding to failures and disaster recovery, see [Failure and disaster recovery for Azure applications](./disaster-recovery.md).</span></span>

## <a name="next-steps"></a><span data-ttu-id="74da0-295">后续步骤</span><span class="sxs-lookup"><span data-stu-id="74da0-295">Next steps</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="74da0-296">制定可复原应用程序的要求</span><span class="sxs-lookup"><span data-stu-id="74da0-296">Develop requirements for resilient applications</span></span>](./requirements.md)
