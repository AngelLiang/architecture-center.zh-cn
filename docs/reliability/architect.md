---
title: 构建 Azure 应用程序的弹性和可用性
description: 将复原能力和可用性内置于 Azure 应用程序
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.openlocfilehash: ee4bb5b4a85e48fe0ff017297c31823c93a48f04
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59646496"
---
# <a name="architecting-azure-applications-for-resiliency-and-availability"></a>构建 Azure 应用程序的弹性和可用性

已为你的应用程序开发要求后下, 一步是将复原能力和可用性内置于它。 不能在末尾添加这些质量&mdash;必须与体系结构设计。

## <a name="conduct-a-failure-mode-analysis"></a>执行故障模式分析

*故障模式分析*(FMA) 生成到系统通过标识可能的故障点并定义应用程序如何响应这些故障的复原能力。 FMA 应该是体系结构和设计阶段的一部分，因此故障恢复内置于系统从一开始。 FMA 的目标是：

- 确定哪些类型的故障可能会遇到应用程序和应用程序如何检测这些故障。
- 捕获每种类型的失败的潜在影响，并确定应用如何响应。
- 规划日志记录和监视故障和确定恢复策略。

下面是故障模式和特定的故障点的检测策略的一些示例&mdash;对外部 web 服务的调用：

| 故障模式           | 检测策略           |
|------------------------|------------------------------|
| 服务不可用 | HTTP 5xx                     |
| 限制             | HTTP 429（请求过多） |
| Authentication         | HTTP 401（未授权）      |
| 响应速度慢          | 请求超时            |

有关 FMA 过程，使用适用于 Azure，具体的建议的详细信息请参阅[故障模式分析](../resiliency/failure-mode-analysis.md)。

## <a name="plan-for-redundancy"></a>计划以确保冗余

故障的影响范围中会有所不同。 某些硬件故障，例如磁盘故障影响单个主机计算机。 网络交换机故障可能会影响整个服务器机架。 不太常见的故障，如断电，会中断整个数据中心。 很少，整个区域变得不可用。

冗余是使应用程序的可复原的一种方法。 冗余级别取决于你的业务要求&mdash;不是每个应用程序需要跨区域以防范区域性服务中断的冗余。 一般情况下，没有更高冗余和可靠性更高的成本和复杂性之间做出取舍。

### <a name="review-azure-redundancy-features"></a>查看 Azure 冗余功能

Azure 在每个级别的故障，从整个区域的单个虚拟机 (VM) 具有许多冗余功能。

- **单个 Vm 也**具有[正常运行时间服务级别协议 (SLA)](https://azure.microsoft.com/support/legal/sla/virtual-machines) Azure 提供的。 （该 VM 必须使用高级存储的所有操作系统磁盘和数据磁盘。）尽管可以通过运行两个或更多个 VM 来获得更高的 SLA，则对于某些工作负荷而言，单个 VM 可能已足够可靠。 但是，对于生产工作负荷，我们建议使用两个或更多个 VM 来实现冗余。
- **可用性集**防止局部的硬件故障，如磁盘或网络交换机故障。 在可用性集中的 Vm 分布在最多三个*容错域*。 容错域定义一的组共享公共电源和网络交换机的 Vm。 如果发生硬件故障影响一个容错域，则会将网络流量路由到其他容错域中的 Vm。 有关可用性集的详细信息，请参阅[管理 Azure 中 Windows 虚拟机的可用性](/azure/virtual-machines/windows/manage-availability)。
- **可用性区域**是 Azure 区域中物理上独立的区域。 每个可用性区域有独立的电源、网络和散热设备。 跨可用性区域部署 Vm 有助于保护对数据中心级故障的应用程序。 并非所有地区都支持可用性区域。 如需支持的地区和服务的列表，请参阅 [Azure 中的可用性区域是什么？](/azure/availability-zones/az-overview)。

    如果您打算在部署中使用可用性区域，首先验证的应用程序体系结构和代码库支持此配置。 如果您部署商用软件，请咨询软件供应商和部署到生产环境之前进行充分测试。 应用程序必须保持的状态，并在中配置的区域发生服务中断过程中防止数据丢失。 应用程序必须支持在具有任何硬编码的基础结构组件的弹性和分布式基础结构中运行。
- **Azure Site Recovery**复制 Azure 虚拟机连接到另一个 Azure 区域 (BC) 的业务连续性和灾难恢复 (DR) 需求。 您可以执行定期的 DR 演练以确保操作满足符合性需求。 以便恢复你的应用程序发生故障源区域中时，将使用的指定设置应用到所选区域复制 VM。 有关详细信息，请参阅[为 Azure vm 设置到辅助 Azure 区域的灾难恢复](/azure/site-recovery/azure-to-azure-quickstart/)。

    在测试期间，验证是否*恢复时间目标*(RTO) 和*恢复点目标*(RPO) 满足你的需求。 RTO 是某个事件后，应用程序是不可用的最长时间和 RPO 是指发生灾难期间的数据丢失的最大持续时间。
- **配对区域**使用 Azure 流量管理器将 Internet 流量分发到不同区域时，保护应用程序免受区域性服务中断时创建的。 每个 Azure 区域与另一个区域配对。 在一起，这些区域构成[*区域对*](/azure/best-practices-availability-paired-regions)。 以符合税务和执法管辖的数据驻留要求，区域对位于相同的地理位置 （巴西南部除外）。

    若要提高应用程序复原能力，Azure 将序列化为平台更新 （计划内维护） 跨每个区域对，因此，只有一个配对的区域更新一次。
- 在设计多区域应用程序时，请考虑在区域之间的网络延迟高于区域内。 例如，如果复制数据库启用故障转移时，在区域内的同步数据复制，但异步数据复制在区域中使用。

下表比较了跨多个复原策略的冗余因素：

| &nbsp; | 可用性集 | 可用性区域 | Azure 站点恢复/配对区域 |
|--------|------------------|-------------------|-----------------------------------|
| 故障范围 | 机架                  | 数据中心               | 区域                               |
| 请求路由  | Azure 负载均衡器   | 跨区域负载均衡器 | Azure 流量管理器                |
| 网络延迟  | 极低              | 低                      | 中到高                          |
| 虚拟网络  | Azure 虚拟网络 | Azure 虚拟网络          | 跨区域虚拟网络对等互连 |

### <a name="complete-azure-redundancy-tasks"></a>完成 Azure 冗余任务

使用以下任务来满足冗余要求：

- **部署服务的多个实例。** 如果应用程序依赖于服务的单个实例，则会造成单一故障点。 预配多个实例能够提高复原能力和可伸缩性。 对于 [Azure 应用服务](/azure/app-service/app-service-value-prop-what-is/)，请选择提供多个实例的[应用服务计划](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)。 有关[Azure 虚拟机](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)，确保您的体系结构具有多个 VM，并且，每个 VM 包含在[可用性集](/azure/virtual-machines/virtual-machines-windows-manage-availability/)。

- **使用 Azure Site Recovery 复制 VM。** 使用 Azure 虚拟机的复制时间[Site Recovery](/azure/site-recovery/)，所有 VM 磁盘会持续都复制到目标区域以异步方式。 恢复点创建每隔几分钟，让几分钟 RPO。

- **考虑跨多个区域部署应用程序。** 如果你的应用程序部署到单个区域和区域变得不可用，你的应用程序也将不可用。 根据应用程序的 SLA 条款，这种情况可能不可接受。 为此，请考虑跨多个区域部署应用程序及其服务。 多区域部署可以使用*主动-主动*或*主动-被动*配置。 主动-主动配置将请求分配跨多个活动的区域。 主动-被动配置将热实例保留在次要区域中，但存在不会发送流量，除非主要区域发生故障。 对于多区域部署，我们建议将部署到配对的区域，上面所述。 有关详细信息，请参阅[业务连续性和灾难恢复 (BCDR)：Azure 配对区域](/azure/best-practices-availability-paired-regions)。

- **使用 Azure 流量管理器将应用程序的流量路由到不同的区域。** [Azure 流量管理器](/azure/traffic-manager/traffic-manager-overview/)在 DNS 级别之间进行负载平衡并将流量路由到基于不同的区域[流量路由](/azure/traffic-manager/traffic-manager-routing-methods/)方法和应用程序的终结点的运行状况。 无需流量管理器中，你被限制为单个区域为你的部署，后者限制规模、 会增加延迟时间为一些用户，并会导致应用程序停机时间，在区域范围的服务中断的情况下。

- **Azure 应用程序网关配置为使用多个实例。** 根据应用程序的要求，[Azure 应用程序网关](/azure/application-gateway/application-gateway-introduction/)可能更适合用于将请求分发到应用程序的服务。 但是，在 sla 中，因此很可能你的应用程序可能会失败，如果应用程序网关实例失败不保证应用程序网关服务的单一实例。 预配多个中型或大型实例，以保证的条款下的服务的可用性[应用程序网关 SLA](https://azure.microsoft.com/support/legal/sla/application-gateway/)。

## <a name="design-for-scalability"></a>可伸缩性设计

*可伸缩性*是一个系统能够处理增加的负载，而是一个[软件质量的构成要素](../guide/pillars.md)。 在构建阶段的可伸缩性任务包括：

- **分区工作负荷。** 将流程的各部分设计为相互独立且可以分解。 最小化每个部分的大小。 这样，组件的各部分用于最大化利用每个计算单元的方式进行分布。 此外，可以更方便地缩放应用程序（只需添加特定资源的更多实例即可）。 对于复杂的域，请考虑采用[微服务体系结构](../guide/architecture-styles/microservices.md)。
- **针对缩放进行设计。** 缩放，应用程序可以响应负载的增加和减少的角色、 队列和其他服务实例数。 但是，应用程序在设计时必须充分考虑这一点。 例如，应用程序和其使用的服务必须是无状态，以允许将请求路由到任何实例。 无状态服务还意味着，添加或删除实例不会产生负面影响当前用户。
- **规划与缩放单位的增长。** 对于每个资源，知道缩放上限，并使用分片或分解方式来应对这些限制。 设计应用程序时，应确保其能够轻松地通过添加一个或多个缩放单元来进行缩放。 按照定义好的资源集来确定系统的缩放单元。 这会使应用横向扩展操作更加容易，不容易到整个系统的某些部分缺乏资源导致的负面影响。 例如，添加*X*前端的 Vm 数目可能会要求*Y*额外的队列的数目和*Z*编号的存储帐户来处理额外的工作负荷。 因此缩放单位可能包含的*X* VM 实例*Y*队列，并*Z*存储帐户。
- **避免客户端关联。** 如有可能，应确保应用程序不需要关联。 然后将请求路由到任何实例，与实例的数目无关。 这样还可以避免为每个用户存储、检索和维护状态信息的开销。
- **充分利用平台自动缩放功能。** 使用内置自动缩放功能，如果可能，而不是自定义或第三方机制。 使用计划的缩放规则，如果可能，以确保资源则无需启动延迟，但将被动自动缩放添加到规则中，在适当的位置，以应对意外的需求变化。 有关详细信息，请参阅[自动缩放指南](../best-practices/auto-scaling.md)。  

  如果你的应用程序未配置为随着负载的增加而自动横向扩展，就可以，如果它们变得满用户请求，应用程序的服务将失败。 有关详细信息，请参阅以下文章：

  - 常规：[伸缩性清单](../checklist/scalability.md)
  - Azure 应用服务：[手动或自动缩放实例计数](/azure/monitoring-and-diagnostics/insights-how-to-scale/)
  - 云服务：[如何自动缩放云服务](/azure/cloud-services/cloud-services-how-to-scale/)
  - 虚拟机：[自动缩放和虚拟机规模集](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview/)

- **卸载密集型 CPU/IO 任务作为后台任务。** 如果对服务请求预计需要花费很长时间才能运行，或可能会吸收大量的资源，将处理卸载到单独的任务。 使用后台作业来执行这些任务。 此策略允许服务继续接收更多的请求，并且可保持响应状态。 有关详细信息，请参阅[后台作业指南](../best-practices/background-jobs.md)。
- **分发后台任务的工作负载。** 如果有多个后台任务或任务需要相当长的时间或资源，请将工作分摊到多个计算单元。 如需一种可能的解决方案，请参阅[使用者竞争模式](../patterns/competing-consumers.md)。
- **请考虑将实现*无共享双*体系结构。** 此体系结构使用独立的独立节点具有单点 （例如共享的服务或存储） 的争用。 从理论上讲，此类系统几乎可以无限地进行扩展。 虽然完全的非共享方法通常是不可行的但它可能会提供更好的可伸缩性设计的机会。 移动到共享式体系结构的很好的示例包括对数据进行分区和避免使用服务器端会话状态和客户端相关性。
- **设计应用程序的存储要求，以在 Azure 存储可伸缩性和性能目标内。** Azure 存储可在预定义的可伸缩性和性能目标函数中，因此设计应用程序以使用这些目标内的存储。 如果你超出这些目标，你的应用程序会受到存储限制。 若要避免限制，预配其他存储帐户。 如果达到存储帐户的上限，预配其他 Azure 订阅，然后预配那里其他存储帐户。 有关详细信息，请参阅 [Azure 存储可伸缩性和性能目标](/azure/storage/storage-scalability-targets/)。
- **为应用程序选择适当的 VM 大小。** 测量实际 CPU、 内存、 磁盘和 I/O 在生产中，Vm，并验证已选择的 VM 大小足够。 如果不足，当 VM 接近其限制时，应用程序可能遇到容量问题。 [Azure 中虚拟机的大小](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)中详细介绍了 VM 大小。

## <a name="determine-subscription-and-service-requirements"></a>确定订阅和服务的要求

通过完成这些任务选择正确的订阅和您的应用程序的服务功能：

- **评估要求针对[Azure 订阅和服务限制](/azure/azure-subscription-service-limits/)。** *Azure 订阅*对特定的资源类型，例如资源组、 内核数和存储帐户的数目有限制。 如果应用程序的要求超过 Azure 订阅限制，请创建另一个 Azure 订阅并预配足够的资源。 每个 Azure 服务存在消耗量限制 &mdash; 例如，存储、吞吐量、连接、每秒请求数和其他指标的限制。 如果它尝试使用的资源超过这些限制，这样会导致受影响的用户的服务限制，并可能停机，你的应用程序将失败。 根据特定服务和应用程序的需求，您常常可以避免这些限制通过纵向扩展 （例如，选择另一个定价层） 或向外扩展 （如添加新的实例）。
- **确定需要多少个存储帐户。** Azure 允许特定数量的每个订阅的存储帐户。 有关详细信息，请参阅 [Azure 订阅和服务限制、配额与约束](/azure/azure-subscription-service-limits/#storage-limits)。
- **为 Azure SQL 数据库选择适当的服务层。** 如果你的应用程序使用 Azure SQL 数据库，选择适当的服务层。 如果层不能处理应用程序的数据库事务单位 (DTU) 要求，你的数据的使用将受到限制。 有关如何选择正确服务计划的详细信息，请参阅 [SQL 数据库选项和性能：了解每个服务层提供的功能](/azure/sql-database/sql-database-service-tiers/)。
- **预配 Azure Cosmos DB 中的足够请求单位 (Ru)**。 使用 Azure Cosmos DB 时，需要支付预配的吞吐量和每小时消耗的存储的费用。 所有数据库操作的成本规范化为 Ru，该抽象的系统资源，例如 CPU、 IOPS 和内存。 有关详细信息，请参阅 [Azure Cosmos DB 中的请求单位](/azure/cosmos-db/request-units)。

## <a name="load-balance-as-needed"></a>负载平衡根据需要

正确的负载均衡允许您以满足可用性要求以及与可用性相关的成本降至最低。

- **使用负载均衡分发请求。** 负载平衡应用程序将请求分布到正常的服务实例从轮转中删除不正常的实例。 如果你的服务使用 Azure 应用服务或 Azure 云服务，则表示已为你的负载平衡。 但是，如果你的应用程序使用 Azure Vm，需要预配负载均衡器。 有关详细信息，请参阅[什么是 Azure 负载均衡器？](/azure/load-balancer/load-balancer-overview/)

  使用 Azure 负载均衡器可以：

  - 对 Vm 进行负载平衡传入 Internet 流量。 此配置称为[*公共负载均衡器*](/azure/load-balancer/load-balancer-overview#publicloadbalancer)。
  - 对虚拟网络中 VM 之间的流量进行负载均衡。 还可以在混合方案中从本地网络访问负载均衡器前端。 这两种方案使用的配置，称为[*内部负载均衡器*](/azure/load-balancer/load-balancer-overview#internalloadbalancer)。
  - 端口流量转发到特定 Vm 的入站的网络地址转换 (NAT) 规则上的各端口。
  - 使用公共负载均衡器为虚拟网络中的 VM 提供[出站连接](/azure/load-balancer/load-balancer-outbound-connections)。

- **平衡跨区域使用流量管理器，如 Azure 流量管理器的负载。** 跨区域的流量进行负载平衡需要使用流量管理解决方案，以及 Azure 提供了[流量管理器](https://azure.microsoft.com/services/traffic-manager/)。 您还可以利用提供类似的流量管理功能的第三方服务。

## <a name="implement-resiliency-strategies"></a>实施复原策略

本部分介绍一些常见复原策略。 大多数这些策略并不局限于特定的技术。 说明汇总了每种技术背后的一般理念和包括更多参考资料的链接。

- **实现复原模式**为远程操作，在适当的位置。 如果你的应用程序依赖于远程服务之间的通信，请按照[的设计模式](../patterns/category/resiliency.md)来处理暂时性故障。

- **重试暂时性故障。** 这些可能被引起瞬间断开网络连接、 删除了数据库连接或超时当服务繁忙时。 通常情况下，可以通过重试请求解决暂时性故障。

  - 对于许多 Azure 服务，客户端软件开发工具包 (SDK) 中对调用方是透明的方式实施自动重试。 请参阅[重试的特定服务的指南](../best-practices/retry-service-specific.md)。
  - 或实现[重试模式](../patterns/retry.md)以帮助应用程序尝试连接到服务或网络资源时以透明方式处理预期的临时故障。

- **使用断路器**来处理这些可能需要变量长的时间，若要修复的错误。 [断路器模式](../patterns/circuit-breaker.md)可以防止应用程序重复尝试的操作，则可能会失败。 断路器会包装对服务的调用，并跟踪最近发生故障的次数。 如果故障计数超过阈值，断路器将开始返回错误代码而不会调用该服务。 这使得服务有时间恢复，并有助于避免级联故障。
- **隔离关键资源。** 一个子系统发生故障有时会造成连锁反应，导致应用程序的其他部分中的失败。 如果故障防止资源，例如线程或套接字被释放，从而导致资源耗尽，则可能发生此问题。 若要避免此问题，您可以将系统分区为独立的组，以便一个分区中的故障不会导致整个系统瘫痪。

    下面是一些示例的这一技术，有时称为[隔舱模式](../patterns/bulkhead.md):

  - 分区数据库 （例如，由租户中），并将分配一个单独的池的 web 服务器实例的每个分区。
  - 使用单独的线程池来隔离对不同服务发出的调用。 这有助于防止其中一个服务发生故障时出现连发故障。 有关示例，请参阅 Netflix [Hystrix 库](https://medium.com/netflix-techblog/introducing-hystrix-for-resiliency-engineering-13531c1ab362)。
  - 使用[容器](https://en.wikipedia.org/wiki/Operating-system-level_virtualization)来限制特定子系统可用的资源。

      ![隔舱模式图](_images/bulkhead.png)

- **将应用[*补偿事务*](../patterns/compensating-transaction.md)**。 补偿事务是用于消除另一个已完成的事务所造成的影响的事务。 在分布式系统中，它可能很难实现事务强一致性。 补偿事务有助于实现一致性使用一系列的较小的独立事务，可以撤消在每个步骤。 例如，若要预订行程，客户可能需要预约租车、客房和航班。 如果其中一个步骤失败，则整个操作失败。 我们可以针对每个步骤定义一个补偿事务，而不用尝试对整个操作使用单个分布式事务。
- **实现异步操作，只要有可能。** 同步操作可能会独占资源，并在调用方等待进程完成时阻塞其他操作。 设计应用程序以允许在异步操作，只要有可能的每个部分。 有关如何在 C 中实现异步编程的详细信息\#，请参阅[异步编程](/dotnet/articles/csharp/async)。

## <a name="ensure-that-availability-meets-slas"></a>确保可用性，满足服务级别协议

*可用性*是一个系统且操作正常工作的时间比例，最好之一[软件质量的构成要素](../guide/pillars.md)。 使用在本部分中的任务，以查看应用程序体系结构从可用性角度来看，确保你的可用性满足你的 Sla。

- **避免任何单点故障。** 为避免单点故障影响可用性，应该将所有组件、服务、资源和计算实例部署为多个实例。 身份验证机制也可以是单一故障点。 如果平台自动执行此操作不是可配置为使用多个实例和要自动检测故障并将请求重定向到未失败的实例，将应用程序设计。
- **根据服务级别目标解构工作负荷。** 如果服务由重要和比较不重要的工作负荷组成，请以不同的方式进行管理，并指定服务功能和实例数，以符合其可用性要求。
- **最小化和了解服务依赖项。** 可能的位置使用的不同服务的数量降至最低。 请确保您理解所有功能和服务依赖关系的系统中存在。 具体而言，了解故障或每个依赖项中的性能降低的整体影响。
- **将任务和消息设计*幂等*，在可能的情况。** 如果某个操作可以重复多次且生成相同的结果，则该操作是幂等的。 这可以确保重复的请求不会导致问题。 消息使用者与它们执行的操作应该具有幂等性，以便重复以前执行的操作不会使结果无效。 这可能意味着检测重复消息或使用乐观方法来处理冲突以确保一致性。
- **配置请求超时。** 服务和资源可能会变为不可用，导致请求失败。 确保应用的超时适合每个服务或资源并且客户端，正访问它们。 在某些情况下，可能需要根据客户端正在执行的上下文和其他操作，对特定的客户端实例允许较长的超时。 较短的超时可能会导致服务和较长延迟的资源的过多的重试操作。 长的超时可能会导致阻塞，如果大量的请求正在排队等待服务或资源做出响应。
- **使用消息代理来为重要事务实现高可用性。** 许多云应用程序使用消息传递来触发异步任务。 若要保证传送消息，消息传送系统应提供高可用性。 [Azure 服务总线消息传送](/azure/service-bus-messaging)实现*至少一次*语义，这意味着，保证消息至少一次传递。 某些情况下，可能会发送重复的消息。 如果消息处理是幂等的（请参阅前一项），则重复传送应该不是问题。
- **限制高访问量用户。** 有时，少量的用户创建的负载过多。 这可能会影响对其他用户，并会降低您的应用程序的总体可用性。 当单个客户端发出请求的次数过多时，应用程序可能会在特定期限内限制该客户端。 在限制期间，应用程序会部分或全部请求拒绝来自该客户端。 限制阈值通常取决于客户的服务层。 有关详细信息，请参阅[限制模式](../patterns/throttling.md)。

    限制并不意味着，客户端一定恶意&mdash;只表示它超出了其服务配额。 在某些情况下，使用者可能一贯地超出其配额或行为异常。 在此情况下，可以进一步阻止该用户。 为此，通常可以阻止其 API 密钥或 IP 地址范围。
- **将应用程序设计为可正常降级。** 应用程序上的负载可能超出一个或多个部件的容量，导致降低可用性和连接失败。 缩放可以缓解此问题，但它可能会达到资源可用性或成本等其他因素施加的限制。 当应用程序达到资源限制时，应采取适当的措施来尽量减小对用户的影响。 例如，在电子商务系统中，如果订单处理子系统处于疲劳或发生故障，它可以暂时禁用同时允许其他功能，例如浏览产品目录。 它可能适合延后发出的请求对故障子系统&mdash;等仍允许客户提交订单，但是对于更高版本的处理，当在订单子系统再次可用时。
- **适当处理急剧突发事件。** 大多数应用程序需要在不同的时间处理不同的工作负荷。 自动缩放有助于处理负载，但它可能需要一些时间使其他实例联机并处理请求。 若要防止高峰活动的应用程序，设计为将使用的服务和队列即将容量时适当降级请求队列。 请确保有足够的性能和容量可在非高峰条件清空队列和处理未完成的请求。 有关详细信息，请参阅[基于队列的负载调节模式](../patterns/queue-based-load-leveling.md)。
- **组建或故障回复到多个组件。** 设计应用程序使用多个实例且不影响操作和现有连接，在可能的情况。 若要最大化可用性、 使用多个实例并将它们之间的请求和检测和避免将请求发送到失败的实例。
- **故障回复到不同的服务或工作流。** 例如，如果写入 SQL 数据库失败，请暂时将数据存储在 Blob 存储或 Redis 缓存。 提供某种途径方便在服务可用时将数据重新写入 SQL 数据库。 在某些情况下，失败的操作可能有替代操作允许应用程序可继续工作，即使组件或服务失败时。 如果可能，请检测故障并将请求重定向到其他服务，主服务处于脱机状态时。
- **使用负载调控来平缓流量高峰。** 应用程序可能会遇到突发高峰流量，在后端的服务瘫痪。 如果后端服务无法足够快的速度响应请求，可能会累积过挂起的请求或服务可能会限制应用程序。 为了避免此问题，可以使用队列作为缓冲区。 新工作项，而不是立即调用后端服务时应用程序队列工作项以异步方式运行。 队列充当可平缓负载高峰的缓冲区。 有关详细信息，请参阅[基于队列的负载调节模式](../patterns/queue-based-load-leveling.md)。

## <a name="manage-your-data"></a>管理你的数据

如何管理你的数据起着直接在应用程序的可用性。 在本部分中的任务可以帮助您创建了管理计划，以帮助确保可用性。

- **复制数据，并了解应用程序的数据存储的复制方法。** 复制数据是处理数据存储中非暂时性故障的常规策略。 请考虑读取和写入路径。 具体取决于存储技术，可能有多个可写副本或可能具有单个可写副本和多个只读副本。 为了最大程度地提高可用性，可将副本放在多个区域。 但是，此方法会在复制数据时增加延迟时间。 跨区域复制通常是以异步方式执行的，这意味着，如果某个副本发生故障，将无法遵循最终一致性模型，并可能会丢失数据。  

  可以使用[Azure Site Recovery](/azure/site-recovery/azure-to-azure-quickstart/)若要将 Azure 虚拟机从一个区域复制到另一个。 Site Recovery 将向目标区域持续复制数据。 当在主站点发生中断时，可以故障转移到辅助位置。

- **确保没有任何用户帐户同时有权访问生产和备份数据。** 如果单个用户帐户同时有权写入生产和备份源，则将会透露数据备份。 恶意用户可能有意删除所有数据，和普通用户可能意外都删除。 应用程序设计为限制每个用户帐户的权限。 仅向需要这样做，用户授予写访问权限并授予对生产或备份，但不是能同时访问。
- **文档和测试数据存储故障转移和故障回复过程。** 如果数据存储区失败灾难性的人工操作员必须遵循一组有案可稽的指令将故障转移到新的数据存储。 如果有案可稽的步骤存在错误，操作员不能成功遵循它们并故障转移资源。 定期测试说明步骤，以验证遵循文档运算符可以成功故障转移和故障回复。
- **备份数据并验证你的数据的备份。** 定期运行一个脚本来验证数据完整性、 架构和查询，以确保备份数据符合预期。 记录并报告任何不一致情况，以便能够修复备份服务。
- **使用定期备份和时间点还原。** 定期和自动备份不会保留其他位置的数据。 验证您能够可靠地恢复数据和应用程序本身是否发生故障。 请确保备份符合你的 RPO。 数据复制并不是备份功能，因为人为错误或恶意操作可能损坏所有副本中的数据。 备份过程必须是安全的，这样才能保护传输中和存储中的数据。 数据库可以通常恢复到以前的点在时间中使用事务日志。 有关详细信息，请参阅[从数据损坏或意外删除中恢复](../resiliency/recovery-data-corruption.md)。
- **请考虑使用异地冗余存储帐户。** Azure 存储帐户中存储的数据始终在本地复制。 但是，有多个复制策略可供选择时预配的存储帐户。 若要保护应用程序数据免受极少数情况下，当整个区域不可用时，请选择[Azure 读取访问异地冗余存储 (RA-GRS)](/azure/storage/storage-redundancy/#read-access-geo-redundant-storage)。  

    > [!NOTE]
    > 对于 VM，请不要依赖于 RA-GRS 复制来还原 VM 磁盘（VHD 文件）， 而应该使用 [Azure 备份](/azure/backup)。

- **请考虑将引用数据部署到多个区域。** 引用数据是支持应用程序功能的只读数据。 它通常不经常更改。 尽管从备份中还原是处理区域范围的服务中断的一种方法，但 RTO 是相对较长。 将应用程序部署到次要区域后，有一些策略可改进引用数据的 RTO。

    由于引用数据更改很少，因此可以通过维护次要区域中的永久副本，缩短 RTO。 这样就无需在发生灾难后还原备份的时间。 要满足多区域灾难恢复要求，必须将应用程序和引用数据一起部署到多个区域。

- **使用乐观并发和最终一致性。** 通过锁定资源访问的块的事务 (*保守式并发*) 可能会导致性能不佳并降低可用性。 这些问题在分布式系统中可能会变得特别严重。 在许多情况下，精心的设计和技术，例如分区、 可以尽量减少发生更新冲突的可能性。 如果复制或从独立更新的存储中读取数据，数据只会保持最终一致性。 但的优势通常超过使用事务来确保即时一致性的可用性的影响。
- **使用适用于 SQL 数据库的活动异地复制将更改复制到辅助数据库。** 为 SQL 数据库的活动异地复制会自动复制到同一区域或不同区域中辅助数据库的数据库更改。 有关详细信息，请参阅[创建和使用活动异地复制](/azure/sql-database/sql-database-active-geo-replication)。

  或者，可以通过使用采用手动程度更高的方法**数据库复制**命令以创建事务上一致的数据库的备份副本。 也可以使用 Azure SQL 数据库的导入/导出服务，该服务支持将数据库导出到存储在 Azure Blob 存储中的 BACPAC 文件（包含数据库架构和关联数据的压缩文件）。 Azure 存储的同一区域中创建备份文件的两个的副本。 但是，备份过程的频率决定 RPO，这是您可能会丢失在灾难方案中的数据量。 例如，如果备份了数据每隔一小时，而灾难发生在备份之前两分钟，你将失去 58 分钟的数据。 此外，为了应对区域范围的服务中断，应将 BACPAC 文件复制到备用区域。 有关详细信息，请参阅[使用 Azure SQL 数据库确保业务连续性的概述](/azure/sql-database/sql-database-business-continuity)。

- **为 SQL 数据仓库使用异地备份。** 对于 SQL 数据仓库，请使用[异地备份](/azure/sql-data-warehouse/backup-and-restore)还原到灾难恢复的配对区域。 这些备份会每隔 24 小时，并且可以在 20 分钟内恢复配对区域中。 此功能是在默认情况下，所有 SQL 数据仓库实例。 有关如何还原数据仓库的详细信息，请参阅[从使用 PowerShell 的 Azure 地理区域还原。](/azure/sql-data-warehouse/sql-data-warehouse-restore)

- **使用 Azure Site Recovery 复制 VM 磁盘。** 使用 Azure 虚拟机的复制时间[Site Recovery](/azure/site-recovery/)，所有 VM 磁盘会持续都复制到目标区域以异步方式。 每隔几分钟就会创建恢复点。 这样，您几分钟 RPO。
- **备份 Vm 上运行的 SQL Server 或配置日志传送会话。** 对于 VM 上运行的 SQL Server，可以使用两个选项：传统备份和日志传送。 传统备份可以还原到的特定点的时间，但恢复过程较慢。 还原传统备份要求先进行初始的完整备份，然后将应用在此之后执行的所有备份。 第二个选项是配置日志传送会话，延迟日志备份的还原 （例如，通过两个小时）。 这就为从主要数据库发生的错误恢复提供了时间窗口。
- **自定义过程或第三方工具用于 Azure 存储备份。** 对于 Azure 存储，可以开发自定义备份过程，或使用第三方备份工具。 大多数应用程序设计中，还有其他复杂问题，其中，存储资源互相引用。 例如，考虑具有一列的 SQL 数据库链接到 Azure 存储中的 blob。 如果未能同时进行备份，则数据库可能会提供一个指针，指向在发生故障之前未备份的 Blob。 应用程序或灾难恢复计划必须实现在恢复后处理这种不一致性的过程。
- **用于托管在 Vm 上的其他数据平台的本机复制或快照功能。** 其他数据平台，如 Elasticsearch 或 MongoDB，在创建集成的备份时有其自己的功能和注意事项，并还原过程。 对于这些数据平台，一般建议是使用任何本机或可用的集成基于的复制或快照功能。 如果这些功能不存在或不合适，请考虑使用 Azure 备份或磁盘快照创建应用程序数据的时间点副本。 在所有情况下，务必确定如何实现一致的备份，尤其是应用程序数据分布在多个文件系统或多个驱动器合并到单个文件系统时。
- **了解应用程序数据源的复制方法。** 应用程序数据将存储在不同的数据源，将具有不同的可用性要求。 评估每种类型的数据存储在 Azure 中的复制方法包括[的 Azure 存储冗余](/azure/storage/storage-redundancy/)并[SQL 数据库活动异地复制](/azure/sql-database/sql-database-geo-replication-overview/)以确保应用程序的数据满足要求。 如果使用的 Azure Vm 复制[Site Recovery](/azure/site-recovery/)，所有 VM 磁盘会持续都复制到目标区域以异步方式。 每隔几分钟就会创建恢复点。
- **建立灾难恢复的数据策略。** 正确的数据处理是任何灾难恢复计划的困难方面。 在恢复过程中，数据还原通常最耗时间。 为减弱功能做出的不同选择导致数据恢复和一致性面临严峻挑战。

## <a name="next-steps"></a>后续步骤

> [!div class="nextstepaction"]
> [复原能力和可用性测试](./testing.md)
