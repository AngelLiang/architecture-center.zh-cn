---
title: 构建 Azure 应用程序的弹性和可用性
description: 将复原能力和可用性内置于 Azure 应用程序
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.openlocfilehash: ee4bb5b4a85e48fe0ff017297c31823c93a48f04
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59646496"
---
# <a name="architecting-azure-applications-for-resiliency-and-availability"></a><span data-ttu-id="0a8c4-103">构建 Azure 应用程序的弹性和可用性</span><span class="sxs-lookup"><span data-stu-id="0a8c4-103">Architecting Azure applications for resiliency and availability</span></span>

<span data-ttu-id="0a8c4-104">已为你的应用程序开发要求后下, 一步是将复原能力和可用性内置于它。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-104">After you've developed the requirements for your application, the next step is to build resiliency and availability into it.</span></span> <span data-ttu-id="0a8c4-105">不能在末尾添加这些质量&mdash;必须与体系结构设计。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-105">These qualities can't be added at the end &mdash; you must design them into the architecture.</span></span>

## <a name="conduct-a-failure-mode-analysis"></a><span data-ttu-id="0a8c4-106">执行故障模式分析</span><span class="sxs-lookup"><span data-stu-id="0a8c4-106">Conduct a failure mode analysis</span></span>

<span data-ttu-id="0a8c4-107">*故障模式分析*(FMA) 生成到系统通过标识可能的故障点并定义应用程序如何响应这些故障的复原能力。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-107">*Failure mode analysis* (FMA) builds resiliency into a system by identifying possible failure points and defining how the application responds to those failures.</span></span> <span data-ttu-id="0a8c4-108">FMA 应该是体系结构和设计阶段的一部分，因此故障恢复内置于系统从一开始。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-108">The FMA should be part of the architecture and design phases, so failure recovery is built into the system from the beginning.</span></span> <span data-ttu-id="0a8c4-109">FMA 的目标是：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-109">The goals of an FMA are to:</span></span>

- <span data-ttu-id="0a8c4-110">确定哪些类型的故障可能会遇到应用程序和应用程序如何检测这些故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-110">Determine what types of failures an application might experience and how the application detects those failures.</span></span>
- <span data-ttu-id="0a8c4-111">捕获每种类型的失败的潜在影响，并确定应用如何响应。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-111">Capture the potential effects of each type of failure and determine how the app responds.</span></span>
- <span data-ttu-id="0a8c4-112">规划日志记录和监视故障和确定恢复策略。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-112">Plan for logging and monitoring the failure and identify recovery strategies.</span></span>

<span data-ttu-id="0a8c4-113">下面是故障模式和特定的故障点的检测策略的一些示例&mdash;对外部 web 服务的调用：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-113">Here are some examples of failure modes and detection strategies for a specific failure point &mdash; a call to an external web service:</span></span>

| <span data-ttu-id="0a8c4-114">故障模式</span><span class="sxs-lookup"><span data-stu-id="0a8c4-114">Failure mode</span></span>           | <span data-ttu-id="0a8c4-115">检测策略</span><span class="sxs-lookup"><span data-stu-id="0a8c4-115">Detection strategy</span></span>           |
|------------------------|------------------------------|
| <span data-ttu-id="0a8c4-116">服务不可用</span><span class="sxs-lookup"><span data-stu-id="0a8c4-116">Service is unavailable</span></span> | <span data-ttu-id="0a8c4-117">HTTP 5xx</span><span class="sxs-lookup"><span data-stu-id="0a8c4-117">HTTP 5xx</span></span>                     |
| <span data-ttu-id="0a8c4-118">限制</span><span class="sxs-lookup"><span data-stu-id="0a8c4-118">Throttling</span></span>             | <span data-ttu-id="0a8c4-119">HTTP 429（请求过多）</span><span class="sxs-lookup"><span data-stu-id="0a8c4-119">HTTP 429 (Too Many Requests)</span></span> |
| <span data-ttu-id="0a8c4-120">Authentication</span><span class="sxs-lookup"><span data-stu-id="0a8c4-120">Authentication</span></span>         | <span data-ttu-id="0a8c4-121">HTTP 401（未授权）</span><span class="sxs-lookup"><span data-stu-id="0a8c4-121">HTTP 401 (Unauthorized)</span></span>      |
| <span data-ttu-id="0a8c4-122">响应速度慢</span><span class="sxs-lookup"><span data-stu-id="0a8c4-122">Slow response</span></span>          | <span data-ttu-id="0a8c4-123">请求超时</span><span class="sxs-lookup"><span data-stu-id="0a8c4-123">Request times out</span></span>            |

<span data-ttu-id="0a8c4-124">有关 FMA 过程，使用适用于 Azure，具体的建议的详细信息请参阅[故障模式分析](../resiliency/failure-mode-analysis.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-124">For more information about the FMA process, with specific recommendations for Azure, see [Failure mode analysis](../resiliency/failure-mode-analysis.md).</span></span>

## <a name="plan-for-redundancy"></a><span data-ttu-id="0a8c4-125">计划以确保冗余</span><span class="sxs-lookup"><span data-stu-id="0a8c4-125">Plan for redundancy</span></span>

<span data-ttu-id="0a8c4-126">故障的影响范围中会有所不同。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-126">Failures vary in scope of impact.</span></span> <span data-ttu-id="0a8c4-127">某些硬件故障，例如磁盘故障影响单个主机计算机。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-127">Some hardware failures, such as a failed disk, affect a single host machine.</span></span> <span data-ttu-id="0a8c4-128">网络交换机故障可能会影响整个服务器机架。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-128">A failed network switch could affect an entire server rack.</span></span> <span data-ttu-id="0a8c4-129">不太常见的故障，如断电，会中断整个数据中心。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-129">Less common failures, such as loss of power, disrupt a whole datacenter.</span></span> <span data-ttu-id="0a8c4-130">很少，整个区域变得不可用。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-130">Rarely, an entire region becomes unavailable.</span></span>

<span data-ttu-id="0a8c4-131">冗余是使应用程序的可复原的一种方法。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-131">Redundancy is one way to make an application resilient.</span></span> <span data-ttu-id="0a8c4-132">冗余级别取决于你的业务要求&mdash;不是每个应用程序需要跨区域以防范区域性服务中断的冗余。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-132">The level of redundancy depends on your business requirements &mdash; not every application needs redundancy across regions to guard against a regional outage.</span></span> <span data-ttu-id="0a8c4-133">一般情况下，没有更高冗余和可靠性更高的成本和复杂性之间做出取舍。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-133">In general, there's a tradeoff between greater redundancy and reliability versus higher costs and complexity.</span></span>

### <a name="review-azure-redundancy-features"></a><span data-ttu-id="0a8c4-134">查看 Azure 冗余功能</span><span class="sxs-lookup"><span data-stu-id="0a8c4-134">Review Azure redundancy features</span></span>

<span data-ttu-id="0a8c4-135">Azure 在每个级别的故障，从整个区域的单个虚拟机 (VM) 具有许多冗余功能。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-135">Azure has a number of redundancy features at every level of failure, from an individual virtual machine (VM) to an entire region.</span></span>

- <span data-ttu-id="0a8c4-136">**单个 Vm 也**具有[正常运行时间服务级别协议 (SLA)](https://azure.microsoft.com/support/legal/sla/virtual-machines) Azure 提供的。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-136">**Single VMs** have an [uptime service level agreement (SLA)](https://azure.microsoft.com/support/legal/sla/virtual-machines) provided by Azure.</span></span> <span data-ttu-id="0a8c4-137">（该 VM 必须使用高级存储的所有操作系统磁盘和数据磁盘。）尽管可以通过运行两个或更多个 VM 来获得更高的 SLA，则对于某些工作负荷而言，单个 VM 可能已足够可靠。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-137">(The VM must use premium storage for all operating system disks and data disks.) Although you can get a higher SLA by running two or more VMs, a single VM may be reliable enough for some workloads.</span></span> <span data-ttu-id="0a8c4-138">但是，对于生产工作负荷，我们建议使用两个或更多个 VM 来实现冗余。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-138">For production workloads, however, we recommend using two or more VMs for redundancy.</span></span>
- <span data-ttu-id="0a8c4-139">**可用性集**防止局部的硬件故障，如磁盘或网络交换机故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-139">**Availability sets** protect against localized hardware failures, such as a disk or network switch failing.</span></span> <span data-ttu-id="0a8c4-140">在可用性集中的 Vm 分布在最多三个*容错域*。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-140">VMs in an availability set are distributed across up to three *fault domains*.</span></span> <span data-ttu-id="0a8c4-141">容错域定义一的组共享公共电源和网络交换机的 Vm。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-141">A fault domains defines a group of VMs that share a common power source and network switch.</span></span> <span data-ttu-id="0a8c4-142">如果发生硬件故障影响一个容错域，则会将网络流量路由到其他容错域中的 Vm。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-142">If a hardware failure affects one fault domain, network traffic is routed to VMs in the other fault domains.</span></span> <span data-ttu-id="0a8c4-143">有关可用性集的详细信息，请参阅[管理 Azure 中 Windows 虚拟机的可用性](/azure/virtual-machines/windows/manage-availability)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-143">For more information about availability sets, see [Manage the availability of Windows virtual machines in Azure](/azure/virtual-machines/windows/manage-availability).</span></span>
- <span data-ttu-id="0a8c4-144">**可用性区域**是 Azure 区域中物理上独立的区域。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-144">**Availability Zones** are physically separate zones within an Azure region.</span></span> <span data-ttu-id="0a8c4-145">每个可用性区域有独立的电源、网络和散热设备。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-145">Each Availability Zone has a distinct power source, network, and cooling.</span></span> <span data-ttu-id="0a8c4-146">跨可用性区域部署 Vm 有助于保护对数据中心级故障的应用程序。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-146">Deploying VMs across Availability Zones helps to protect an application against datacenter-wide failures.</span></span> <span data-ttu-id="0a8c4-147">并非所有地区都支持可用性区域。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-147">Not all regions support Availability Zones.</span></span> <span data-ttu-id="0a8c4-148">如需支持的地区和服务的列表，请参阅 [Azure 中的可用性区域是什么？](/azure/availability-zones/az-overview)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-148">For a list of supported regions and services, see [What are Availability Zones in Azure?](/azure/availability-zones/az-overview).</span></span>

    <span data-ttu-id="0a8c4-149">如果您打算在部署中使用可用性区域，首先验证的应用程序体系结构和代码库支持此配置。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-149">If you plan to use Availability Zones in your deployment, first validate that your application architecture and codebase support this configuration.</span></span> <span data-ttu-id="0a8c4-150">如果您部署商用软件，请咨询软件供应商和部署到生产环境之前进行充分测试。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-150">If you deploy commercial software, consult with the software vendor and test adequately before deploying into production.</span></span> <span data-ttu-id="0a8c4-151">应用程序必须保持的状态，并在中配置的区域发生服务中断过程中防止数据丢失。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-151">An application must maintain state and prevent loss of data during an outage within the configured zone.</span></span> <span data-ttu-id="0a8c4-152">应用程序必须支持在具有任何硬编码的基础结构组件的弹性和分布式基础结构中运行。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-152">The application must support running in an elastic and distributed infrastructure with no hard-coded infrastructure components.</span></span>
- <span data-ttu-id="0a8c4-153">**Azure Site Recovery**复制 Azure 虚拟机连接到另一个 Azure 区域 (BC) 的业务连续性和灾难恢复 (DR) 需求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-153">**Azure Site Recovery** replicates Azure Virtual Machines to another Azure region for business continuity (BC) and disaster recovery (DR) needs.</span></span> <span data-ttu-id="0a8c4-154">您可以执行定期的 DR 演练以确保操作满足符合性需求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-154">You can conduct periodic DR drills to ensure that you meet the compliance needs.</span></span> <span data-ttu-id="0a8c4-155">以便恢复你的应用程序发生故障源区域中时，将使用的指定设置应用到所选区域复制 VM。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-155">The VM is replicated with the specified settings to the selected region so you can recover your applications in the event of outages in the source region.</span></span> <span data-ttu-id="0a8c4-156">有关详细信息，请参阅[为 Azure vm 设置到辅助 Azure 区域的灾难恢复](/azure/site-recovery/azure-to-azure-quickstart/)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-156">For more information, see [Set up disaster recovery to a secondary Azure region for an Azure VM](/azure/site-recovery/azure-to-azure-quickstart/).</span></span>

    <span data-ttu-id="0a8c4-157">在测试期间，验证是否*恢复时间目标*(RTO) 和*恢复点目标*(RPO) 满足你的需求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-157">During testing, verify that the *recovery time objective* (RTO) and *recovery point objective* (RPO) meet your needs.</span></span> <span data-ttu-id="0a8c4-158">RTO 是某个事件后，应用程序是不可用的最长时间和 RPO 是指发生灾难期间的数据丢失的最大持续时间。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-158">RTO is the maximum time an application is unavailable after an incident, and RPO is the maximum duration of data loss during a disaster.</span></span>
- <span data-ttu-id="0a8c4-159">**配对区域**使用 Azure 流量管理器将 Internet 流量分发到不同区域时，保护应用程序免受区域性服务中断时创建的。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-159">**Paired regions** are created using Azure Traffic Manager to distribute Internet traffic to different regions, protecting an application against a regional outage.</span></span> <span data-ttu-id="0a8c4-160">每个 Azure 区域与另一个区域配对。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-160">Each Azure region is paired with another region.</span></span> <span data-ttu-id="0a8c4-161">在一起，这些区域构成[*区域对*](/azure/best-practices-availability-paired-regions)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-161">Together, these regions form a [*regional pair*](/azure/best-practices-availability-paired-regions).</span></span> <span data-ttu-id="0a8c4-162">以符合税务和执法管辖的数据驻留要求，区域对位于相同的地理位置 （巴西南部除外）。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-162">To meet data residency requirements for tax and law enforcement jurisdiction purposes, regional pairs are located within the same geography (with the exception of Brazil South).</span></span>

    <span data-ttu-id="0a8c4-163">若要提高应用程序复原能力，Azure 将序列化为平台更新 （计划内维护） 跨每个区域对，因此，只有一个配对的区域更新一次。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-163">To improve application resiliency, Azure serializes platform updates (planned maintenance) across each region pair, so only one paired region is updated at a time.</span></span>
- <span data-ttu-id="0a8c4-164">在设计多区域应用程序时，请考虑在区域之间的网络延迟高于区域内。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-164">When you design a multiregion application, take into account that network latency across regions is higher than within a region.</span></span> <span data-ttu-id="0a8c4-165">例如，如果复制数据库启用故障转移时，在区域内的同步数据复制，但异步数据复制在区域中使用。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-165">For example, if you replicate a database to enable failover, use synchronous data replication within a region but asynchronous data replication across regions.</span></span>

<span data-ttu-id="0a8c4-166">下表比较了跨多个复原策略的冗余因素：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-166">The following table compares the redundancy factors across several resiliency strategies:</span></span>

| &nbsp; | <span data-ttu-id="0a8c4-167">可用性集</span><span class="sxs-lookup"><span data-stu-id="0a8c4-167">Availability set</span></span> | <span data-ttu-id="0a8c4-168">可用性区域</span><span class="sxs-lookup"><span data-stu-id="0a8c4-168">Availability Zone</span></span> | <span data-ttu-id="0a8c4-169">Azure 站点恢复/配对区域</span><span class="sxs-lookup"><span data-stu-id="0a8c4-169">Azure Site Recovery/Paired region</span></span> |
|--------|------------------|-------------------|-----------------------------------|
| <span data-ttu-id="0a8c4-170">故障范围</span><span class="sxs-lookup"><span data-stu-id="0a8c4-170">Scope of failure</span></span> | <span data-ttu-id="0a8c4-171">机架</span><span class="sxs-lookup"><span data-stu-id="0a8c4-171">Rack</span></span>                  | <span data-ttu-id="0a8c4-172">数据中心</span><span class="sxs-lookup"><span data-stu-id="0a8c4-172">Datacenter</span></span>               | <span data-ttu-id="0a8c4-173">区域</span><span class="sxs-lookup"><span data-stu-id="0a8c4-173">Region</span></span>                               |
| <span data-ttu-id="0a8c4-174">请求路由</span><span class="sxs-lookup"><span data-stu-id="0a8c4-174">Request routing</span></span>  | <span data-ttu-id="0a8c4-175">Azure 负载均衡器</span><span class="sxs-lookup"><span data-stu-id="0a8c4-175">Azure Load Balancer</span></span>   | <span data-ttu-id="0a8c4-176">跨区域负载均衡器</span><span class="sxs-lookup"><span data-stu-id="0a8c4-176">Cross-zone Load Balancer</span></span> | <span data-ttu-id="0a8c4-177">Azure 流量管理器</span><span class="sxs-lookup"><span data-stu-id="0a8c4-177">Azure Traffic Manager</span></span>                |
| <span data-ttu-id="0a8c4-178">网络延迟</span><span class="sxs-lookup"><span data-stu-id="0a8c4-178">Network latency</span></span>  | <span data-ttu-id="0a8c4-179">极低</span><span class="sxs-lookup"><span data-stu-id="0a8c4-179">Very low</span></span>              | <span data-ttu-id="0a8c4-180">低</span><span class="sxs-lookup"><span data-stu-id="0a8c4-180">Low</span></span>                      | <span data-ttu-id="0a8c4-181">中到高</span><span class="sxs-lookup"><span data-stu-id="0a8c4-181">Mid to high</span></span>                          |
| <span data-ttu-id="0a8c4-182">虚拟网络</span><span class="sxs-lookup"><span data-stu-id="0a8c4-182">Virtual network</span></span>  | <span data-ttu-id="0a8c4-183">Azure 虚拟网络</span><span class="sxs-lookup"><span data-stu-id="0a8c4-183">Azure Virtual Network</span></span> | <span data-ttu-id="0a8c4-184">Azure 虚拟网络</span><span class="sxs-lookup"><span data-stu-id="0a8c4-184">Azure Virtual Network</span></span>          | <span data-ttu-id="0a8c4-185">跨区域虚拟网络对等互连</span><span class="sxs-lookup"><span data-stu-id="0a8c4-185">Cross-region Virtual Network peering</span></span> |

### <a name="complete-azure-redundancy-tasks"></a><span data-ttu-id="0a8c4-186">完成 Azure 冗余任务</span><span class="sxs-lookup"><span data-stu-id="0a8c4-186">Complete Azure redundancy tasks</span></span>

<span data-ttu-id="0a8c4-187">使用以下任务来满足冗余要求：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-187">Use the following tasks to meet redundancy requirements:</span></span>

- <span data-ttu-id="0a8c4-188">**部署服务的多个实例。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-188">**Deploy multiple instances of services.**</span></span> <span data-ttu-id="0a8c4-189">如果应用程序依赖于服务的单个实例，则会造成单一故障点。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-189">If your application depends on a single instance of a service, it creates a single point of failure.</span></span> <span data-ttu-id="0a8c4-190">预配多个实例能够提高复原能力和可伸缩性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-190">Provisioning multiple instances improves both resiliency and scalability.</span></span> <span data-ttu-id="0a8c4-191">对于 [Azure 应用服务](/azure/app-service/app-service-value-prop-what-is/)，请选择提供多个实例的[应用服务计划](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-191">For [Azure App Service](/azure/app-service/app-service-value-prop-what-is/), select an [App Service plan](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/) that offers multiple instances.</span></span> <span data-ttu-id="0a8c4-192">有关[Azure 虚拟机](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)，确保您的体系结构具有多个 VM，并且，每个 VM 包含在[可用性集](/azure/virtual-machines/virtual-machines-windows-manage-availability/)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-192">For [Azure Virtual Machines](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json), ensure that your architecture has more than one VM and that each VM is included in an [availability set](/azure/virtual-machines/virtual-machines-windows-manage-availability/).</span></span>

- <span data-ttu-id="0a8c4-193">**使用 Azure Site Recovery 复制 VM。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-193">**Replicate VMs using Azure Site Recovery.**</span></span> <span data-ttu-id="0a8c4-194">使用 Azure 虚拟机的复制时间[Site Recovery](/azure/site-recovery/)，所有 VM 磁盘会持续都复制到目标区域以异步方式。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-194">When you replicate Azure VMs using [Site Recovery](/azure/site-recovery/), all the VM disks are continuously replicated to the target region asynchronously.</span></span> <span data-ttu-id="0a8c4-195">恢复点创建每隔几分钟，让几分钟 RPO。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-195">The recovery points are created every few minutes, giving an RPO on the order of minutes.</span></span>

- <span data-ttu-id="0a8c4-196">**考虑跨多个区域部署应用程序。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-196">**Consider deploying your application across multiple regions.**</span></span> <span data-ttu-id="0a8c4-197">如果你的应用程序部署到单个区域和区域变得不可用，你的应用程序也将不可用。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-197">If your application is deployed to a single region, and the region becomes unavailable, your application will also be unavailable.</span></span> <span data-ttu-id="0a8c4-198">根据应用程序的 SLA 条款，这种情况可能不可接受。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-198">This may be unacceptable under the terms of your application's SLA.</span></span> <span data-ttu-id="0a8c4-199">为此，请考虑跨多个区域部署应用程序及其服务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-199">If so, consider deploying your application and its services across multiple regions.</span></span> <span data-ttu-id="0a8c4-200">多区域部署可以使用*主动-主动*或*主动-被动*配置。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-200">A multiregion deployment can use an *active-active* or *active-passive* configuration.</span></span> <span data-ttu-id="0a8c4-201">主动-主动配置将请求分配跨多个活动的区域。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-201">An active-active configuration distributes requests across multiple active regions.</span></span> <span data-ttu-id="0a8c4-202">主动-被动配置将热实例保留在次要区域中，但存在不会发送流量，除非主要区域发生故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-202">An active-passive configuration keeps warm instances in the secondary region, but doesn't send traffic there unless the primary region fails.</span></span> <span data-ttu-id="0a8c4-203">对于多区域部署，我们建议将部署到配对的区域，上面所述。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-203">For multiregion deployments, we recommend deploying to paired regions, described above.</span></span> <span data-ttu-id="0a8c4-204">有关详细信息，请参阅[业务连续性和灾难恢复 (BCDR)：Azure 配对区域](/azure/best-practices-availability-paired-regions)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-204">For more information, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions](/azure/best-practices-availability-paired-regions).</span></span>

- <span data-ttu-id="0a8c4-205">**使用 Azure 流量管理器将应用程序的流量路由到不同的区域。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-205">**Use Azure Traffic Manager to route your application's traffic to different regions.**</span></span> <span data-ttu-id="0a8c4-206">[Azure 流量管理器](/azure/traffic-manager/traffic-manager-overview/)在 DNS 级别之间进行负载平衡并将流量路由到基于不同的区域[流量路由](/azure/traffic-manager/traffic-manager-routing-methods/)方法和应用程序的终结点的运行状况。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-206">[Azure Traffic Manager](/azure/traffic-manager/traffic-manager-overview/) performs load-balancing at the DNS level and routes traffic to different regions based on the [traffic routing](/azure/traffic-manager/traffic-manager-routing-methods/) method and the health of your application's endpoints.</span></span> <span data-ttu-id="0a8c4-207">无需流量管理器中，你被限制为单个区域为你的部署，后者限制规模、 会增加延迟时间为一些用户，并会导致应用程序停机时间，在区域范围的服务中断的情况下。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-207">Without Traffic Manager, you are limited to a single region for your deployment, which constrains scale, increases latency for some users, and causes application downtime, in the case of a region-wide service disruption.</span></span>

- <span data-ttu-id="0a8c4-208">**Azure 应用程序网关配置为使用多个实例。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-208">**Configure Azure Application Gateway to use multiple instances.**</span></span> <span data-ttu-id="0a8c4-209">根据应用程序的要求，[Azure 应用程序网关](/azure/application-gateway/application-gateway-introduction/)可能更适合用于将请求分发到应用程序的服务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-209">Depending on your application's requirements, an [Azure Application Gateway](/azure/application-gateway/application-gateway-introduction/) may be better suited to distributing requests to your application's services.</span></span> <span data-ttu-id="0a8c4-210">但是，在 sla 中，因此很可能你的应用程序可能会失败，如果应用程序网关实例失败不保证应用程序网关服务的单一实例。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-210">However, single instances of the Application Gateway service are not guaranteed by an SLA, so it's possible that your application could fail if the Application Gateway instance fails.</span></span> <span data-ttu-id="0a8c4-211">预配多个中型或大型实例，以保证的条款下的服务的可用性[应用程序网关 SLA](https://azure.microsoft.com/support/legal/sla/application-gateway/)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-211">Provision more than one medium or larger instance to guarantee availability of the service under the terms of the [Application Gateway SLA](https://azure.microsoft.com/support/legal/sla/application-gateway/).</span></span>

## <a name="design-for-scalability"></a><span data-ttu-id="0a8c4-212">可伸缩性设计</span><span class="sxs-lookup"><span data-stu-id="0a8c4-212">Design for scalability</span></span>

<span data-ttu-id="0a8c4-213">*可伸缩性*是一个系统能够处理增加的负载，而是一个[软件质量的构成要素](../guide/pillars.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-213">*Scalability* is the ability of a system to handle increased load and is one of the [pillars of software quality](../guide/pillars.md).</span></span> <span data-ttu-id="0a8c4-214">在构建阶段的可伸缩性任务包括：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-214">Scalability tasks during the architecting phase include:</span></span>

- <span data-ttu-id="0a8c4-215">**分区工作负荷。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-215">**Partition workloads.**</span></span> <span data-ttu-id="0a8c4-216">将流程的各部分设计为相互独立且可以分解。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-216">Design parts of the process to be discrete and decomposable.</span></span> <span data-ttu-id="0a8c4-217">最小化每个部分的大小。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-217">Minimize the size of each part.</span></span> <span data-ttu-id="0a8c4-218">这样，组件的各部分用于最大化利用每个计算单元的方式进行分布。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-218">This allows the component parts to be distributed in a way that maximizes use of each compute unit.</span></span> <span data-ttu-id="0a8c4-219">此外，可以更方便地缩放应用程序（只需添加特定资源的更多实例即可）。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-219">It also makes it easier to scale the application by adding instances of specific resources.</span></span> <span data-ttu-id="0a8c4-220">对于复杂的域，请考虑采用[微服务体系结构](../guide/architecture-styles/microservices.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-220">For complex domains, consider adopting a [microservices architecture](../guide/architecture-styles/microservices.md).</span></span>
- <span data-ttu-id="0a8c4-221">**针对缩放进行设计。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-221">**Design for scaling.**</span></span> <span data-ttu-id="0a8c4-222">缩放，应用程序可以响应负载的增加和减少的角色、 队列和其他服务实例数。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-222">Scaling allows applications to react to variable load by increasing and decreasing the number of instances of roles, queues, and other services.</span></span> <span data-ttu-id="0a8c4-223">但是，应用程序在设计时必须充分考虑这一点。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-223">However, the application must be designed with this in mind.</span></span> <span data-ttu-id="0a8c4-224">例如，应用程序和其使用的服务必须是无状态，以允许将请求路由到任何实例。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-224">For example, the application and the services it uses must be stateless to allow requests to be routed to any instance.</span></span> <span data-ttu-id="0a8c4-225">无状态服务还意味着，添加或删除实例不会产生负面影响当前用户。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-225">Having stateless services also means that adding or removing an instance does not adversely impact current users.</span></span>
- <span data-ttu-id="0a8c4-226">**规划与缩放单位的增长。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-226">**Plan for growth with scale units.**</span></span> <span data-ttu-id="0a8c4-227">对于每个资源，知道缩放上限，并使用分片或分解方式来应对这些限制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-227">For each resource, know the upper scaling limits, and use sharding or decomposition to go beyond those limits.</span></span> <span data-ttu-id="0a8c4-228">设计应用程序时，应确保其能够轻松地通过添加一个或多个缩放单元来进行缩放。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-228">Design the application so that it's easily scaled by adding one or more scale units.</span></span> <span data-ttu-id="0a8c4-229">按照定义好的资源集来确定系统的缩放单元。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-229">Determine the scale units for the system in terms of well-defined sets of resources.</span></span> <span data-ttu-id="0a8c4-230">这会使应用横向扩展操作更加容易，不容易到整个系统的某些部分缺乏资源导致的负面影响。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-230">This makes applying scale-out operations easier and less prone to negative impact caused by a lack of resources in some part of the overall system.</span></span> <span data-ttu-id="0a8c4-231">例如，添加*X*前端的 Vm 数目可能会要求*Y*额外的队列的数目和*Z*编号的存储帐户来处理额外的工作负荷。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-231">For example, adding *X* number of front-end VMs might require *Y* number of additional queues and *Z* number of storage accounts to handle the additional workload.</span></span> <span data-ttu-id="0a8c4-232">因此缩放单位可能包含的*X* VM 实例*Y*队列，并*Z*存储帐户。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-232">So a scale unit could consist of *X* VM instances, *Y* queues, and *Z* storage accounts.</span></span>
- <span data-ttu-id="0a8c4-233">**避免客户端关联。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-233">**Avoid client affinity.**</span></span> <span data-ttu-id="0a8c4-234">如有可能，应确保应用程序不需要关联。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-234">Where possible, ensure that the application doesn't require affinity.</span></span> <span data-ttu-id="0a8c4-235">然后将请求路由到任何实例，与实例的数目无关。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-235">Requests can then be routed to any instance, and the number of instances is irrelevant.</span></span> <span data-ttu-id="0a8c4-236">这样还可以避免为每个用户存储、检索和维护状态信息的开销。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-236">This also avoids the overhead of storing, retrieving, and maintaining state information for each user.</span></span>
- <span data-ttu-id="0a8c4-237">**充分利用平台自动缩放功能。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-237">**Take advantage of platform autoscaling features.**</span></span> <span data-ttu-id="0a8c4-238">使用内置自动缩放功能，如果可能，而不是自定义或第三方机制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-238">Use built-in autoscaling features when possible, rather than custom or third-party mechanisms.</span></span> <span data-ttu-id="0a8c4-239">使用计划的缩放规则，如果可能，以确保资源则无需启动延迟，但将被动自动缩放添加到规则中，在适当的位置，以应对意外的需求变化。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-239">Use scheduled scaling rules, where possible, to ensure that resources are available without a startup delay, but add reactive autoscaling to the rules, where appropriate, to cope with unexpected changes in demand.</span></span> <span data-ttu-id="0a8c4-240">有关详细信息，请参阅[自动缩放指南](../best-practices/auto-scaling.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-240">For more information, see [Autoscaling guidance](../best-practices/auto-scaling.md).</span></span>  

  <span data-ttu-id="0a8c4-241">如果你的应用程序未配置为随着负载的增加而自动横向扩展，就可以，如果它们变得满用户请求，应用程序的服务将失败。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-241">If your application isn't configured to scale out automatically as load increases, it's possible that your application's services will fail if they become saturated with user requests.</span></span> <span data-ttu-id="0a8c4-242">有关详细信息，请参阅以下文章：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-242">For more information, see the following articles:</span></span>

  - <span data-ttu-id="0a8c4-243">常规：[伸缩性清单](../checklist/scalability.md)</span><span class="sxs-lookup"><span data-stu-id="0a8c4-243">General: [Scalability checklist](../checklist/scalability.md)</span></span>
  - <span data-ttu-id="0a8c4-244">Azure 应用服务：[手动或自动缩放实例计数](/azure/monitoring-and-diagnostics/insights-how-to-scale/)</span><span class="sxs-lookup"><span data-stu-id="0a8c4-244">Azure App Service: [Scale instance count manually or automatically](/azure/monitoring-and-diagnostics/insights-how-to-scale/)</span></span>
  - <span data-ttu-id="0a8c4-245">云服务：[如何自动缩放云服务](/azure/cloud-services/cloud-services-how-to-scale/)</span><span class="sxs-lookup"><span data-stu-id="0a8c4-245">Cloud Services: [How to autoscale a Cloud Service](/azure/cloud-services/cloud-services-how-to-scale/)</span></span>
  - <span data-ttu-id="0a8c4-246">虚拟机：[自动缩放和虚拟机规模集](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview/)</span><span class="sxs-lookup"><span data-stu-id="0a8c4-246">Virtual machines: [Automatic scaling and virtual machine scale sets](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview/)</span></span>

- <span data-ttu-id="0a8c4-247">**卸载密集型 CPU/IO 任务作为后台任务。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-247">**Offload intensive CPU/IO tasks as background tasks.**</span></span> <span data-ttu-id="0a8c4-248">如果对服务请求预计需要花费很长时间才能运行，或可能会吸收大量的资源，将处理卸载到单独的任务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-248">If a request to a service is expected to take a long time to run or may absorb considerable resources, offload the processing to a separate task.</span></span> <span data-ttu-id="0a8c4-249">使用后台作业来执行这些任务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-249">Use background jobs to execute these tasks.</span></span> <span data-ttu-id="0a8c4-250">此策略允许服务继续接收更多的请求，并且可保持响应状态。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-250">This strategy enables the service to continue receiving further requests and to remain responsive.</span></span> <span data-ttu-id="0a8c4-251">有关详细信息，请参阅[后台作业指南](../best-practices/background-jobs.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-251">For more information, see [Background jobs guidance](../best-practices/background-jobs.md).</span></span>
- <span data-ttu-id="0a8c4-252">**分发后台任务的工作负载。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-252">**Distribute the workload for background tasks.**</span></span> <span data-ttu-id="0a8c4-253">如果有多个后台任务或任务需要相当长的时间或资源，请将工作分摊到多个计算单元。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-253">If there are many background tasks or if the tasks require considerable time or resources, spread the work across multiple compute units.</span></span> <span data-ttu-id="0a8c4-254">如需一种可能的解决方案，请参阅[使用者竞争模式](../patterns/competing-consumers.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-254">For one possible solution, see the [Competing Consumers pattern](../patterns/competing-consumers.md).</span></span>
- <span data-ttu-id="0a8c4-255">**请考虑将实现*无共享双*体系结构。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-255">**Consider moving toward a *shared-nothing* architecture.**</span></span> <span data-ttu-id="0a8c4-256">此体系结构使用独立的独立节点具有单点 （例如共享的服务或存储） 的争用。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-256">This architecture uses independent, self-sufficient nodes that have no single point of contention (such as shared services or storage).</span></span> <span data-ttu-id="0a8c4-257">从理论上讲，此类系统几乎可以无限地进行扩展。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-257">In theory, such a system can scale almost indefinitely.</span></span> <span data-ttu-id="0a8c4-258">虽然完全的非共享方法通常是不可行的但它可能会提供更好的可伸缩性设计的机会。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-258">Although a fully shared-nothing approach is usually not practical, it may provide opportunities to design for better scalability.</span></span> <span data-ttu-id="0a8c4-259">移动到共享式体系结构的很好的示例包括对数据进行分区和避免使用服务器端会话状态和客户端相关性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-259">Good examples of moving toward a shared-nothing architecture include partitioning data and avoiding the use of server-side session state and client affinity.</span></span>
- <span data-ttu-id="0a8c4-260">**设计应用程序的存储要求，以在 Azure 存储可伸缩性和性能目标内。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-260">**Design your application's storage requirements to fall within Azure Storage scalability and performance targets.**</span></span> <span data-ttu-id="0a8c4-261">Azure 存储可在预定义的可伸缩性和性能目标函数中，因此设计应用程序以使用这些目标内的存储。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-261">Azure Storage is designed to function within predefined scalability and performance targets, so design your application to use storage within those targets.</span></span> <span data-ttu-id="0a8c4-262">如果你超出这些目标，你的应用程序会受到存储限制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-262">If you exceed these targets, your application will experience storage throttling.</span></span> <span data-ttu-id="0a8c4-263">若要避免限制，预配其他存储帐户。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-263">To avoid throttling, provision additional storage accounts.</span></span> <span data-ttu-id="0a8c4-264">如果达到存储帐户的上限，预配其他 Azure 订阅，然后预配那里其他存储帐户。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-264">If you run up against the storage account limit, provision additional Azure subscriptions and then provision additional storage accounts there.</span></span> <span data-ttu-id="0a8c4-265">有关详细信息，请参阅 [Azure 存储可伸缩性和性能目标](/azure/storage/storage-scalability-targets/)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-265">For more information, see [Azure Storage scalability and performance targets](/azure/storage/storage-scalability-targets/).</span></span>
- <span data-ttu-id="0a8c4-266">**为应用程序选择适当的 VM 大小。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-266">**Select the right VM size for your application.**</span></span> <span data-ttu-id="0a8c4-267">测量实际 CPU、 内存、 磁盘和 I/O 在生产中，Vm，并验证已选择的 VM 大小足够。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-267">Measure the actual CPU, memory, disk, and I/O of your VMs in production, and verify that the VM size you've selected is sufficient.</span></span> <span data-ttu-id="0a8c4-268">如果不足，当 VM 接近其限制时，应用程序可能遇到容量问题。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-268">If not, your application may experience capacity issues as the VMs approach their limits.</span></span> <span data-ttu-id="0a8c4-269">[Azure 中虚拟机的大小](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)中详细介绍了 VM 大小。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-269">VM sizes are described in detail in [Sizes for virtual machines in Azure](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span></span>

## <a name="determine-subscription-and-service-requirements"></a><span data-ttu-id="0a8c4-270">确定订阅和服务的要求</span><span class="sxs-lookup"><span data-stu-id="0a8c4-270">Determine subscription and service requirements</span></span>

<span data-ttu-id="0a8c4-271">通过完成这些任务选择正确的订阅和您的应用程序的服务功能：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-271">Choose the right subscription and service features for your app by working through these tasks:</span></span>

- <span data-ttu-id="0a8c4-272">**评估要求针对[Azure 订阅和服务限制](/azure/azure-subscription-service-limits/)。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-272">**Evaluate requirements against [Azure subscription and service limits](/azure/azure-subscription-service-limits/).**</span></span> <span data-ttu-id="0a8c4-273">*Azure 订阅*对特定的资源类型，例如资源组、 内核数和存储帐户的数目有限制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-273">*Azure subscriptions* have limits on certain resource types, such as number of resource groups, cores, and storage accounts.</span></span> <span data-ttu-id="0a8c4-274">如果应用程序的要求超过 Azure 订阅限制，请创建另一个 Azure 订阅并预配足够的资源。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-274">If your application requirements exceed Azure subscription limits, create another Azure subscription and provision sufficient resources there.</span></span> <span data-ttu-id="0a8c4-275">每个 Azure 服务存在消耗量限制 &mdash; 例如，存储、吞吐量、连接、每秒请求数和其他指标的限制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-275">Individual Azure services have consumption limits &mdash; for example, limits on storage, throughput, number of connections, requests per second, and other metrics.</span></span> <span data-ttu-id="0a8c4-276">如果它尝试使用的资源超过这些限制，这样会导致受影响的用户的服务限制，并可能停机，你的应用程序将失败。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-276">Your application will fail if it attempts to use resources beyond these limits, resulting in service throttling and possible downtime for affected users.</span></span> <span data-ttu-id="0a8c4-277">根据特定服务和应用程序的需求，您常常可以避免这些限制通过纵向扩展 （例如，选择另一个定价层） 或向外扩展 （如添加新的实例）。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-277">Depending on the specific service and your application requirements, you can often avoid these limits by scaling up (for example, choosing another pricing tier) or scaling out (such as adding new instances).</span></span>
- <span data-ttu-id="0a8c4-278">**确定需要多少个存储帐户。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-278">**Determine how many storage accounts you need.**</span></span> <span data-ttu-id="0a8c4-279">Azure 允许特定数量的每个订阅的存储帐户。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-279">Azure allows a specific number of storage accounts per subscription.</span></span> <span data-ttu-id="0a8c4-280">有关详细信息，请参阅 [Azure 订阅和服务限制、配额与约束](/azure/azure-subscription-service-limits/#storage-limits)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-280">For more information, see [Azure subscription and service limits, quotas, and constraints](/azure/azure-subscription-service-limits/#storage-limits).</span></span>
- <span data-ttu-id="0a8c4-281">**为 Azure SQL 数据库选择适当的服务层。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-281">**Select the right service tier for Azure SQL Database.**</span></span> <span data-ttu-id="0a8c4-282">如果你的应用程序使用 Azure SQL 数据库，选择适当的服务层。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-282">If your application uses Azure SQL Database, select the appropriate service tier.</span></span> <span data-ttu-id="0a8c4-283">如果层不能处理应用程序的数据库事务单位 (DTU) 要求，你的数据的使用将受到限制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-283">If the tier cannot handle your application's database transaction unit (DTU) requirements, your data use will be throttled.</span></span> <span data-ttu-id="0a8c4-284">有关如何选择正确服务计划的详细信息，请参阅 [SQL 数据库选项和性能：了解每个服务层提供的功能](/azure/sql-database/sql-database-service-tiers/)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-284">For more information on selecting the correct service plan, see [SQL Database options and performance: Understand what's available in each service tier](/azure/sql-database/sql-database-service-tiers/).</span></span>
- <span data-ttu-id="0a8c4-285">**预配 Azure Cosmos DB 中的足够请求单位 (Ru)**。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-285">**Provision sufficient request units (RUs) in Azure Cosmos DB**.</span></span> <span data-ttu-id="0a8c4-286">使用 Azure Cosmos DB 时，需要支付预配的吞吐量和每小时消耗的存储的费用。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-286">With Azure Cosmos DB, you pay for the throughput you provision and the storage you consume on an hourly basis.</span></span> <span data-ttu-id="0a8c4-287">所有数据库操作的成本规范化为 Ru，该抽象的系统资源，例如 CPU、 IOPS 和内存。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-287">The cost of all database operations is normalized as RUs, which abstracts the system resources such as CPU, IOPS, and memory.</span></span> <span data-ttu-id="0a8c4-288">有关详细信息，请参阅 [Azure Cosmos DB 中的请求单位](/azure/cosmos-db/request-units)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-288">For more information, see [Request Units in Azure Cosmos DB](/azure/cosmos-db/request-units).</span></span>

## <a name="load-balance-as-needed"></a><span data-ttu-id="0a8c4-289">负载平衡根据需要</span><span class="sxs-lookup"><span data-stu-id="0a8c4-289">Load-balance as needed</span></span>

<span data-ttu-id="0a8c4-290">正确的负载均衡允许您以满足可用性要求以及与可用性相关的成本降至最低。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-290">Proper load-balancing allows you to meet availability requirements and to minimize costs associated with availability.</span></span>

- <span data-ttu-id="0a8c4-291">**使用负载均衡分发请求。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-291">**Use load-balancing to distribute requests.**</span></span> <span data-ttu-id="0a8c4-292">负载平衡应用程序将请求分布到正常的服务实例从轮转中删除不正常的实例。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-292">Load-balancing distributes your application's requests to healthy service instances by removing unhealthy instances from rotation.</span></span> <span data-ttu-id="0a8c4-293">如果你的服务使用 Azure 应用服务或 Azure 云服务，则表示已为你的负载平衡。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-293">If your service uses Azure App Service or Azure Cloud Services, it's already load-balanced for you.</span></span> <span data-ttu-id="0a8c4-294">但是，如果你的应用程序使用 Azure Vm，需要预配负载均衡器。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-294">However, if your application uses Azure VMs, you need to provision a load-balancer.</span></span> <span data-ttu-id="0a8c4-295">有关详细信息，请参阅[什么是 Azure 负载均衡器？](/azure/load-balancer/load-balancer-overview/)</span><span class="sxs-lookup"><span data-stu-id="0a8c4-295">For more information, see [What is Azure Load Balancer?](/azure/load-balancer/load-balancer-overview/)</span></span>

  <span data-ttu-id="0a8c4-296">使用 Azure 负载均衡器可以：</span><span class="sxs-lookup"><span data-stu-id="0a8c4-296">You can use Azure Load Balancer to:</span></span>

  - <span data-ttu-id="0a8c4-297">对 Vm 进行负载平衡传入 Internet 流量。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-297">Load-balance incoming Internet traffic to your VMs.</span></span> <span data-ttu-id="0a8c4-298">此配置称为[*公共负载均衡器*](/azure/load-balancer/load-balancer-overview#publicloadbalancer)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-298">This configuration is known as a [*public Load Balancer*](/azure/load-balancer/load-balancer-overview#publicloadbalancer).</span></span>
  - <span data-ttu-id="0a8c4-299">对虚拟网络中 VM 之间的流量进行负载均衡。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-299">Load-balance traffic across VMs inside a virtual network.</span></span> <span data-ttu-id="0a8c4-300">还可以在混合方案中从本地网络访问负载均衡器前端。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-300">You can also reach a Load Balancer front end from an on-premises network in a hybrid scenario.</span></span> <span data-ttu-id="0a8c4-301">这两种方案使用的配置，称为[*内部负载均衡器*](/azure/load-balancer/load-balancer-overview#internalloadbalancer)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-301">Both scenarios use a configuration that is known as an [*internal Load Balancer*](/azure/load-balancer/load-balancer-overview#internalloadbalancer).</span></span>
  - <span data-ttu-id="0a8c4-302">端口流量转发到特定 Vm 的入站的网络地址转换 (NAT) 规则上的各端口。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-302">Port forward traffic to an itemized port on specific VMs with inbound network address translation (NAT) rules.</span></span>
  - <span data-ttu-id="0a8c4-303">使用公共负载均衡器为虚拟网络中的 VM 提供[出站连接](/azure/load-balancer/load-balancer-outbound-connections)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-303">Provide [outbound connectivity](/azure/load-balancer/load-balancer-outbound-connections) for VMs inside your virtual network by using a public Load Balancer.</span></span>

- <span data-ttu-id="0a8c4-304">**平衡跨区域使用流量管理器，如 Azure 流量管理器的负载。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-304">**Balance loads across regions with a traffic manager, such as Azure Traffic Manager.**</span></span> <span data-ttu-id="0a8c4-305">跨区域的流量进行负载平衡需要使用流量管理解决方案，以及 Azure 提供了[流量管理器](https://azure.microsoft.com/services/traffic-manager/)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-305">To load-balance traffic across regions requires a traffic management solution, and Azure provides [Traffic Manager](https://azure.microsoft.com/services/traffic-manager/).</span></span> <span data-ttu-id="0a8c4-306">您还可以利用提供类似的流量管理功能的第三方服务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-306">You can also take advantage of third-party services that provide similar traffic-management capabilities.</span></span>

## <a name="implement-resiliency-strategies"></a><span data-ttu-id="0a8c4-307">实施复原策略</span><span class="sxs-lookup"><span data-stu-id="0a8c4-307">Implement resiliency strategies</span></span>

<span data-ttu-id="0a8c4-308">本部分介绍一些常见复原策略。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-308">This section describes some common resiliency strategies.</span></span> <span data-ttu-id="0a8c4-309">大多数这些策略并不局限于特定的技术。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-309">Most of these strategies are not limited to a particular technology.</span></span> <span data-ttu-id="0a8c4-310">说明汇总了每种技术背后的一般理念和包括更多参考资料的链接。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-310">The descriptions summarize the general idea behind each technique and include links to further reading.</span></span>

- <span data-ttu-id="0a8c4-311">**实现复原模式**为远程操作，在适当的位置。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-311">**Implement resiliency patterns** for remote operations, where appropriate.</span></span> <span data-ttu-id="0a8c4-312">如果你的应用程序依赖于远程服务之间的通信，请按照[的设计模式](../patterns/category/resiliency.md)来处理暂时性故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-312">If your application depends on communication between remote services, follow [design patterns](../patterns/category/resiliency.md) for dealing with transient failures.</span></span>

- <span data-ttu-id="0a8c4-313">**重试暂时性故障。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-313">**Retry transient failures.**</span></span> <span data-ttu-id="0a8c4-314">这些可能被引起瞬间断开网络连接、 删除了数据库连接或超时当服务繁忙时。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-314">These can be caused by momentary loss of network connectivity, a dropped database connection, or a timeout when a service is busy.</span></span> <span data-ttu-id="0a8c4-315">通常情况下，可以通过重试请求解决暂时性故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-315">Often, a transient failure can be resolved by retrying the request.</span></span>

  - <span data-ttu-id="0a8c4-316">对于许多 Azure 服务，客户端软件开发工具包 (SDK) 中对调用方是透明的方式实施自动重试。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-316">For many Azure services, the client software development kit (SDK) implements automatic retries in a way that is transparent to the caller.</span></span> <span data-ttu-id="0a8c4-317">请参阅[重试的特定服务的指南](../best-practices/retry-service-specific.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-317">See [Retry guidance for specific services](../best-practices/retry-service-specific.md).</span></span>
  - <span data-ttu-id="0a8c4-318">或实现[重试模式](../patterns/retry.md)以帮助应用程序尝试连接到服务或网络资源时以透明方式处理预期的临时故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-318">Or implement the [Retry pattern](../patterns/retry.md) to help the application handle anticipated, temporary failures transparently when it tries to connect to a service or network resource.</span></span>

- <span data-ttu-id="0a8c4-319">**使用断路器**来处理这些可能需要变量长的时间，若要修复的错误。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-319">**Use a circuit breaker** to handle faults that might take a variable amount of time to fix.</span></span> <span data-ttu-id="0a8c4-320">[断路器模式](../patterns/circuit-breaker.md)可以防止应用程序重复尝试的操作，则可能会失败。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-320">The [Circuit Breaker pattern](../patterns/circuit-breaker.md) can prevent an application from repeatedly trying an operation that is likely to fail.</span></span> <span data-ttu-id="0a8c4-321">断路器会包装对服务的调用，并跟踪最近发生故障的次数。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-321">The circuit breaker wraps calls to a service and tracks the number of recent failures.</span></span> <span data-ttu-id="0a8c4-322">如果故障计数超过阈值，断路器将开始返回错误代码而不会调用该服务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-322">If the failure count exceeds a threshold, the circuit breaker starts returning an error code without calling the service.</span></span> <span data-ttu-id="0a8c4-323">这使得服务有时间恢复，并有助于避免级联故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-323">This gives the service time to recover and helps avoid cascading failures.</span></span>
- <span data-ttu-id="0a8c4-324">**隔离关键资源。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-324">**Isolate critical resources.**</span></span> <span data-ttu-id="0a8c4-325">一个子系统发生故障有时会造成连锁反应，导致应用程序的其他部分中的失败。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-325">Failures in one subsystem can sometimes cascade, resulting in failures in other parts of the application.</span></span> <span data-ttu-id="0a8c4-326">如果故障防止资源，例如线程或套接字被释放，从而导致资源耗尽，则可能发生此问题。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-326">This can happen if a failure prevents resources such as threads or sockets from being freed, leading to resource exhaustion.</span></span> <span data-ttu-id="0a8c4-327">若要避免此问题，您可以将系统分区为独立的组，以便一个分区中的故障不会导致整个系统瘫痪。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-327">To avoid this, you can partition a system into isolated groups so that a failure in one partition does not bring down the entire system.</span></span>

    <span data-ttu-id="0a8c4-328">下面是一些示例的这一技术，有时称为[隔舱模式](../patterns/bulkhead.md):</span><span class="sxs-lookup"><span data-stu-id="0a8c4-328">Here are some examples of this technique, which is sometimes called the [Bulkhead pattern](../patterns/bulkhead.md):</span></span>

  - <span data-ttu-id="0a8c4-329">分区数据库 （例如，由租户中），并将分配一个单独的池的 web 服务器实例的每个分区。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-329">Partition a database (for example, by tenant), and assign a separate pool of web server instances for each partition.</span></span>
  - <span data-ttu-id="0a8c4-330">使用单独的线程池来隔离对不同服务发出的调用。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-330">Use separate thread pools to isolate calls to different services.</span></span> <span data-ttu-id="0a8c4-331">这有助于防止其中一个服务发生故障时出现连发故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-331">This helps to prevent cascading failures if one of the services fails.</span></span> <span data-ttu-id="0a8c4-332">有关示例，请参阅 Netflix [Hystrix 库](https://medium.com/netflix-techblog/introducing-hystrix-for-resiliency-engineering-13531c1ab362)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-332">For an example, see the Netflix [Hystrix library](https://medium.com/netflix-techblog/introducing-hystrix-for-resiliency-engineering-13531c1ab362).</span></span>
  - <span data-ttu-id="0a8c4-333">使用[容器](https://en.wikipedia.org/wiki/Operating-system-level_virtualization)来限制特定子系统可用的资源。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-333">Use [containers](https://en.wikipedia.org/wiki/Operating-system-level_virtualization) to limit the resources available to a particular subsystem.</span></span>

      ![隔舱模式图](_images/bulkhead.png)

- <span data-ttu-id="0a8c4-335">**将应用[*补偿事务*](../patterns/compensating-transaction.md)**。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-335">**Apply [*compensating transactions*](../patterns/compensating-transaction.md)**.</span></span> <span data-ttu-id="0a8c4-336">补偿事务是用于消除另一个已完成的事务所造成的影响的事务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-336">A compensating transaction is a transaction that undoes the effects of another completed transaction.</span></span> <span data-ttu-id="0a8c4-337">在分布式系统中，它可能很难实现事务强一致性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-337">In a distributed system, it can be difficult to achieve strong transactional consistency.</span></span> <span data-ttu-id="0a8c4-338">补偿事务有助于实现一致性使用一系列的较小的独立事务，可以撤消在每个步骤。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-338">Compensating transactions help to achieve consistency by using a series of smaller, individual transactions that can be undone at each step.</span></span> <span data-ttu-id="0a8c4-339">例如，若要预订行程，客户可能需要预约租车、客房和航班。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-339">For example, to book a trip, a customer might reserve a car, a hotel room, and a flight.</span></span> <span data-ttu-id="0a8c4-340">如果其中一个步骤失败，则整个操作失败。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-340">If one of these steps fails, the entire operation fails.</span></span> <span data-ttu-id="0a8c4-341">我们可以针对每个步骤定义一个补偿事务，而不用尝试对整个操作使用单个分布式事务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-341">Instead of trying to use a single distributed transaction for the entire operation, you can define a compensating transaction for each step.</span></span>
- <span data-ttu-id="0a8c4-342">**实现异步操作，只要有可能。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-342">**Implement asynchronous operations, whenever possible.**</span></span> <span data-ttu-id="0a8c4-343">同步操作可能会独占资源，并在调用方等待进程完成时阻塞其他操作。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-343">Synchronous operations can monopolize resources and block other operations while the caller waits for the process to complete.</span></span> <span data-ttu-id="0a8c4-344">设计应用程序以允许在异步操作，只要有可能的每个部分。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-344">Design each part of your application to allow for asynchronous operations, whenever possible.</span></span> <span data-ttu-id="0a8c4-345">有关如何在 C 中实现异步编程的详细信息\#，请参阅[异步编程](/dotnet/articles/csharp/async)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-345">For more information on how to implement asynchronous programming in C\#, see [Asynchronous Programming](/dotnet/articles/csharp/async).</span></span>

## <a name="ensure-that-availability-meets-slas"></a><span data-ttu-id="0a8c4-346">确保可用性，满足服务级别协议</span><span class="sxs-lookup"><span data-stu-id="0a8c4-346">Ensure that availability meets SLAs</span></span>

<span data-ttu-id="0a8c4-347">*可用性*是一个系统且操作正常工作的时间比例，最好之一[软件质量的构成要素](../guide/pillars.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-347">*Availability* is the proportion of time that a system is functional and working, and it is one of the [pillars of software quality](../guide/pillars.md).</span></span> <span data-ttu-id="0a8c4-348">使用在本部分中的任务，以查看应用程序体系结构从可用性角度来看，确保你的可用性满足你的 Sla。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-348">Use the tasks in this section to review your application architecture from an availability standpoint to make sure that your availability meets your SLAs.</span></span>

- <span data-ttu-id="0a8c4-349">**避免任何单点故障。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-349">**Avoid any single point of failure.**</span></span> <span data-ttu-id="0a8c4-350">为避免单点故障影响可用性，应该将所有组件、服务、资源和计算实例部署为多个实例。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-350">All components, services, resources, and compute instances should be deployed as multiple instances to prevent a single point of failure from affecting availability.</span></span> <span data-ttu-id="0a8c4-351">身份验证机制也可以是单一故障点。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-351">Authentication mechanisms can also be a single point of failure.</span></span> <span data-ttu-id="0a8c4-352">如果平台自动执行此操作不是可配置为使用多个实例和要自动检测故障并将请求重定向到未失败的实例，将应用程序设计。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-352">Design the application to be configurable to use multiple instances and to automatically detect failures and redirect requests to non-failed instances, if the platform doesn't do this automatically.</span></span>
- <span data-ttu-id="0a8c4-353">**根据服务级别目标解构工作负荷。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-353">**Decompose workloads by service-level objective.**</span></span> <span data-ttu-id="0a8c4-354">如果服务由重要和比较不重要的工作负荷组成，请以不同的方式进行管理，并指定服务功能和实例数，以符合其可用性要求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-354">If a service is composed of critical and less-critical workloads, manage them differently and specify the service features and number of instances to meet their availability requirements.</span></span>
- <span data-ttu-id="0a8c4-355">**最小化和了解服务依赖项。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-355">**Minimize and understand service dependencies.**</span></span> <span data-ttu-id="0a8c4-356">可能的位置使用的不同服务的数量降至最低。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-356">Minimize the number of different services used, where possible.</span></span> <span data-ttu-id="0a8c4-357">请确保您理解所有功能和服务依赖关系的系统中存在。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-357">Ensure that you understand all the feature and service dependencies that exist in the system.</span></span> <span data-ttu-id="0a8c4-358">具体而言，了解故障或每个依赖项中的性能降低的整体影响。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-358">In particular, understand the overall impact of failure or reduced performance in each dependency.</span></span>
- <span data-ttu-id="0a8c4-359">**将任务和消息设计*幂等*，在可能的情况。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-359">**Design tasks and messages to be *idempotent*, where possible.**</span></span> <span data-ttu-id="0a8c4-360">如果某个操作可以重复多次且生成相同的结果，则该操作是幂等的。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-360">An operation is idempotent if it can be repeated multiple times and produce the same result.</span></span> <span data-ttu-id="0a8c4-361">这可以确保重复的请求不会导致问题。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-361">This can ensure that duplicated requests don't cause problems.</span></span> <span data-ttu-id="0a8c4-362">消息使用者与它们执行的操作应该具有幂等性，以便重复以前执行的操作不会使结果无效。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-362">Message consumers and the operations they carry out should be idempotent so that repeating a previously executed operation does not render the results invalid.</span></span> <span data-ttu-id="0a8c4-363">这可能意味着检测重复消息或使用乐观方法来处理冲突以确保一致性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-363">This may mean detecting duplicated messages or ensuring consistency by using an optimistic approach to handling conflicts.</span></span>
- <span data-ttu-id="0a8c4-364">**配置请求超时。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-364">**Configure request timeouts.**</span></span> <span data-ttu-id="0a8c4-365">服务和资源可能会变为不可用，导致请求失败。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-365">Services and resources may become unavailable, causing requests to fail.</span></span> <span data-ttu-id="0a8c4-366">确保应用的超时适合每个服务或资源并且客户端，正访问它们。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-366">Ensure that the timeouts you apply are appropriate for each service or resource and for the client that is accessing them.</span></span> <span data-ttu-id="0a8c4-367">在某些情况下，可能需要根据客户端正在执行的上下文和其他操作，对特定的客户端实例允许较长的超时。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-367">In some cases, you might allow a longer timeout for a particular instance of a client, depending on the context and other actions that the client is performing.</span></span> <span data-ttu-id="0a8c4-368">较短的超时可能会导致服务和较长延迟的资源的过多的重试操作。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-368">Short timeouts may cause excessive retry operations for services and resources that have considerable latency.</span></span> <span data-ttu-id="0a8c4-369">长的超时可能会导致阻塞，如果大量的请求正在排队等待服务或资源做出响应。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-369">Long timeouts can cause blocking, if a large number of requests are queued, waiting for a service or resource to respond.</span></span>
- <span data-ttu-id="0a8c4-370">**使用消息代理来为重要事务实现高可用性。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-370">**Use a message broker that implements high availability for critical transactions.**</span></span> <span data-ttu-id="0a8c4-371">许多云应用程序使用消息传递来触发异步任务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-371">Many cloud applications use messaging to trigger asynchronous tasks.</span></span> <span data-ttu-id="0a8c4-372">若要保证传送消息，消息传送系统应提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-372">To guarantee delivery of messages, the messaging system should provide high availability.</span></span> <span data-ttu-id="0a8c4-373">[Azure 服务总线消息传送](/azure/service-bus-messaging)实现*至少一次*语义，这意味着，保证消息至少一次传递。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-373">[Azure Service Bus messaging](/azure/service-bus-messaging) implements *at least once* semantics, which means that a message is guaranteed to be delivered at least once.</span></span> <span data-ttu-id="0a8c4-374">某些情况下，可能会发送重复的消息。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-374">Duplicate messages may be delivered under certain circumstances.</span></span> <span data-ttu-id="0a8c4-375">如果消息处理是幂等的（请参阅前一项），则重复传送应该不是问题。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-375">If message processing is idempotent (see the previous item), repeated delivery should not be a problem.</span></span>
- <span data-ttu-id="0a8c4-376">**限制高访问量用户。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-376">**Throttle high-volume users.**</span></span> <span data-ttu-id="0a8c4-377">有时，少量的用户创建的负载过多。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-377">Sometimes, a small number of users creates excessive load.</span></span> <span data-ttu-id="0a8c4-378">这可能会影响对其他用户，并会降低您的应用程序的总体可用性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-378">This can have an impact on other users and can reduce the overall availability of your application.</span></span> <span data-ttu-id="0a8c4-379">当单个客户端发出请求的次数过多时，应用程序可能会在特定期限内限制该客户端。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-379">When a single client makes an excessive number of requests, the application might throttle the client for a certain period.</span></span> <span data-ttu-id="0a8c4-380">在限制期间，应用程序会部分或全部请求拒绝来自该客户端。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-380">During the throttling period, the application refuses some or all of the requests from that client.</span></span> <span data-ttu-id="0a8c4-381">限制阈值通常取决于客户的服务层。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-381">The threshold for throttling often depends on the customer's service tier.</span></span> <span data-ttu-id="0a8c4-382">有关详细信息，请参阅[限制模式](../patterns/throttling.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-382">For more information, see [Throttling pattern](../patterns/throttling.md).</span></span>

    <span data-ttu-id="0a8c4-383">限制并不意味着，客户端一定恶意&mdash;只表示它超出了其服务配额。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-383">Throttling does not imply that the client was necessarily acting maliciously &mdash; only that it exceeded its service quota.</span></span> <span data-ttu-id="0a8c4-384">在某些情况下，使用者可能一贯地超出其配额或行为异常。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-384">In some cases, a consumer might consistently exceed their quota or otherwise behave badly.</span></span> <span data-ttu-id="0a8c4-385">在此情况下，可以进一步阻止该用户。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-385">In that case, you might go further and block the user.</span></span> <span data-ttu-id="0a8c4-386">为此，通常可以阻止其 API 密钥或 IP 地址范围。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-386">Typically, this is done by blocking an API key or an IP address range.</span></span>
- <span data-ttu-id="0a8c4-387">**将应用程序设计为可正常降级。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-387">**Design applications to gracefully degrade.**</span></span> <span data-ttu-id="0a8c4-388">应用程序上的负载可能超出一个或多个部件的容量，导致降低可用性和连接失败。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-388">The load on an application may exceed the capacity of one or more parts, causing reduced availability and failed connections.</span></span> <span data-ttu-id="0a8c4-389">缩放可以缓解此问题，但它可能会达到资源可用性或成本等其他因素施加的限制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-389">Scaling can mitigate this problem, but it may reach a limit imposed by other factors, such as resource availability or cost.</span></span> <span data-ttu-id="0a8c4-390">当应用程序达到资源限制时，应采取适当的措施来尽量减小对用户的影响。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-390">When an application reaches a resource limit, it should take appropriate action to minimize the impact for the user.</span></span> <span data-ttu-id="0a8c4-391">例如，在电子商务系统中，如果订单处理子系统处于疲劳或发生故障，它可以暂时禁用同时允许其他功能，例如浏览产品目录。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-391">For example, in an e-commerce system, if the order-processing subsystem is under strain or fails, it can be temporarily disabled while allowing other functionality, such as browsing the product catalog.</span></span> <span data-ttu-id="0a8c4-392">它可能适合延后发出的请求对故障子系统&mdash;等仍允许客户提交订单，但是对于更高版本的处理，当在订单子系统再次可用时。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-392">It might be appropriate to postpone requests to a failing subsystem &mdash; for example, still enabling customers to submit orders but saving them for later processing, when the orders subsystem is available again.</span></span>
- <span data-ttu-id="0a8c4-393">**适当处理急剧突发事件。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-393">**Gracefully handle rapid burst events.**</span></span> <span data-ttu-id="0a8c4-394">大多数应用程序需要在不同的时间处理不同的工作负荷。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-394">Most applications need to handle varying workloads over time.</span></span> <span data-ttu-id="0a8c4-395">自动缩放有助于处理负载，但它可能需要一些时间使其他实例联机并处理请求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-395">Autoscaling can help to handle the load, but it may take some time for additional instances to come online and handle requests.</span></span> <span data-ttu-id="0a8c4-396">若要防止高峰活动的应用程序，设计为将使用的服务和队列即将容量时适当降级请求队列。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-396">To prevent bursts of activity from overwhelming the application, design it to queue requests to the services it uses and to degrade gracefully when queues are near capacity.</span></span> <span data-ttu-id="0a8c4-397">请确保有足够的性能和容量可在非高峰条件清空队列和处理未完成的请求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-397">Ensure there is sufficient performance and capacity available under non-burst conditions to drain the queues and handle outstanding requests.</span></span> <span data-ttu-id="0a8c4-398">有关详细信息，请参阅[基于队列的负载调节模式](../patterns/queue-based-load-leveling.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-398">For more information, see the [Queue-Based Load Leveling pattern](../patterns/queue-based-load-leveling.md).</span></span>
- <span data-ttu-id="0a8c4-399">**组建或故障回复到多个组件。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-399">**Compose or fail back to multiple components.**</span></span> <span data-ttu-id="0a8c4-400">设计应用程序使用多个实例且不影响操作和现有连接，在可能的情况。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-400">Design applications to use multiple instances without affecting operation and existing connections, where possible.</span></span> <span data-ttu-id="0a8c4-401">若要最大化可用性、 使用多个实例并将它们之间的请求和检测和避免将请求发送到失败的实例。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-401">To maximize availability, use multiple instances and distribute requests between them, and detect and avoid sending requests to failed instances.</span></span>
- <span data-ttu-id="0a8c4-402">**故障回复到不同的服务或工作流。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-402">**Fail back to a different service or workflow.**</span></span> <span data-ttu-id="0a8c4-403">例如，如果写入 SQL 数据库失败，请暂时将数据存储在 Blob 存储或 Redis 缓存。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-403">For example, if writing to SQL Database fails, temporarily store data in Blob storage or Redis Cache.</span></span> <span data-ttu-id="0a8c4-404">提供某种途径方便在服务可用时将数据重新写入 SQL 数据库。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-404">Provide a way to replay the writes to SQL Database when the service becomes available.</span></span> <span data-ttu-id="0a8c4-405">在某些情况下，失败的操作可能有替代操作允许应用程序可继续工作，即使组件或服务失败时。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-405">In some cases, a failed operation may have an alternative action that allows the application to continue to work, even when a component or service fails.</span></span> <span data-ttu-id="0a8c4-406">如果可能，请检测故障并将请求重定向到其他服务，主服务处于脱机状态时。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-406">If possible, detect failures and redirect requests to other services while the primary service is offline.</span></span>
- <span data-ttu-id="0a8c4-407">**使用负载调控来平缓流量高峰。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-407">**Use load leveling to smooth out spikes in traffic.**</span></span> <span data-ttu-id="0a8c4-408">应用程序可能会遇到突发高峰流量，在后端的服务瘫痪。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-408">Applications may experience sudden spikes in traffic, which can overwhelm services on the back end.</span></span> <span data-ttu-id="0a8c4-409">如果后端服务无法足够快的速度响应请求，可能会累积过挂起的请求或服务可能会限制应用程序。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-409">If a back-end service cannot respond to requests quickly enough, the pending requests may accumulate or the service may throttle the application.</span></span> <span data-ttu-id="0a8c4-410">为了避免此问题，可以使用队列作为缓冲区。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-410">To avoid this, you can use a queue as a buffer.</span></span> <span data-ttu-id="0a8c4-411">新工作项，而不是立即调用后端服务时应用程序队列工作项以异步方式运行。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-411">When there is a new work item, instead of calling the back-end service immediately, the application queues a work item to run asynchronously.</span></span> <span data-ttu-id="0a8c4-412">队列充当可平缓负载高峰的缓冲区。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-412">The queue acts as a buffer that smooths out peaks in the load.</span></span> <span data-ttu-id="0a8c4-413">有关详细信息，请参阅[基于队列的负载调节模式](../patterns/queue-based-load-leveling.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-413">For more information, see [Queue-Based Load Leveling pattern](../patterns/queue-based-load-leveling.md).</span></span>

## <a name="manage-your-data"></a><span data-ttu-id="0a8c4-414">管理你的数据</span><span class="sxs-lookup"><span data-stu-id="0a8c4-414">Manage your data</span></span>

<span data-ttu-id="0a8c4-415">如何管理你的数据起着直接在应用程序的可用性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-415">How you manage your data plays directly into the availability of your application.</span></span> <span data-ttu-id="0a8c4-416">在本部分中的任务可以帮助您创建了管理计划，以帮助确保可用性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-416">The tasks in this section can help you create a management plan to help ensure availability.</span></span>

- <span data-ttu-id="0a8c4-417">**复制数据，并了解应用程序的数据存储的复制方法。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-417">**Replicate data and understand the replication methods for your application's data stores.**</span></span> <span data-ttu-id="0a8c4-418">复制数据是处理数据存储中非暂时性故障的常规策略。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-418">Replicating data is a general strategy for handling non-transient failures in a data store.</span></span> <span data-ttu-id="0a8c4-419">请考虑读取和写入路径。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-419">Consider both the read and write paths.</span></span> <span data-ttu-id="0a8c4-420">具体取决于存储技术，可能有多个可写副本或可能具有单个可写副本和多个只读副本。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-420">Depending on the storage technology, you might have multiple writable replicas or you might have a single writable replica and multiple read-only replicas.</span></span> <span data-ttu-id="0a8c4-421">为了最大程度地提高可用性，可将副本放在多个区域。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-421">To maximize availability, replicas can be placed in multiple regions.</span></span> <span data-ttu-id="0a8c4-422">但是，此方法会在复制数据时增加延迟时间。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-422">However, this approach increases the latency when replicating the data.</span></span> <span data-ttu-id="0a8c4-423">跨区域复制通常是以异步方式执行的，这意味着，如果某个副本发生故障，将无法遵循最终一致性模型，并可能会丢失数据。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-423">Typically, replicating across regions is done asynchronously, which implies an eventual consistency model and potential data loss if a replica fails.</span></span>  

  <span data-ttu-id="0a8c4-424">可以使用[Azure Site Recovery](/azure/site-recovery/azure-to-azure-quickstart/)若要将 Azure 虚拟机从一个区域复制到另一个。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-424">You can use [Azure Site Recovery](/azure/site-recovery/azure-to-azure-quickstart/) to replicate Azure Virtual Machines from one region to another.</span></span> <span data-ttu-id="0a8c4-425">Site Recovery 将向目标区域持续复制数据。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-425">Site Recovery replicates data continuously to the target region.</span></span> <span data-ttu-id="0a8c4-426">当在主站点发生中断时，可以故障转移到辅助位置。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-426">When an outage occurs at your primary site, you fail over to a secondary location.</span></span>

- <span data-ttu-id="0a8c4-427">**确保没有任何用户帐户同时有权访问生产和备份数据。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-427">**Ensure that no single user account has access to both production and backup data.**</span></span> <span data-ttu-id="0a8c4-428">如果单个用户帐户同时有权写入生产和备份源，则将会透露数据备份。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-428">Your data backups are compromised if one single user account has permission to write to both production and backup sources.</span></span> <span data-ttu-id="0a8c4-429">恶意用户可能有意删除所有数据，和普通用户可能意外都删除。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-429">A malicious user could purposely delete all your data, and a regular user could accidentally delete it.</span></span> <span data-ttu-id="0a8c4-430">应用程序设计为限制每个用户帐户的权限。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-430">Design your application to limit the permissions of each user account.</span></span> <span data-ttu-id="0a8c4-431">仅向需要这样做，用户授予写访问权限并授予对生产或备份，但不是能同时访问。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-431">Only grant write access to users who require it, and grant access to either production or backup, but not both.</span></span>
- <span data-ttu-id="0a8c4-432">**文档和测试数据存储故障转移和故障回复过程。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-432">**Document and test your data store failover and failback process.**</span></span> <span data-ttu-id="0a8c4-433">如果数据存储区失败灾难性的人工操作员必须遵循一组有案可稽的指令将故障转移到新的数据存储。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-433">If a data store fails catastrophically, a human operator must follow a set of documented instructions to fail over to a new data store.</span></span> <span data-ttu-id="0a8c4-434">如果有案可稽的步骤存在错误，操作员不能成功遵循它们并故障转移资源。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-434">If the documented steps have errors, an operator won't be able to successfully follow them and to fail over the resource.</span></span> <span data-ttu-id="0a8c4-435">定期测试说明步骤，以验证遵循文档运算符可以成功故障转移和故障回复。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-435">Regularly test the instruction steps to verify that an operator who follows the documentation can successfully fail over and fail back.</span></span>
- <span data-ttu-id="0a8c4-436">**备份数据并验证你的数据的备份。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-436">**Back up your data and validate your data backups.**</span></span> <span data-ttu-id="0a8c4-437">定期运行一个脚本来验证数据完整性、 架构和查询，以确保备份数据符合预期。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-437">Regularly run a script to validate data integrity, schema, and queries to ensure that backup data is what you expect.</span></span> <span data-ttu-id="0a8c4-438">记录并报告任何不一致情况，以便能够修复备份服务。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-438">Log and report any inconsistencies so the backup service can be repaired.</span></span>
- <span data-ttu-id="0a8c4-439">**使用定期备份和时间点还原。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-439">**Use periodic backup and point-in-time restore.**</span></span> <span data-ttu-id="0a8c4-440">定期和自动备份不会保留其他位置的数据。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-440">Regularly and automatically back up data that is not preserved elsewhere.</span></span> <span data-ttu-id="0a8c4-441">验证您能够可靠地恢复数据和应用程序本身是否发生故障。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-441">Verify that you can reliably restore both the data and the application itself if failure occurs.</span></span> <span data-ttu-id="0a8c4-442">请确保备份符合你的 RPO。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-442">Ensure that backups meet your RPO.</span></span> <span data-ttu-id="0a8c4-443">数据复制并不是备份功能，因为人为错误或恶意操作可能损坏所有副本中的数据。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-443">Data replication isn't a backup feature, because human error or malicious operations can corrupt data across all the replicas.</span></span> <span data-ttu-id="0a8c4-444">备份过程必须是安全的，这样才能保护传输中和存储中的数据。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-444">The backup process must be secure to protect the data in transit and in storage.</span></span> <span data-ttu-id="0a8c4-445">数据库可以通常恢复到以前的点在时间中使用事务日志。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-445">Databases can usually be recovered to a previous point in time by using transaction logs.</span></span> <span data-ttu-id="0a8c4-446">有关详细信息，请参阅[从数据损坏或意外删除中恢复](../resiliency/recovery-data-corruption.md)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-446">For more information, see [Recover from data corruption or accidental deletion](../resiliency/recovery-data-corruption.md).</span></span>
- <span data-ttu-id="0a8c4-447">**请考虑使用异地冗余存储帐户。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-447">**Consider using a geo-redundant storage account.**</span></span> <span data-ttu-id="0a8c4-448">Azure 存储帐户中存储的数据始终在本地复制。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-448">Data stored in an Azure Storage account is always replicated locally.</span></span> <span data-ttu-id="0a8c4-449">但是，有多个复制策略可供选择时预配的存储帐户。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-449">However, there are multiple replication strategies to choose from when a storage account is provisioned.</span></span> <span data-ttu-id="0a8c4-450">若要保护应用程序数据免受极少数情况下，当整个区域不可用时，请选择[Azure 读取访问异地冗余存储 (RA-GRS)](/azure/storage/storage-redundancy/#read-access-geo-redundant-storage)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-450">To protect your application data against the rare case when an entire region becomes unavailable, select [Azure Read-Access Geo-Redundant Storage (RA-GRS)](/azure/storage/storage-redundancy/#read-access-geo-redundant-storage).</span></span>  

    > [!NOTE]
    > <span data-ttu-id="0a8c4-451">对于 VM，请不要依赖于 RA-GRS 复制来还原 VM 磁盘（VHD 文件），</span><span class="sxs-lookup"><span data-stu-id="0a8c4-451">For VMs, do not rely on RA-GRS replication to restore the VM disks (VHD files).</span></span> <span data-ttu-id="0a8c4-452">而应该使用 [Azure 备份](/azure/backup)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-452">Instead, use [Azure Backup](/azure/backup).</span></span>

- <span data-ttu-id="0a8c4-453">**请考虑将引用数据部署到多个区域。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-453">**Consider deploying reference data to multiple regions.**</span></span> <span data-ttu-id="0a8c4-454">引用数据是支持应用程序功能的只读数据。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-454">Reference data is read-only data that supports application functionality.</span></span> <span data-ttu-id="0a8c4-455">它通常不经常更改。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-455">It typically doesn't change often.</span></span> <span data-ttu-id="0a8c4-456">尽管从备份中还原是处理区域范围的服务中断的一种方法，但 RTO 是相对较长。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-456">Although restoring from backup is one way to handle region-wide service disruptions, the RTO is relatively long.</span></span> <span data-ttu-id="0a8c4-457">将应用程序部署到次要区域后，有一些策略可改进引用数据的 RTO。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-457">When you deploy the application to a secondary region, some strategies can improve the RTO for reference data.</span></span>

    <span data-ttu-id="0a8c4-458">由于引用数据更改很少，因此可以通过维护次要区域中的永久副本，缩短 RTO。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-458">Because reference data changes infrequently, you can improve the RTO by maintaining a permanent copy in the secondary region.</span></span> <span data-ttu-id="0a8c4-459">这样就无需在发生灾难后还原备份的时间。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-459">This eliminates the time required to restore backups after a disaster.</span></span> <span data-ttu-id="0a8c4-460">要满足多区域灾难恢复要求，必须将应用程序和引用数据一起部署到多个区域。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-460">To meet the multiple-region disaster recovery requirements, you must deploy the application and the reference data together in multiple regions.</span></span>

- <span data-ttu-id="0a8c4-461">**使用乐观并发和最终一致性。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-461">**Use optimistic concurrency and eventual consistency.**</span></span> <span data-ttu-id="0a8c4-462">通过锁定资源访问的块的事务 (*保守式并发*) 可能会导致性能不佳并降低可用性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-462">Transactions that block access to resources through locking (*pessimistic concurrency*) can cause poor performance and reduce availability.</span></span> <span data-ttu-id="0a8c4-463">这些问题在分布式系统中可能会变得特别严重。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-463">These problems can become especially acute in distributed systems.</span></span> <span data-ttu-id="0a8c4-464">在许多情况下，精心的设计和技术，例如分区、 可以尽量减少发生更新冲突的可能性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-464">In many cases, careful design and techniques, such as partitioning, can minimize the chances of conflicting updates occurring.</span></span> <span data-ttu-id="0a8c4-465">如果复制或从独立更新的存储中读取数据，数据只会保持最终一致性。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-465">If data is replicated or read from a separately updated store, the data will only be eventually consistent.</span></span> <span data-ttu-id="0a8c4-466">但的优势通常超过使用事务来确保即时一致性的可用性的影响。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-466">But the advantages usually outweigh the impact on availability of using transactions to ensure immediate consistency.</span></span>
- <span data-ttu-id="0a8c4-467">**使用适用于 SQL 数据库的活动异地复制将更改复制到辅助数据库。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-467">**Use active geo-replication for SQL Database to replicate changes to a secondary database.**</span></span> <span data-ttu-id="0a8c4-468">为 SQL 数据库的活动异地复制会自动复制到同一区域或不同区域中辅助数据库的数据库更改。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-468">Active geo-replication for SQL Database automatically replicates database changes to secondary databases in the same region or a different region.</span></span> <span data-ttu-id="0a8c4-469">有关详细信息，请参阅[创建和使用活动异地复制](/azure/sql-database/sql-database-active-geo-replication)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-469">For more information, see [Creating and using active geo-replication](/azure/sql-database/sql-database-active-geo-replication).</span></span>

  <span data-ttu-id="0a8c4-470">或者，可以通过使用采用手动程度更高的方法**数据库复制**命令以创建事务上一致的数据库的备份副本。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-470">Alternatively, you can take a more manual approach by using the **DATABASE COPY** command to create a backup copy of the database with transactional consistency.</span></span> <span data-ttu-id="0a8c4-471">也可以使用 Azure SQL 数据库的导入/导出服务，该服务支持将数据库导出到存储在 Azure Blob 存储中的 BACPAC 文件（包含数据库架构和关联数据的压缩文件）。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-471">You can also use the import/export service of Azure SQL Database, which supports exporting databases to BACPAC files (compressed files containing your database schema and associated data) that are stored in Azure Blob storage.</span></span> <span data-ttu-id="0a8c4-472">Azure 存储的同一区域中创建备份文件的两个的副本。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-472">Azure Storage creates two replicas of the backup file in the same region.</span></span> <span data-ttu-id="0a8c4-473">但是，备份过程的频率决定 RPO，这是您可能会丢失在灾难方案中的数据量。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-473">However, the frequency of the backup process determines your RPO, which is the amount of data you might lose in disaster scenarios.</span></span> <span data-ttu-id="0a8c4-474">例如，如果备份了数据每隔一小时，而灾难发生在备份之前两分钟，你将失去 58 分钟的数据。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-474">For example, if you back up data every hour, and a disaster occurs two minutes before the backup, you will lose 58 minutes of data.</span></span> <span data-ttu-id="0a8c4-475">此外，为了应对区域范围的服务中断，应将 BACPAC 文件复制到备用区域。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-475">Also, to protect against a region-wide service disruption, you should copy the BACPAC files to an alternate region.</span></span> <span data-ttu-id="0a8c4-476">有关详细信息，请参阅[使用 Azure SQL 数据库确保业务连续性的概述](/azure/sql-database/sql-database-business-continuity)。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-476">For more information, see [Overview of business continuity with Azure SQL Database](/azure/sql-database/sql-database-business-continuity).</span></span>

- <span data-ttu-id="0a8c4-477">**为 SQL 数据仓库使用异地备份。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-477">**Use geo-backups for SQL Data Warehouse.**</span></span> <span data-ttu-id="0a8c4-478">对于 SQL 数据仓库，请使用[异地备份](/azure/sql-data-warehouse/backup-and-restore)还原到灾难恢复的配对区域。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-478">For SQL Data Warehouse, use [geo-backups](/azure/sql-data-warehouse/backup-and-restore) to restore to a paired region for disaster recovery.</span></span> <span data-ttu-id="0a8c4-479">这些备份会每隔 24 小时，并且可以在 20 分钟内恢复配对区域中。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-479">These backups are taken every 24 hours and can be restored within 20 minutes in the paired region.</span></span> <span data-ttu-id="0a8c4-480">此功能是在默认情况下，所有 SQL 数据仓库实例。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-480">This feature is on by default for all SQL Data Warehouse instances.</span></span> <span data-ttu-id="0a8c4-481">有关如何还原数据仓库的详细信息，请参阅[从使用 PowerShell 的 Azure 地理区域还原。](/azure/sql-data-warehouse/sql-data-warehouse-restore)</span><span class="sxs-lookup"><span data-stu-id="0a8c4-481">For more information on how to restore your data warehouse, see [Restore from an Azure geographical region using PowerShell.](/azure/sql-data-warehouse/sql-data-warehouse-restore)</span></span>

- <span data-ttu-id="0a8c4-482">**使用 Azure Site Recovery 复制 VM 磁盘。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-482">**Replicate VM disks using Azure Site Recovery.**</span></span> <span data-ttu-id="0a8c4-483">使用 Azure 虚拟机的复制时间[Site Recovery](/azure/site-recovery/)，所有 VM 磁盘会持续都复制到目标区域以异步方式。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-483">When you replicate Azure VMs using [Site Recovery](/azure/site-recovery/), all the VM disks are continuously replicated to the target region asynchronously.</span></span> <span data-ttu-id="0a8c4-484">每隔几分钟就会创建恢复点。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-484">The recovery points are created every few minutes.</span></span> <span data-ttu-id="0a8c4-485">这样，您几分钟 RPO。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-485">This gives you an RPO on the order of minutes.</span></span>
- <span data-ttu-id="0a8c4-486">**备份 Vm 上运行的 SQL Server 或配置日志传送会话。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-486">**Back up SQL Server running on VMs or configure a log-shipping session.**</span></span> <span data-ttu-id="0a8c4-487">对于 VM 上运行的 SQL Server，可以使用两个选项：传统备份和日志传送。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-487">For SQL Server running on VMs, there are two options: traditional backups and log shipping.</span></span> <span data-ttu-id="0a8c4-488">传统备份可以还原到的特定点的时间，但恢复过程较慢。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-488">Traditional backups enable you to restore to a specific point in time, but the recovery process is slow.</span></span> <span data-ttu-id="0a8c4-489">还原传统备份要求先进行初始的完整备份，然后将应用在此之后执行的所有备份。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-489">Restoring traditional backups requires that you start with an initial full backup and then apply any backups taken after that.</span></span> <span data-ttu-id="0a8c4-490">第二个选项是配置日志传送会话，延迟日志备份的还原 （例如，通过两个小时）。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-490">The second option is to configure a log-shipping session to delay the restore of log backups (for example, by two hours).</span></span> <span data-ttu-id="0a8c4-491">这就为从主要数据库发生的错误恢复提供了时间窗口。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-491">This provides a window to recover from errors made on the primary.</span></span>
- <span data-ttu-id="0a8c4-492">**自定义过程或第三方工具用于 Azure 存储备份。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-492">**Use a custom process or third-party tool for Azure Storage backup.**</span></span> <span data-ttu-id="0a8c4-493">对于 Azure 存储，可以开发自定义备份过程，或使用第三方备份工具。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-493">For Azure Storage, you can develop a custom backup process or use a third-party backup tool.</span></span> <span data-ttu-id="0a8c4-494">大多数应用程序设计中，还有其他复杂问题，其中，存储资源互相引用。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-494">Most application designs have additional complexities, in which storage resources reference each other.</span></span> <span data-ttu-id="0a8c4-495">例如，考虑具有一列的 SQL 数据库链接到 Azure 存储中的 blob。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-495">For example, consider a SQL database with a column that links to a blob in Azure Storage.</span></span> <span data-ttu-id="0a8c4-496">如果未能同时进行备份，则数据库可能会提供一个指针，指向在发生故障之前未备份的 Blob。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-496">If the backups do not happen simultaneously, the database might have a pointer to a blob that was not backed up before the failure.</span></span> <span data-ttu-id="0a8c4-497">应用程序或灾难恢复计划必须实现在恢复后处理这种不一致性的过程。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-497">The application or disaster recovery plan must implement processes to handle this inconsistency after a recovery.</span></span>
- <span data-ttu-id="0a8c4-498">**用于托管在 Vm 上的其他数据平台的本机复制或快照功能。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-498">**Use the native replication or snapshot capabilities for other data platforms hosted on VMs.**</span></span> <span data-ttu-id="0a8c4-499">其他数据平台，如 Elasticsearch 或 MongoDB，在创建集成的备份时有其自己的功能和注意事项，并还原过程。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-499">Other data platforms, such as Elasticsearch or MongoDB, have their own capabilities and considerations when creating an integrated backup and restore process.</span></span> <span data-ttu-id="0a8c4-500">对于这些数据平台，一般建议是使用任何本机或可用的集成基于的复制或快照功能。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-500">For these data platforms, the general recommendation is to use any native or available integration-based replication or snapshot capabilities.</span></span> <span data-ttu-id="0a8c4-501">如果这些功能不存在或不合适，请考虑使用 Azure 备份或磁盘快照创建应用程序数据的时间点副本。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-501">If those capabilities don't exist or aren't suitable, consider using Azure Backup or disk snapshots to create a point-in-time copy of application data.</span></span> <span data-ttu-id="0a8c4-502">在所有情况下，务必确定如何实现一致的备份，尤其是应用程序数据分布在多个文件系统或多个驱动器合并到单个文件系统时。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-502">In all cases, it's important to determine how to achieve consistent backups, especially when application data spans multiple files systems or multiple drives are combined into a single file system.</span></span>
- <span data-ttu-id="0a8c4-503">**了解应用程序数据源的复制方法。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-503">**Understand the replication methods for your application's data sources.**</span></span> <span data-ttu-id="0a8c4-504">应用程序数据将存储在不同的数据源，将具有不同的可用性要求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-504">Your application data will be stored in different data sources and will have varied availability requirements.</span></span> <span data-ttu-id="0a8c4-505">评估每种类型的数据存储在 Azure 中的复制方法包括[的 Azure 存储冗余](/azure/storage/storage-redundancy/)并[SQL 数据库活动异地复制](/azure/sql-database/sql-database-geo-replication-overview/)以确保应用程序的数据满足要求。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-505">Evaluate the replication methods for each type of data storage in Azure, including [Azure Storage redundancy](/azure/storage/storage-redundancy/) and [SQL Database active geo-replication](/azure/sql-database/sql-database-geo-replication-overview/) to ensure that your application's data requirements are satisfied.</span></span> <span data-ttu-id="0a8c4-506">如果使用的 Azure Vm 复制[Site Recovery](/azure/site-recovery/)，所有 VM 磁盘会持续都复制到目标区域以异步方式。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-506">If you replicate Azure VMs using [Site Recovery](/azure/site-recovery/), all the VM disks are continuously replicated to the target region asynchronously.</span></span> <span data-ttu-id="0a8c4-507">每隔几分钟就会创建恢复点。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-507">The recovery points are created every few minutes.</span></span>
- <span data-ttu-id="0a8c4-508">**建立灾难恢复的数据策略。**</span><span class="sxs-lookup"><span data-stu-id="0a8c4-508">**Establish data strategies for disaster recovery.**</span></span> <span data-ttu-id="0a8c4-509">正确的数据处理是任何灾难恢复计划的困难方面。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-509">Proper data handling is a challenging aspect of any disaster recovery plan.</span></span> <span data-ttu-id="0a8c4-510">在恢复过程中，数据还原通常最耗时间。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-510">During the recovery process, data restoration typically takes the most time.</span></span> <span data-ttu-id="0a8c4-511">为减弱功能做出的不同选择导致数据恢复和一致性面临严峻挑战。</span><span class="sxs-lookup"><span data-stu-id="0a8c4-511">Different choices for reducing functionality result in difficult challenges for data recovery and consistency.</span></span>

## <a name="next-steps"></a><span data-ttu-id="0a8c4-512">后续步骤</span><span class="sxs-lookup"><span data-stu-id="0a8c4-512">Next steps</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="0a8c4-513">复原能力和可用性测试</span><span class="sxs-lookup"><span data-stu-id="0a8c4-513">Test for resiliency and availability</span></span>](./testing.md)
