# <a name="choosing-a-compute-option-for-microservices"></a><span data-ttu-id="cd0e3-101">选择微服务的计算选项</span><span class="sxs-lookup"><span data-stu-id="cd0e3-101">Choosing a compute option for microservices</span></span>

<span data-ttu-id="cd0e3-102">术语“计算”指的是计算资源（应用程序在这些资源上运行）的承载模型。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-102">The term *compute* refers to the hosting model for the computing resources that your application runs on.</span></span> <span data-ttu-id="cd0e3-103">在微服务体系结构方面，有两种方案特别流行：</span><span class="sxs-lookup"><span data-stu-id="cd0e3-103">For a microservices architecture, two approaches are especially popular:</span></span>

- <span data-ttu-id="cd0e3-104">可管理专用节点 (VM) 上运行的服务的服务业务流程协调程序。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-104">A service orchestrator that manages services running on dedicated nodes (VMs).</span></span>
- <span data-ttu-id="cd0e3-105">使用函数即服务 (FaaS) 的无服务器体系结构。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-105">A serverless architecture using functions as a service (FaaS).</span></span>

<span data-ttu-id="cd0e3-106">尽管这不是仅有的两个选项，但两者是用于构建微服务的成熟方案。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-106">While these aren't the only options, they are both proven approaches to building microservices.</span></span> <span data-ttu-id="cd0e3-107">应用程序可以包含这两种方案。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-107">An application might include both approaches.</span></span>

## <a name="service-orchestrators"></a><span data-ttu-id="cd0e3-108">服务业务流程协调程序</span><span class="sxs-lookup"><span data-stu-id="cd0e3-108">Service orchestrators</span></span>

<span data-ttu-id="cd0e3-109">业务流程协调程序处理与一组服务的部署和管理相关的任务。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-109">An orchestrator handles tasks related to deploying and managing a set of services.</span></span> <span data-ttu-id="cd0e3-110">这些任务包括在节点上放置服务、监视服务运行状况、重启不正常的服务、对服务实例之间的网络流量进行负载均衡、服务发现、缩放服务实例的数目，以及应用配置更新。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-110">These tasks include placing services on nodes, monitoring the health of services, restarting unhealthy services, load balancing network traffic across service instances, service discovery, scaling the number of instances of a service, and applying configuration updates.</span></span> <span data-ttu-id="cd0e3-111">常用业务流程协调程序包括 Kubernetes、Service Fabric、DC/OS 和 Docker Swarm。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-111">Popular orchestrators include Kubernetes, Service Fabric, DC/OS, and Docker Swarm.</span></span>

<span data-ttu-id="cd0e3-112">在 Azure 平台上，请考虑以下选项：</span><span class="sxs-lookup"><span data-stu-id="cd0e3-112">On the Azure platform, consider the following options:</span></span>

- <span data-ttu-id="cd0e3-113">[Azure Kubernetes 服务](/azure/aks/) (AKS) 是托管的 Kubernetes 服务。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-113">[Azure Kubernetes Service](/azure/aks/) (AKS) is a managed Kubernetes service.</span></span> <span data-ttu-id="cd0e3-114">AKS 预配 Kubernetes 并公开 Kubernetes API 终结点，但可以承载和管理 Kubernetes 控制平面，并可以执行自动升级、自动修补、自动缩放和其他管理任务。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-114">AKS provisions Kubernetes and exposes the Kubernetes API endpoints, but hosts and manages the Kubernetes control plane, performing automated upgrades, automated patching, autoscaling, and other management tasks.</span></span> <span data-ttu-id="cd0e3-115">可将 AKS 视为“Kubernetes API 即服务”。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-115">You can think of AKS as being "Kubernetes APIs as a service."</span></span>

- <span data-ttu-id="cd0e3-116">[Service Fabric](/azure/service-fabric/) 是用于打包、部署和管理微服务的分布式系统平台。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-116">[Service Fabric](/azure/service-fabric/) is a distributed systems platform for packaging, deploying, and managing microservices.</span></span> <span data-ttu-id="cd0e3-117">可将微服务作为容器、二进制可执行文件或 [Reliable Services](/azure/service-fabric/service-fabric-reliable-services-introduction) 部署到 Service Fabric。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-117">Microservices can be deployed to Service Fabric as containers, as binary executables, or as [Reliable Services](/azure/service-fabric/service-fabric-reliable-services-introduction).</span></span> <span data-ttu-id="cd0e3-118">借助 Reliable Services 编程模型，服务可以直接使用 Service Fabric 编程 API 来查询系统、报告运行状况、接收有关配置和代码更改的通知，以及发现其他服务。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-118">Using the Reliable Services programming model, services can directly use Service Fabric programming APIs to query the system, report health, receive notifications about configuration and code changes, and discover other services.</span></span> <span data-ttu-id="cd0e3-119">它与 Service Fabric 之间的重要区别在于，它重点用于构建使用 [Reliable Collections](/azure/service-fabric/service-fabric-reliable-services-reliable-collections) 的有状态服务。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-119">A key differentiation with Service Fabric is its strong focus on building stateful services using [Reliable Collections](/azure/service-fabric/service-fabric-reliable-services-reliable-collections).</span></span>

- <span data-ttu-id="cd0e3-120">其他选项，例如 Docker 企业版和 Mesosphere DC/OS 上 Azure IaaS 环境中运行。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-120">Other options such as Docker Enterprise Edition and Mesosphere DC/OS can run in an IaaS environment on Azure.</span></span> <span data-ttu-id="cd0e3-121">有关部署模板[Azure Marketplace](https://azuremarketplace.microsoft.com)。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-121">You can find deployment templates on [Azure Marketplace](https://azuremarketplace.microsoft.com).</span></span>

## <a name="containers"></a><span data-ttu-id="cd0e3-122">容器</span><span class="sxs-lookup"><span data-stu-id="cd0e3-122">Containers</span></span>

<span data-ttu-id="cd0e3-123">有时，人们在谈论容器和微服务时将它们看作相同的事物。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-123">Sometimes people talk about containers and microservices as if they were the same thing.</span></span> <span data-ttu-id="cd0e3-124">尽管这种看法不对 &mdash; 不需要容器即可构建微服务 &mdash; 但是，容器确实有一些专门与微服务相关的优势，例如：</span><span class="sxs-lookup"><span data-stu-id="cd0e3-124">While that's not true &mdash; you don't need containers to build microservices &mdash; containers do have some benefits that are particularly relevant to microservices, such as:</span></span>

- <span data-ttu-id="cd0e3-125">**可移植性**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-125">**Portability**.</span></span> <span data-ttu-id="cd0e3-126">容器映像是一个独立包，无需安装库或其他依赖项即可运行。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-126">A container image is a standalone package that runs without needing to install libraries or other dependencies.</span></span> <span data-ttu-id="cd0e3-127">因此，它们的部署非常轻松。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-127">That makes them easy to deploy.</span></span> <span data-ttu-id="cd0e3-128">容器可以快速启动和停止，因此，我们可以运转新的实例来处理更多负载，或者在发生节点故障后进行恢复。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-128">Containers can be started and stopped quickly, so you can spin up new instances to handle more load or to recover from node failures.</span></span>

- <span data-ttu-id="cd0e3-129">**轻量且高效**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-129">**Density**.</span></span> <span data-ttu-id="cd0e3-130">与运行虚拟机相比，容器比较轻量，因为它们共享 OS 资源。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-130">Containers are lightweight compared with running a virtual machine, because they share OS resources.</span></span> <span data-ttu-id="cd0e3-131">因此，可将多个容器打包到单个节点。当应用程序由许多小型服务构成时，这种做法特别有利。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-131">That makes it possible to pack multiple containers onto a single node, which is especially useful when the application consists of many small services.</span></span>

- <span data-ttu-id="cd0e3-132">**资源隔离**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-132">**Resource isolation**.</span></span> <span data-ttu-id="cd0e3-133">可以限制容器可用的内存量和 CPU，这有助于确保失控的进程不会耗尽主机资源。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-133">You can limit the amount of memory and CPU that is available to a container, which can help to ensure that a runaway process doesn't exhaust the host resources.</span></span> <span data-ttu-id="cd0e3-134">有关详细信息，请参阅[隔舱模式](../../patterns/bulkhead.md)。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-134">See the [Bulkhead pattern](../../patterns/bulkhead.md) for more information.</span></span>

## <a name="serverless-functions-as-a-service"></a><span data-ttu-id="cd0e3-135">无服务器（函数即服务）</span><span class="sxs-lookup"><span data-stu-id="cd0e3-135">Serverless (Functions as a Service)</span></span>

<span data-ttu-id="cd0e3-136">使用[无服务器](https://azure.microsoft.com/solutions/serverless/)体系结构时，无需管理 VM 或虚拟网络基础结构。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-136">With a [serverless](https://azure.microsoft.com/solutions/serverless/) architecture, you don't manage the VMs or the virtual network infrastructure.</span></span> <span data-ttu-id="cd0e3-137">可以部署代码，然后让托管服务将该代码放入 VM 并执行。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-137">Instead, you deploy code and the hosting service handles putting that code onto a VM and executing it.</span></span> <span data-ttu-id="cd0e3-138">这种方法往往比较适合用于使用基于事件的触发器协调的小粒度函数。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-138">This approach tends to favor small granular functions that are coordinated using event-based triggers.</span></span> <span data-ttu-id="cd0e3-139">例如，放入队列的消息可能会触发一个函数，该函数从队列中读取并处理该消息。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-139">For example, a message being placed onto a queue might trigger a function that reads from the queue and processes the message.</span></span>

<span data-ttu-id="cd0e3-140">[Azure Functions](/azure/azure-functions/)是支持各种函数触发器，包括 HTTP 请求、 服务总线队列和事件中心事件的无服务器计算服务。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-140">[Azure Functions](/azure/azure-functions/) is a serverless compute service that supports various function triggers, including HTTP requests, Service Bus queues, and Event Hubs events.</span></span> <span data-ttu-id="cd0e3-141">有关完整列表，请参阅[Azure Functions 触发器和绑定概念](/azure/azure-functions/functions-triggers-bindings)。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-141">For a complete list, see [Azure Functions triggers and bindings concepts](/azure/azure-functions/functions-triggers-bindings).</span></span> <span data-ttu-id="cd0e3-142">此外应考虑[Azure 事件网格](/azure/event-grid/)，这是在 Azure 中托管的事件路由服务。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-142">Also consider [Azure Event Grid](/azure/event-grid/), which is a managed event routing service in Azure.</span></span>

<!-- markdownlint-disable MD026 -->

## <a name="orchestrator-or-serverless"></a><span data-ttu-id="cd0e3-143">选择业务流程协调程序还是无服务器？</span><span class="sxs-lookup"><span data-stu-id="cd0e3-143">Orchestrator or serverless?</span></span>

<!-- markdownlint-enable MD026 -->

<span data-ttu-id="cd0e3-144">在业务流程协调程序方案与无服务器方案之间做出选择时，请考虑下面一些因素。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-144">Here are some factors to consider when choosing between an orchestrator approach and a serverless approach.</span></span>

<span data-ttu-id="cd0e3-145">**易管理性**无服务器应用程序易于管理，因为平台可自行管理所有计算资源。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-145">**Manageability** A serverless application is easy to manage, because the platform manages all the of compute resources for you.</span></span> <span data-ttu-id="cd0e3-146">尽管业务流程协调程序可将群集管理和配置工作的某些方面抽象化，但它不会完全隐藏底层 VM。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-146">While an orchestrator abstracts some aspects of managing and configuring a cluster, it does not completely hide the underlying VMs.</span></span> <span data-ttu-id="cd0e3-147">使用业务流程协调程序时，需要考虑负载均衡、CPU 和内存使用率以及网络等方面的问题。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-147">With an orchestrator, you will need to think about issues such as load balancing, CPU and memory usage, and networking.</span></span>

<span data-ttu-id="cd0e3-148">**灵活性和控制**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-148">**Flexibility and control**.</span></span> <span data-ttu-id="cd0e3-149">在服务与群集的配置和管理方面，业务流程协调程序提供很高的控制度。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-149">An orchestrator gives you a great deal of control over configuring and managing your services and the cluster.</span></span> <span data-ttu-id="cd0e3-150">弊端是复杂性会增大。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-150">The tradeoff is additional complexity.</span></span> <span data-ttu-id="cd0e3-151">使用无服务器体系结构会牺牲一定的控制度，因为这些细节已抽象化。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-151">With a serverless architecture, you give up some degree of control because these details are abstracted.</span></span>

<span data-ttu-id="cd0e3-152">**可移植性**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-152">**Portability**.</span></span> <span data-ttu-id="cd0e3-153">此处列出的所有业务流程协调程序（Kubernetes、DC/OS、Docker Swarm 和 Service Fabric）都可以在本地或多个公有云中运行。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-153">All of the orchestrators listed here (Kubernetes, DC/OS, Docker Swarm, and Service Fabric) can run on-premises or in multiple public clouds.</span></span>

<span data-ttu-id="cd0e3-154">**应用程序集成**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-154">**Application integration**.</span></span> <span data-ttu-id="cd0e3-155">使用无服务器体系结构构建复杂应用程序可能有难度。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-155">It can be challenging to build a complex application using a serverless architecture.</span></span> <span data-ttu-id="cd0e3-156">在 Azure 中，一种做法是使用 [Azure 逻辑应用](/azure/logic-apps/)来协调一组 Azure 函数。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-156">One option in Azure is to use [Azure Logic Apps](/azure/logic-apps/) to coordinate a set of Azure Functions.</span></span> <span data-ttu-id="cd0e3-157">有关此方法的示例，请参阅[创建与 Azure 逻辑应用集成的函数](/azure/azure-functions/functions-twitter-email)。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-157">For an example of this approach, see [Create a function that integrates with Azure Logic Apps](/azure/azure-functions/functions-twitter-email).</span></span>

<span data-ttu-id="cd0e3-158">**成本**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-158">**Cost**.</span></span> <span data-ttu-id="cd0e3-159">使用业务流程协调程序时，需要为群集中运行的 VM 付费。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-159">With an orchestrator, you pay for the VMs that are running in the cluster.</span></span> <span data-ttu-id="cd0e3-160">使用无服务器应用程序时，只需为实际消耗的计算资源付费。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-160">With a serverless application, you pay only for the actual compute resources consumed.</span></span> <span data-ttu-id="cd0e3-161">在这两种情况下，都需要考虑到任何附加服务（例如存储、数据库和消息传递服务）的成本。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-161">In both cases, you need to factor in the cost of any additional services, such as storage, databases, and messaging services.</span></span>

<span data-ttu-id="cd0e3-162">**可伸缩性**。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-162">**Scalability**.</span></span> <span data-ttu-id="cd0e3-163">Azure Functions 可以根据传入事件的数目按需自动缩放。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-163">Azure Functions scales automatically to meet demand, based on the number of incoming events.</span></span> <span data-ttu-id="cd0e3-164">使用业务流程协调程序时，可以通过增加群集中运行的服务实例数进行横向扩展。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-164">With an orchestrator, you can scale out by increasing the number of service instances running in the cluster.</span></span> <span data-ttu-id="cd0e3-165">此外，可以通过将更多 VM 添加到群集进行扩展。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-165">You can also scale by adding additional VMs to the cluster.</span></span>

<span data-ttu-id="cd0e3-166">我们的参考实现主要使用 Kubernetes，但对“交付历史记录”服务使用了 Azure Functions。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-166">Our reference implementation primarily uses Kubernetes, but we did use Azure Functions for one service, namely the Delivery History service.</span></span> <span data-ttu-id="cd0e3-167">Azure Functions 非常适合此特定服务，因为它是事件驱动的工作负荷。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-167">Azure Functions was a good fit for this particular service, because it's is an event-driven workload.</span></span> <span data-ttu-id="cd0e3-168">该服务使用事件中心触发器来调用函数，因此只需少量的代码。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-168">By using an Event Hubs trigger to invoke the function, the service needed a minimal amount of code.</span></span> <span data-ttu-id="cd0e3-169">此外，“交付历史记录”服务并非主要工作流的一部分，因此，在 Kubernetes 群集外部运行该服务不会影响用户发起的操作的端到端延迟。</span><span class="sxs-lookup"><span data-stu-id="cd0e3-169">Also, the Delivery History service is not part of the main workflow, so running it outside of the Kubernetes cluster doesn't affect the end-to-end latency of user-initiated operations.</span></span>

## <a name="next-steps"></a><span data-ttu-id="cd0e3-170">后续步骤</span><span class="sxs-lookup"><span data-stu-id="cd0e3-170">Next steps</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="cd0e3-171">服务间通信</span><span class="sxs-lookup"><span data-stu-id="cd0e3-171">Interservice communication</span></span>](./interservice-communication.md)
