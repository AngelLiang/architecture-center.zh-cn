---
title: Azure IoT 参考体系结构
description: Azure 上使用 PaaS（平台即服务）组件的 IoT 应用程序的建议体系结构
titleSuffix: Azure Reference Architectures
author: MikeWasson
ms.date: 01/09/2019
ms.openlocfilehash: 04bff9419a30a3610d59e3ca8f27c004a0bcb2be
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59641121"
---
# <a name="azure-iot-reference-architecture"></a><span data-ttu-id="9805c-103">Azure IoT 参考体系结构</span><span class="sxs-lookup"><span data-stu-id="9805c-103">Azure IoT reference architecture</span></span>

<span data-ttu-id="9805c-104">本参考体系结构说明了 Azure 上使用 PaaS（平台即服务）组件的 IoT 应用程序的建议体系结构。</span><span class="sxs-lookup"><span data-stu-id="9805c-104">This reference architecture shows a recommended architecture for IoT applications on Azure using PaaS (platform-as-a-service) components.</span></span>

![体系结构图](./_images/iot.png)

<span data-ttu-id="9805c-106">IoT 应用程序可描述为发送生成**见解**的数据的**物**（设备）。</span><span class="sxs-lookup"><span data-stu-id="9805c-106">IoT applications can be described as **things** (devices) sending data that generates **insights**.</span></span> <span data-ttu-id="9805c-107">这些见解生成**操作**来改进业务或流程。</span><span class="sxs-lookup"><span data-stu-id="9805c-107">These insights generate **actions** to improve a business or process.</span></span> <span data-ttu-id="9805c-108">例如，一个发送温度数据的引擎（物）。</span><span class="sxs-lookup"><span data-stu-id="9805c-108">An example is an engine (the thing) sending temperature data.</span></span> <span data-ttu-id="9805c-109">此数据用于评估引擎是否按预期工作（见解）。</span><span class="sxs-lookup"><span data-stu-id="9805c-109">This data is used to evaluate whether the engine is performing as expected (the insight).</span></span> <span data-ttu-id="9805c-110">该见解用于主动优先引擎的维护计划（操作）。</span><span class="sxs-lookup"><span data-stu-id="9805c-110">The insight is used to proactively prioritize the maintenance schedule for the engine (the action).</span></span>

<span data-ttu-id="9805c-111">此参考体系结构使用 Azure PaaS（平台即服务）组件。</span><span class="sxs-lookup"><span data-stu-id="9805c-111">This reference architecture uses Azure PaaS (platform-as-a-service) components.</span></span> <span data-ttu-id="9805c-112">用于在 Azure 上构建 IoT 解决方案的其他选项包括：</span><span class="sxs-lookup"><span data-stu-id="9805c-112">Other options for building IoT solutions on Azure include:</span></span>

- <span data-ttu-id="9805c-113">[Azure IoT Central](/azure/iot-central/)。</span><span class="sxs-lookup"><span data-stu-id="9805c-113">[Azure IoT Central](/azure/iot-central/).</span></span> <span data-ttu-id="9805c-114">IoT Central 是完全托管的 SaaS（软件即服务）解决方案。</span><span class="sxs-lookup"><span data-stu-id="9805c-114">IoT Central is a fully managed SaaS (software-as-a-service) solution.</span></span> <span data-ttu-id="9805c-115">它抽象出技术选择，让你专注于你的解决方案。</span><span class="sxs-lookup"><span data-stu-id="9805c-115">It abstracts the technical choices and lets you focus on your solution exclusively.</span></span> <span data-ttu-id="9805c-116">随这种简单性而来的是一种折衷：可自定义的程度会低于基于 PaaS 的解决方案。</span><span class="sxs-lookup"><span data-stu-id="9805c-116">This simplicity comes with a tradeoff in being less customizable than a PaaS-based solution.</span></span>
- <span data-ttu-id="9805c-117">使用部署在 Azure VM 上的 SMACK 栈（Spark、Mesos、Akka、Cassandra、Kafka）等 OSS 组件。</span><span class="sxs-lookup"><span data-stu-id="9805c-117">Using OSS components such as the SMACK stack (Spark, Mesos, Akka, Cassandra, Kafka) deployed on Azure VMs.</span></span> <span data-ttu-id="9805c-118">此方法提供了很多控制，但更复杂。</span><span class="sxs-lookup"><span data-stu-id="9805c-118">This approach offers a great deal of control but is more complex.</span></span>

<span data-ttu-id="9805c-119">概括而言，处理遥测数据的方式有两种：热路径和冷路径。</span><span class="sxs-lookup"><span data-stu-id="9805c-119">At a high level, there are two ways to process telemetry data, hot path and cold path.</span></span> <span data-ttu-id="9805c-120">具体采用哪种方式与延迟和数据访问的要求有关。</span><span class="sxs-lookup"><span data-stu-id="9805c-120">The difference has to do with requirements for latency and data access.</span></span>

- <span data-ttu-id="9805c-121">**热路径**在数据到达时以近实时方式分析数据。</span><span class="sxs-lookup"><span data-stu-id="9805c-121">The **hot path** analyzes data in near-real-time, as it arrives.</span></span> <span data-ttu-id="9805c-122">在热路径中，必须以非常低的延迟处理遥测数据。</span><span class="sxs-lookup"><span data-stu-id="9805c-122">In the hot path, telemetry must be processed with very low latency.</span></span> <span data-ttu-id="9805c-123">热路径通常是使用流处理引擎实现的。</span><span class="sxs-lookup"><span data-stu-id="9805c-123">The hot path is typically implemented using a stream processing engine.</span></span> <span data-ttu-id="9805c-124">输出可能会触发一个警报，或写入为可以使用分析工具查询的结构化格式。</span><span class="sxs-lookup"><span data-stu-id="9805c-124">The output may trigger an alert, or be written to a structured format that can be queried using analytical tools.</span></span>
- <span data-ttu-id="9805c-125">**冷路径**以较长的时间间隔（每小时或每天）执行批处理。</span><span class="sxs-lookup"><span data-stu-id="9805c-125">The **cold path** performs batch processing at longer intervals (hourly or daily).</span></span> <span data-ttu-id="9805c-126">冷路径通常处理大量数据，但结果不需要与热路径一样及时。</span><span class="sxs-lookup"><span data-stu-id="9805c-126">The cold path typically operates over large volumes of data, but the results don't need to be as timely as the hot path.</span></span> <span data-ttu-id="9805c-127">在冷路径中，原始遥测数据会被捕获，然后馈送到批处理流程中。</span><span class="sxs-lookup"><span data-stu-id="9805c-127">In the cold path, raw telemetry is captured and then fed into a batch process.</span></span>

## <a name="architecture"></a><span data-ttu-id="9805c-128">体系结构</span><span class="sxs-lookup"><span data-stu-id="9805c-128">Architecture</span></span>

<span data-ttu-id="9805c-129">该体系结构包括以下组件。</span><span class="sxs-lookup"><span data-stu-id="9805c-129">This architecture consists of the following components.</span></span> <span data-ttu-id="9805c-130">某些应用程序可能不需要此处列出的每个组件。</span><span class="sxs-lookup"><span data-stu-id="9805c-130">Some applications may not require every component listed here.</span></span>

<span data-ttu-id="9805c-131">**IoT 设备**。</span><span class="sxs-lookup"><span data-stu-id="9805c-131">**IoT devices**.</span></span> <span data-ttu-id="9805c-132">设备可以安全地注册到云中，并且可以连接到云以发送和接收数据。</span><span class="sxs-lookup"><span data-stu-id="9805c-132">Devices can securely register with the cloud, and can connect to the cloud to send and receive data.</span></span> <span data-ttu-id="9805c-133">某些设备可能会是在设备本身上或在现场网关中执行一些数据处理的**边缘设备**。</span><span class="sxs-lookup"><span data-stu-id="9805c-133">Some devices may be **edge devices** that perform some data processing on the device itself or in a field gateway.</span></span> <span data-ttu-id="9805c-134">我们建议将 [Azure IoT Edge](/azure/iot-edge/) 用于边缘处理。</span><span class="sxs-lookup"><span data-stu-id="9805c-134">We recommend [Azure IoT Edge](/azure/iot-edge/) for edge processing.</span></span>

<span data-ttu-id="9805c-135">**云网关**。</span><span class="sxs-lookup"><span data-stu-id="9805c-135">**Cloud gateway**.</span></span> <span data-ttu-id="9805c-136">云网关提供一个云中心，以便设备安全地连接到云并发送数据。</span><span class="sxs-lookup"><span data-stu-id="9805c-136">A cloud gateway provides a cloud hub for devices to connect securely to the cloud and send data.</span></span> <span data-ttu-id="9805c-137">它还提供设备管理功能，包括设备的命令和控制。</span><span class="sxs-lookup"><span data-stu-id="9805c-137">It also provides device management, capabilities, including command and control of devices.</span></span> <span data-ttu-id="9805c-138">对于云网关，我们建议使用 [IoT 中心](/azure/iot-hub/)。</span><span class="sxs-lookup"><span data-stu-id="9805c-138">For the cloud gateway, we recommend [IoT Hub](/azure/iot-hub/).</span></span> <span data-ttu-id="9805c-139">IoT 中心是从设备引入事件的托管云服务，充当设备与后端服务之间的消息代理。</span><span class="sxs-lookup"><span data-stu-id="9805c-139">IoT Hub is a hosted cloud service that ingests events from devices, acting as a message broker between devices and backend services.</span></span> <span data-ttu-id="9805c-140">IoT 中心提供安全连接、事件引入、双向通信和设备管理。</span><span class="sxs-lookup"><span data-stu-id="9805c-140">IoT Hub provides secure connectivity, event ingestion, bidirectional communication, and device management.</span></span>

<span data-ttu-id="9805c-141">**设备预配**。</span><span class="sxs-lookup"><span data-stu-id="9805c-141">**Device provisioning.**</span></span> <span data-ttu-id="9805c-142">对于注册和连接许多组设备，我们建议使用 [IoT 中心设备预配服务](/azure/iot-dps/) (DPS)。</span><span class="sxs-lookup"><span data-stu-id="9805c-142">For registering and connecting large sets of devices, we recommend using the [IoT Hub Device Provisioning Service](/azure/iot-dps/) (DPS).</span></span> <span data-ttu-id="9805c-143">DPS 可用于大规模分配设备并将设备注册到特定 Azure IoT 中心终结点。</span><span class="sxs-lookup"><span data-stu-id="9805c-143">DPS lets you assign and register devices to specific Azure IoT Hub endpoints at scale.</span></span>

<span data-ttu-id="9805c-144">**流处理**。</span><span class="sxs-lookup"><span data-stu-id="9805c-144">**Stream processing**.</span></span> <span data-ttu-id="9805c-145">流处理分析数据记录的大型流，并评估这些流的规则。</span><span class="sxs-lookup"><span data-stu-id="9805c-145">Stream processing analyzes large streams of data records and evaluates rules for those streams.</span></span> <span data-ttu-id="9805c-146">对于流处理，我们建议使用 [Azure 流分析](/azure/stream-analytics/)。</span><span class="sxs-lookup"><span data-stu-id="9805c-146">For stream processing, we recommend [Azure Stream Analytics](/azure/stream-analytics/).</span></span> <span data-ttu-id="9805c-147">流分析可以使用时间开窗函数、流聚合和外部数据源联接大规模执行复杂分析。</span><span class="sxs-lookup"><span data-stu-id="9805c-147">Stream Analytics can execute complex analysis at scale, using time windowing functions, stream aggregations, and external data source joins.</span></span> <span data-ttu-id="9805c-148">另一个选项是 [Azure Databricks](/azure/azure-databricks/) 上的 Apache Spark。</span><span class="sxs-lookup"><span data-stu-id="9805c-148">Another option is Apache Spark on [Azure Databricks](/azure/azure-databricks/).</span></span>

<span data-ttu-id="9805c-149">使用机器学习可以针对历史遥测数据执行预测算法，从而实现预测性维护等方案。</span><span class="sxs-lookup"><span data-stu-id="9805c-149">Machine learning allows predictive algorithms to be executed over historical telemetry data, enabling scenarios such as predictive maintenance.</span></span> <span data-ttu-id="9805c-150">对于机器学习，我们建议使用 [Azure 机器学习服务](/azure/machine-learning/service/)。</span><span class="sxs-lookup"><span data-stu-id="9805c-150">For machine learning, we recommend [Azure Machine Learning Service](/azure/machine-learning/service/).</span></span>

<span data-ttu-id="9805c-151">**暖路径存储**保留一些数据，这些数据必须可从设备中立即提供，以用于报告和可视化。</span><span class="sxs-lookup"><span data-stu-id="9805c-151">**Warm path storage** holds data that must be available immediately from device for reporting and visualization.</span></span> <span data-ttu-id="9805c-152">对于暖路径存储，我们建议使用 [Cosmos DB](/azure/cosmos-db/introduction)。</span><span class="sxs-lookup"><span data-stu-id="9805c-152">For warm path storage, we recommend [Cosmos DB](/azure/cosmos-db/introduction).</span></span> <span data-ttu-id="9805c-153">Cosmos DB 是一种全球分布式多模型数据库。</span><span class="sxs-lookup"><span data-stu-id="9805c-153">Cosmos DB is a globally distributed, multi-model database.</span></span>

<span data-ttu-id="9805c-154">**冷路径存储**保留一些数据，这些数据会保留较长时间，以用于批处理。</span><span class="sxs-lookup"><span data-stu-id="9805c-154">**Cold path storage** holds data that is kept longer term and is used for batch processing.</span></span> <span data-ttu-id="9805c-155">对于冷路径存储，我们建议使用 [Azure Blob 存储](/azure/storage/blobs/storage-blobs-introduction)。</span><span class="sxs-lookup"><span data-stu-id="9805c-155">For cold path storage, we recommend [Azure Blob Storage](/azure/storage/blobs/storage-blobs-introduction).</span></span> <span data-ttu-id="9805c-156">数据可无限期地以较低成本在 Blob 存储中存档，并且可以轻松访问以进行批处理。</span><span class="sxs-lookup"><span data-stu-id="9805c-156">Data can be archived in Blob storage indefinitely at low cost, and is easily accessible for batch processing.</span></span>

<span data-ttu-id="9805c-157">**数据转换**操作或聚合遥测数据流。</span><span class="sxs-lookup"><span data-stu-id="9805c-157">**Data transformation** manipulates or aggregates the telemetry stream.</span></span> <span data-ttu-id="9805c-158">示例包括协议转换，例如，将二进制数据转换为 JSON，或者合并数据点。</span><span class="sxs-lookup"><span data-stu-id="9805c-158">Examples include protocol transformation, such as converting binary data to JSON, or combining data points.</span></span> <span data-ttu-id="9805c-159">如果数据在到达 IoT 中心之前必须转换，我们建议使用[协议网关](/azure/iot-hub/iot-hub-protocol-gateway)（未显示）。</span><span class="sxs-lookup"><span data-stu-id="9805c-159">If the data must be transformed before reaching IoT Hub, we recommend using a [protocol gateway](/azure/iot-hub/iot-hub-protocol-gateway) (not shown).</span></span> <span data-ttu-id="9805c-160">否则，数据可以在到达 IoT 中心后转换。</span><span class="sxs-lookup"><span data-stu-id="9805c-160">Otherwise, data can be transformed after it reaches IoT Hub.</span></span> <span data-ttu-id="9805c-161">在这种情况下，我们建议使用 [Azure Functions](/azure/azure-functions/)。</span><span class="sxs-lookup"><span data-stu-id="9805c-161">In that case, we recommend using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="9805c-162">Functions 已内置了与 IoT 中心、Cosmos DB 和 Blob 存储的集成。</span><span class="sxs-lookup"><span data-stu-id="9805c-162">Functions has built-in integration with IoT Hub, Cosmos DB, and Blob Storage.</span></span>

<span data-ttu-id="9805c-163">**业务流程集成**根据来自设备数据的见解执行操作。</span><span class="sxs-lookup"><span data-stu-id="9805c-163">**Business process integration** performs actions based on insights from the device data.</span></span> <span data-ttu-id="9805c-164">这可能包括：存储信息性消息、引发警报、发送电子邮件或短信，或者与 CRM 集成。</span><span class="sxs-lookup"><span data-stu-id="9805c-164">This could include storing informational messages, raising alarms, sending email or SMS messages, or integrating with CRM.</span></span> <span data-ttu-id="9805c-165">我们建议将 [Azure 逻辑应用](/azure/logic-apps/logic-apps-overview)用于业务流程集成。</span><span class="sxs-lookup"><span data-stu-id="9805c-165">We recommend using [Azure Logic Apps](/azure/logic-apps/logic-apps-overview) for business process integration.</span></span>

<span data-ttu-id="9805c-166">**用户管理**限制哪些用户或组可以在设备上执行操作，例如升级固件。</span><span class="sxs-lookup"><span data-stu-id="9805c-166">**User management** restricts which users or groups can perform actions on devices, such as upgrading firmware.</span></span> <span data-ttu-id="9805c-167">它还定义应用程序中的用户功能。</span><span class="sxs-lookup"><span data-stu-id="9805c-167">It also defines capabilities for users in applications.</span></span> <span data-ttu-id="9805c-168">我们建议使用 [Azure Active Directory](/azure/active-directory/) 对用户进行身份验证和授权。</span><span class="sxs-lookup"><span data-stu-id="9805c-168">We recommend using [Azure Active Directory](/azure/active-directory/) to authenticate and authorize users.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="9805c-169">可伸缩性注意事项</span><span class="sxs-lookup"><span data-stu-id="9805c-169">Scalability considerations</span></span>

<span data-ttu-id="9805c-170">IoT 应用程序应作为可以独立缩放的独立服务构建。</span><span class="sxs-lookup"><span data-stu-id="9805c-170">An IoT application should be built as discrete services that can scale independently.</span></span> <span data-ttu-id="9805c-171">请考虑以下可伸缩性要点：</span><span class="sxs-lookup"><span data-stu-id="9805c-171">Consider the following scalability points:</span></span>

<span data-ttu-id="9805c-172">**IoT 中心**。</span><span class="sxs-lookup"><span data-stu-id="9805c-172">**IoTHub**.</span></span> <span data-ttu-id="9805c-173">对于 IoT 中心，请考虑以下缩放因素：</span><span class="sxs-lookup"><span data-stu-id="9805c-173">For IoT Hub, consider the following scale factors:</span></span>

- <span data-ttu-id="9805c-174">发送到 IoT 中心的消息的最大[每日配额](/azure/iot-hub/iot-hub-devguide-quotas-throttling)。</span><span class="sxs-lookup"><span data-stu-id="9805c-174">The maximum [daily quota](/azure/iot-hub/iot-hub-devguide-quotas-throttling) of messages into IoT Hub.</span></span>
- <span data-ttu-id="9805c-175">IoT 中心实例中连接的设备的配额。</span><span class="sxs-lookup"><span data-stu-id="9805c-175">The quota of connected devices in an IoT Hub instance.</span></span>
- <span data-ttu-id="9805c-176">引入吞吐量 &mdash; IoT 中心可以采用多快的速度引入消息。</span><span class="sxs-lookup"><span data-stu-id="9805c-176">Ingestion throughput &mdash; how quickly IoT Hub can ingest messages.</span></span>
- <span data-ttu-id="9805c-177">处理吞吐量 &mdash; 可以采用多快的速度处理传入消息。</span><span class="sxs-lookup"><span data-stu-id="9805c-177">Processing throughput &mdash; how quickly the incoming messages are processed.</span></span>

<span data-ttu-id="9805c-178">每个 IoT 中心都在特定层中预配了特定单位数。</span><span class="sxs-lookup"><span data-stu-id="9805c-178">Each IoT hub is provisioned with a certain number of units in a specific tier.</span></span> <span data-ttu-id="9805c-179">层和单位数决定了设备可以发送到中心的消息的最大每日配额。</span><span class="sxs-lookup"><span data-stu-id="9805c-179">The tier and number of units determine the maximum daily quota of messages that devices can send to the hub.</span></span> <span data-ttu-id="9805c-180">有关详细信息，请参阅“IoT 中心配额和限制”。</span><span class="sxs-lookup"><span data-stu-id="9805c-180">For more information, see IoT Hub quotas and throttling.</span></span> <span data-ttu-id="9805c-181">可以纵向扩展中心而无需中断现有操作。</span><span class="sxs-lookup"><span data-stu-id="9805c-181">You can scale up a hub without interrupting existing operations.</span></span>

<span data-ttu-id="9805c-182">**流分析**。</span><span class="sxs-lookup"><span data-stu-id="9805c-182">**Stream Analytics**.</span></span> <span data-ttu-id="9805c-183">如果流分析作业在流分析管道中的所有方面（从输入到查询到输出）都是并行的，那么它们的扩展效果最佳。</span><span class="sxs-lookup"><span data-stu-id="9805c-183">Stream Analytics jobs scale best if they are parallel at all points in the Stream Analytics pipeline, from input to query to output.</span></span> <span data-ttu-id="9805c-184">完全并行的作业使流分析可以将工作拆分到多个计算节点上。</span><span class="sxs-lookup"><span data-stu-id="9805c-184">A fully parallel job allows Stream Analytics to split the work across multiple compute nodes.</span></span> <span data-ttu-id="9805c-185">否则，流分析必须将流数据合并到一个位置。</span><span class="sxs-lookup"><span data-stu-id="9805c-185">Otherwise, Stream Analytics has to combine the stream data into one place.</span></span> <span data-ttu-id="9805c-186">有关详细信息，请参阅[利用 Azure 流分析中的查询并行化](/azure/stream-analytics/stream-analytics-parallelization)。</span><span class="sxs-lookup"><span data-stu-id="9805c-186">For more information, see [Leverage query parallelization in Azure Stream Analytics](/azure/stream-analytics/stream-analytics-parallelization).</span></span>

<span data-ttu-id="9805c-187">IoT 中心自动基于设备 ID 对设备消息进行分区。</span><span class="sxs-lookup"><span data-stu-id="9805c-187">IoT Hub automatically partitions device messages based on the device ID.</span></span> <span data-ttu-id="9805c-188">所有来自某一特定设备的消息将始终到达同一分区，但单个分区将具有来自多个设备的消息。</span><span class="sxs-lookup"><span data-stu-id="9805c-188">All of the messages from a particular device will always arrive on the same partition, but a single partition will have messages from multiple devices.</span></span> <span data-ttu-id="9805c-189">因此，并行化的单元是分区 ID。</span><span class="sxs-lookup"><span data-stu-id="9805c-189">Therefore, the unit of parallelization is the partition ID.</span></span>

<span data-ttu-id="9805c-190">**Functions**。</span><span class="sxs-lookup"><span data-stu-id="9805c-190">**Functions**.</span></span> <span data-ttu-id="9805c-191">从事件中心终结点进行读取时，每个事件中心分区都有函数实例的上限。</span><span class="sxs-lookup"><span data-stu-id="9805c-191">When reading from the Event Hubs endpoint, there is a maximum of function instance per event hub partition.</span></span> <span data-ttu-id="9805c-192">该最大处理速率取决于一个函数实例可以采用多快的速度处理来自单个分区的事件。</span><span class="sxs-lookup"><span data-stu-id="9805c-192">The maximum processing rate is determined by how fast one function instance can process the events from a single partition.</span></span> <span data-ttu-id="9805c-193">此函数应成批处理消息。</span><span class="sxs-lookup"><span data-stu-id="9805c-193">The function should process messages in batches.</span></span>

<span data-ttu-id="9805c-194">**Cosmos DB**。</span><span class="sxs-lookup"><span data-stu-id="9805c-194">**Cosmos DB**.</span></span> <span data-ttu-id="9805c-195">若要横向扩展 Cosmos DB 集合，请使用分区键创建集合，并将该分区键包含在你编写的每个文档中。</span><span class="sxs-lookup"><span data-stu-id="9805c-195">To scale out a Cosmos DB collection, create the collection with a partition key and include the partition key in each document that you write.</span></span> <span data-ttu-id="9805c-196">有关详细信息，请参阅[选择分区键时的最佳做法](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key)。</span><span class="sxs-lookup"><span data-stu-id="9805c-196">For more information, see [Best practices when choosing a partition key](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key).</span></span>

- <span data-ttu-id="9805c-197">如果按设备存储和更新单个文档，那么设备 ID 就是不错的分区键。</span><span class="sxs-lookup"><span data-stu-id="9805c-197">If you store and update a single document per device, the device ID is a good partition key.</span></span> <span data-ttu-id="9805c-198">写入操作将均匀分布于这些键。</span><span class="sxs-lookup"><span data-stu-id="9805c-198">Writes are evenly distributed across the keys.</span></span> <span data-ttu-id="9805c-199">每个分区的大小是受严格限制的，因为每个键值都有单个文档。</span><span class="sxs-lookup"><span data-stu-id="9805c-199">The size of each partition is strictly bounded, because there is a single document for each key value.</span></span>
- <span data-ttu-id="9805c-200">如果为每个设备消息都存储一个单独的文档，那么使用设备 ID 作为分区键将很快超过每分区 10 GB 的限制。</span><span class="sxs-lookup"><span data-stu-id="9805c-200">If you store a separate document for every device message, using the device ID as a partition key would quickly exceed the 10-GB limit per partition.</span></span> <span data-ttu-id="9805c-201">在这种情况下，消息 ID 是更好的分区键。</span><span class="sxs-lookup"><span data-stu-id="9805c-201">Message ID is a better partition key in that case.</span></span> <span data-ttu-id="9805c-202">通常仍应将设备 ID 包含在文档中，以便进行索引和查询。</span><span class="sxs-lookup"><span data-stu-id="9805c-202">Typically you would still include device ID in the document for indexing and querying.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="9805c-203">安全注意事项</span><span class="sxs-lookup"><span data-stu-id="9805c-203">Security considerations</span></span>

### <a name="trustworthy-and-secure-communication"></a><span data-ttu-id="9805c-204">可信和安全通信</span><span class="sxs-lookup"><span data-stu-id="9805c-204">Trustworthy and secure communication</span></span>

<span data-ttu-id="9805c-205">从设备接收的所有信息和发送到设备的所有信息都必须都是可信的。</span><span class="sxs-lookup"><span data-stu-id="9805c-205">All information received from and sent to a device must be trustworthy.</span></span> <span data-ttu-id="9805c-206">除非设备可以支持以下加密功能，否则它都应限制到本地网络，并且所有网间通信都应经过现场网关：</span><span class="sxs-lookup"><span data-stu-id="9805c-206">Unless a device can support the following cryptographic capabilities, it should be constrained to local networks and all internetwork communication should go through a field gateway:</span></span>

- <span data-ttu-id="9805c-207">采用已证实安全、经过公开分析并且已广泛实现的对称密钥加密算法的数据加密。</span><span class="sxs-lookup"><span data-stu-id="9805c-207">Data encryption with a provably secure, publicly analyzed, and broadly implemented symmetric-key encryption algorithm.</span></span>
- <span data-ttu-id="9805c-208">采用已证实安全、经过公开分析并且已广泛实现的对称密钥加密算法的数字签名。</span><span class="sxs-lookup"><span data-stu-id="9805c-208">Digital signature with a provably secure, publicly analyzed, and broadly implemented symmetric-key signature algorithm.</span></span>
- <span data-ttu-id="9805c-209">支持用于 TCP 或其他基于流的通信路径的 TLS 1.2，或者支持用于基于数据报的通信路径的 DTLS 1.2。</span><span class="sxs-lookup"><span data-stu-id="9805c-209">Support for either TLS 1.2 for TCP or other stream-based communication paths or DTLS 1.2 for datagram-based communication paths.</span></span> <span data-ttu-id="9805c-210">支持 X.509 证书处理是可选的，可由在计算方面和传输方面更高效的 TLS 预共享密钥模式替换，该模式可以在具有对 AES 和 SHA-2 算法的支持时实现。</span><span class="sxs-lookup"><span data-stu-id="9805c-210">Support of X.509 certificate handling is optional and can be replaced by the more compute-efficient and wire-efficient pre-shared key mode for TLS, which can be implemented with support for the AES and SHA-2 algorithms.</span></span>
- <span data-ttu-id="9805c-211">可更新的密钥存储和每个设备的密钥。</span><span class="sxs-lookup"><span data-stu-id="9805c-211">Updateable key-store and per-device keys.</span></span> <span data-ttu-id="9805c-212">每个设备必须具有唯一的密钥材料或向系统标识其身份的令牌。</span><span class="sxs-lookup"><span data-stu-id="9805c-212">Each device must have unique key material or tokens that identify it toward the system.</span></span> <span data-ttu-id="9805c-213">设备应在设备上安全存储密钥（例如，使用安全的密钥存储）。</span><span class="sxs-lookup"><span data-stu-id="9805c-213">The devices should store the key securely on the device (for example, using a secure key-store).</span></span> <span data-ttu-id="9805c-214">设备应能够定期更新密钥或令牌，或在紧急情况（例如系统入侵）下响应性地更新密钥或令牌。</span><span class="sxs-lookup"><span data-stu-id="9805c-214">The device should be able to update the keys or tokens periodically, or reactively in emergency situations such as a system breach.</span></span>
- <span data-ttu-id="9805c-215">设备上的固件和应用程序软件必须允许更新，以实现修复已发现的安全漏洞。</span><span class="sxs-lookup"><span data-stu-id="9805c-215">The firmware and application software on the device must allow for updates to enable the repair of discovered security vulnerabilities.</span></span>

<span data-ttu-id="9805c-216">但是，许多设备太受限制，无法支持这些要求。</span><span class="sxs-lookup"><span data-stu-id="9805c-216">However, many devices are too constrained to support these requirements.</span></span> <span data-ttu-id="9805c-217">在这种情况下，应使用现场网关。</span><span class="sxs-lookup"><span data-stu-id="9805c-217">In that case, a field gateway should be used.</span></span> <span data-ttu-id="9805c-218">设备通过局域网安全地连接到现场网关，并且网关实现与云的安全通信。</span><span class="sxs-lookup"><span data-stu-id="9805c-218">Devices connect securely to the field gateway through a local area network, and the gateway enables secure communication to the cloud.</span></span>

### <a name="physical-tamper-proofing"></a><span data-ttu-id="9805c-219">防止物理篡改</span><span class="sxs-lookup"><span data-stu-id="9805c-219">Physical tamper proofing</span></span>

<span data-ttu-id="9805c-220">强烈建议设备设计包含防御物理操作尝试的功能，以帮助确保整个系统的安全完整性和可信度。</span><span class="sxs-lookup"><span data-stu-id="9805c-220">It is strongly recommended that device design incorporates features that defend against physical manipulation attempts, to help ensure the security integrity and trustworthiness of the overall system.</span></span>

<span data-ttu-id="9805c-221">例如：</span><span class="sxs-lookup"><span data-stu-id="9805c-221">For example:</span></span>

- <span data-ttu-id="9805c-222">选择可提供安全存储并支持使用加密密钥材料的微控制器/微处理器或辅助硬件，例如受信任的平台模块 (TPM) 集成。</span><span class="sxs-lookup"><span data-stu-id="9805c-222">Choose microcontrollers/microprocessors or auxiliary hardware that provide secure storage and use of cryptographic key material, such as trusted platform module (TPM) integration.</span></span>
- <span data-ttu-id="9805c-223">保护启动加载程序并保护软件加载（在 TPM 中定位）。</span><span class="sxs-lookup"><span data-stu-id="9805c-223">Secure boot loader and secure software loading, anchored in the TPM.</span></span>
- <span data-ttu-id="9805c-224">使用传感器检测入侵尝试以及对操纵设备环境的尝试，并在检测到这些尝试时发出警报或可能执行设备的“数字式自破坏”。</span><span class="sxs-lookup"><span data-stu-id="9805c-224">Use sensors to detect intrusion attempts and attempts to manipulate the device environment with alerting and potentially “digital self-destruction” of the device.</span></span>

<span data-ttu-id="9805c-225">有关其他安全注意事项，请参阅[物联网 (IoT) 安全体系结构](/azure/iot-fundamentals/iot-security-architecture)。</span><span class="sxs-lookup"><span data-stu-id="9805c-225">For additional security considerations, see [Internet of Things (IoT) security architecture](/azure/iot-fundamentals/iot-security-architecture).</span></span>

### <a name="monitoring-and-logging"></a><span data-ttu-id="9805c-226">监视和日志记录</span><span class="sxs-lookup"><span data-stu-id="9805c-226">Monitoring and logging</span></span>

<span data-ttu-id="9805c-227">日志记录和监视系统用于确定解决方案是否正常工作，并且用来帮助排查问题。</span><span class="sxs-lookup"><span data-stu-id="9805c-227">Logging and monitoring systems are used to determine whether the solution is functioning and to help troubleshoot problems.</span></span> <span data-ttu-id="9805c-228">监视和日志记录系统帮助回答以下运行问题：</span><span class="sxs-lookup"><span data-stu-id="9805c-228">Monitoring and logging systems help answer the following operational questions:</span></span>

- <span data-ttu-id="9805c-229">设备或系统是否处于错误状况？</span><span class="sxs-lookup"><span data-stu-id="9805c-229">Are devices or systems in an error condition?</span></span>
- <span data-ttu-id="9805c-230">设备或系统是否已正确配置？</span><span class="sxs-lookup"><span data-stu-id="9805c-230">Are devices or systems correctly configured?</span></span>
- <span data-ttu-id="9805c-231">设备或系统是否在生成准确的数据？</span><span class="sxs-lookup"><span data-stu-id="9805c-231">Are devices or systems generating accurate data?</span></span>
- <span data-ttu-id="9805c-232">系统是否满足商业客户和最终客户的预期？</span><span class="sxs-lookup"><span data-stu-id="9805c-232">Are systems meeting the expectations of both the business and end customers?</span></span>

<span data-ttu-id="9805c-233">日志记录和监视工具通常包括以下四个组成部分：</span><span class="sxs-lookup"><span data-stu-id="9805c-233">Logging and monitoring tools are typically comprised of the following four components:</span></span>

- <span data-ttu-id="9805c-234">系统性能和时间线可视化工具，用于监视系统以及进行基本的故障排除。</span><span class="sxs-lookup"><span data-stu-id="9805c-234">System performance and timeline visualization tools to monitor the system and for basic troubleshooting.</span></span>
- <span data-ttu-id="9805c-235">缓冲的数据引入，用于缓冲日志数据。</span><span class="sxs-lookup"><span data-stu-id="9805c-235">Buffered data ingestion, to buffer log data.</span></span>
- <span data-ttu-id="9805c-236">持久性存储，用于存储日志数据。</span><span class="sxs-lookup"><span data-stu-id="9805c-236">Persistence store to store log data.</span></span>
- <span data-ttu-id="9805c-237">搜索和查询功能，用于在执行详细故障排除时查看日志数据。</span><span class="sxs-lookup"><span data-stu-id="9805c-237">Search and query capabilities, to view log data for use in detailed troubleshooting.</span></span>

<span data-ttu-id="9805c-238">监视系统提供对 IoT 解决方案的运行状况、安全性和稳定性以及性能的见解。</span><span class="sxs-lookup"><span data-stu-id="9805c-238">Monitoring systems provide insights into the health, security, and stability, and performance of an IoT solution.</span></span> <span data-ttu-id="9805c-239">这些系统还可以提供更详细的视图，记录组件配置更改并提供已提取的日志记录数据，以便揭示潜在的安全漏洞、改进事件管理流程并帮助系统的所有者排查问题。</span><span class="sxs-lookup"><span data-stu-id="9805c-239">These systems can also provide a more detailed view, recording component configuration changes and providing extracted logging data that can surface potential security vulnerabilities, enhance the incident management process, and help the owner of the system troubleshoot problems.</span></span> <span data-ttu-id="9805c-240">全面的监视解决方案包括在特定子系统中查询信息或跨多个子系统进行聚合的功能。</span><span class="sxs-lookup"><span data-stu-id="9805c-240">Comprehensive monitoring solutions include the ability to query information for specific subsystems or aggregating across multiple subsystems.</span></span>

<span data-ttu-id="9805c-241">开发监视系统时应首先定义正常操作、法规遵从性和审核要求。</span><span class="sxs-lookup"><span data-stu-id="9805c-241">Monitoring system development should begin by defining healthy operation, regulatory compliance, and audit requirements.</span></span> <span data-ttu-id="9805c-242">收集的指标可包括：</span><span class="sxs-lookup"><span data-stu-id="9805c-242">Metrics collected may include:</span></span>

- <span data-ttu-id="9805c-243">报告配置更改的物理设备、边缘设备和基础设施组件。</span><span class="sxs-lookup"><span data-stu-id="9805c-243">Physical devices, edge devices, and infrastructure components reporting configuration changes.</span></span>
- <span data-ttu-id="9805c-244">报告托管语言的配置更改、安全审核日志、请求速率、响应时间、错误率和垃圾回收统计信息的应用程序。</span><span class="sxs-lookup"><span data-stu-id="9805c-244">Applications reporting configuration changes, security audit logs, request rates, response times, error rates, and garbage collection statistics for managed languages.</span></span>
- <span data-ttu-id="9805c-245">报告查询和写入性能、架构更改、安全审核日志、锁或死锁、索引性能以及 CPU、内存与磁盘使用情况的数据库、持久性存储和缓存。</span><span class="sxs-lookup"><span data-stu-id="9805c-245">Databases, persistence stores, and caches reporting query and write performance, schema changes, security audit log, locks or deadlocks, index performance, CPU, memory, and disk usage.</span></span>
- <span data-ttu-id="9805c-246">报告可影响依赖系统运行状况和性能的运行状况指标和配置更改的托管服务（IaaS、PaaS、SaaS 和 FaaS）。</span><span class="sxs-lookup"><span data-stu-id="9805c-246">Managed services (IaaS, PaaS, SaaS, and FaaS) reporting health metrics and configuration changes that impact dependent system health and performance.</span></span>

<span data-ttu-id="9805c-247">监视指标的可视化，这些指标用于向操作员发出警报，提醒其注意系统的不稳定状况，并促进事件响应。</span><span class="sxs-lookup"><span data-stu-id="9805c-247">Visualization of monitoring metrics alert operators to system instabilities and facilitate incident response.</span></span>

### <a name="tracing-telemetry"></a><span data-ttu-id="9805c-248">跟踪遥测数据</span><span class="sxs-lookup"><span data-stu-id="9805c-248">Tracing telemetry</span></span>

<span data-ttu-id="9805c-249">跟踪遥测数据使操作员可以跟踪一段遥测数据从创建起在该系统中经历的整个过程。</span><span class="sxs-lookup"><span data-stu-id="9805c-249">Tracing telemetry allows an operator to follow the journey of a piece of telemetry from creation through the system.</span></span> <span data-ttu-id="9805c-250">跟踪对于调试和故障排除而言十分重要。</span><span class="sxs-lookup"><span data-stu-id="9805c-250">Tracing is important for debugging and troubleshooting.</span></span> <span data-ttu-id="9805c-251">对于使用 Azure IoT 中心和 [IoT 中心设备 SDK](/azure/iot-hub/iot-hub-devguide-sdks) 的 IoT 解决方案，跟踪数据报可以源自云到设备的消息并包含在遥测数据流中。</span><span class="sxs-lookup"><span data-stu-id="9805c-251">For IoT solutions that use Azure IoT Hub and the [IoT Hub Device SDKs](/azure/iot-hub/iot-hub-devguide-sdks), tracing datagrams can be originated as Cloud-to-Device messages and included in the telemetry stream.</span></span>

### <a name="logging"></a><span data-ttu-id="9805c-252">日志记录</span><span class="sxs-lookup"><span data-stu-id="9805c-252">Logging</span></span>

<span data-ttu-id="9805c-253">日志记录系统对于了解解决方案执行了哪些操作或活动、已发生的故障而言不可或缺，并可提供帮助来排除这些故障。</span><span class="sxs-lookup"><span data-stu-id="9805c-253">Logging systems are integral in understanding what actions or activities a solution has performed, failures that have occurred, and can provide help in fixing those failures.</span></span> <span data-ttu-id="9805c-254">可以对日志进行分析，以帮助了解和纠正错误状况、增强性能特性，并确保符合管控规则和法规。</span><span class="sxs-lookup"><span data-stu-id="9805c-254">Logs can be analyzed to help understand and remedy error conditions, enhance performance characteristics, and ensure compliance with governing rule and regulations.</span></span>

<span data-ttu-id="9805c-255">虽然纯文本日志记录对前期开发成本的影响较低，但它对于计算机进行分析/读取而言更具挑战性。</span><span class="sxs-lookup"><span data-stu-id="9805c-255">Though plain-text logging is lower impact on upfront development costs, it is more challenging for a machine to parse/read.</span></span> <span data-ttu-id="9805c-256">我们建议使用结构化日志记录，因为收集的信息既可供计算机分析，又可供用户阅读。</span><span class="sxs-lookup"><span data-stu-id="9805c-256">We recommend structured logging be used, as collected information is both machine parsable and human readable.</span></span> <span data-ttu-id="9805c-257">结构化日志记录会将情况上下文和元数据添加到日志信息。</span><span class="sxs-lookup"><span data-stu-id="9805c-257">Structured logging adds situational context and metadata to the log information.</span></span> <span data-ttu-id="9805c-258">在结构化日志记录中，属性是支持所有常见操作的实体，已格式化为键/值对或具有固定架构，以增强搜索和查询功能。</span><span class="sxs-lookup"><span data-stu-id="9805c-258">In structured logging, properties are first class citizens formatted as key/value pairs, or with a fixed schema, to enhance search and query capabilities.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9805c-259">后续步骤</span><span class="sxs-lookup"><span data-stu-id="9805c-259">Next steps</span></span>

- <span data-ttu-id="9805c-260">有关建议的体系结构和实现选项的详细讨论，请参阅 [Microsoft Azure IoT 参考体系结构](https://aka.ms/iotrefarchitecture) (PDF)。</span><span class="sxs-lookup"><span data-stu-id="9805c-260">For a more detailed discussion of the recommended architecture and implementation choices, see [Microsoft Azure IoT Reference Architecture](https://aka.ms/iotrefarchitecture) (PDF).</span></span>

- <span data-ttu-id="9805c-261">有关各种 Azure IoT 服务的详细文档，请参阅 [Azure IoT 基础](/azure/iot-fundamentals/)。</span><span class="sxs-lookup"><span data-stu-id="9805c-261">For detailed documentation of the various Azure IoT services, see [Azure IoT Fundamentals](/azure/iot-fundamentals/).</span></span>

- <span data-ttu-id="9805c-262">[GitHub](https://github.com/mspnp/iot-guidance) 上提供了一个 IoT 实现示例。</span><span class="sxs-lookup"><span data-stu-id="9805c-262">A sample IoT implementation is available on [GitHub](https://github.com/mspnp/iot-guidance).</span></span>
