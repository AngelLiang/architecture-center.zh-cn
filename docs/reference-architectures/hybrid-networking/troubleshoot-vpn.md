---
title: 排查混合 VPN 连接问题
titleSuffix: Azure Reference Architectures
description: 排查本地网络和 Azure 之间的 VPN 网关连接问题。
author: telmosampaio
ms.date: 10/08/2018
ms.topic: article
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: networking
ms.openlocfilehash: 2140c67f23f11c355b286b28653d243b4adf8c73
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/20/2019
ms.locfileid: "58243828"
---
# <a name="troubleshoot-a-hybrid-vpn-connection"></a><span data-ttu-id="3b61b-103">排查混合 VPN 连接问题</span><span class="sxs-lookup"><span data-stu-id="3b61b-103">Troubleshoot a hybrid VPN connection</span></span>

<span data-ttu-id="3b61b-104">本文提供的一些提示说明了如何排查本地网络和 Azure 之间的 VPN 网关连接问题。</span><span class="sxs-lookup"><span data-stu-id="3b61b-104">This article gives some tips for troubleshooting a VPN gateway connection between an on-premises network and Azure.</span></span> <span data-ttu-id="3b61b-105">有关常见 VPN 相关错误故障排除的常规信息，请参阅[常见 VPN 相关错误故障排除][troubleshooting-vpn-errors]。</span><span class="sxs-lookup"><span data-stu-id="3b61b-105">For general information on troubleshooting common VPN-related errors, see [Troubleshooting common VPN related errors][troubleshooting-vpn-errors].</span></span>

## <a name="verify-the-vpn-appliance-is-functioning-correctly"></a><span data-ttu-id="3b61b-106">验证 VPN 设备是否正常运行</span><span class="sxs-lookup"><span data-stu-id="3b61b-106">Verify the VPN appliance is functioning correctly</span></span>

<span data-ttu-id="3b61b-107">以下建议可用于确定本地 VPN 设备是否正常运行。</span><span class="sxs-lookup"><span data-stu-id="3b61b-107">The following recommendations are useful for determining if your on-premises VPN appliance is functioning correctly.</span></span>

<span data-ttu-id="3b61b-108">**在 VPN 设备生成的任何日志文件中检查是否存在错误或故障。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-108">**Check any log files generated by the VPN appliance for errors or failures.**</span></span> <span data-ttu-id="3b61b-109">这会帮助确定 VPN 设备是否正常运行。</span><span class="sxs-lookup"><span data-stu-id="3b61b-109">This will help you determine if the VPN appliance is functioning correctly.</span></span> <span data-ttu-id="3b61b-110">此信息的位置因设备而异。</span><span class="sxs-lookup"><span data-stu-id="3b61b-110">The location of this information will vary according to your appliance.</span></span> <span data-ttu-id="3b61b-111">例如，如果在 Windows Server 2012 上使用 RRAS，则可以使用以下 PowerShell 命令显示 RRAS 服务的错误事件信息：</span><span class="sxs-lookup"><span data-stu-id="3b61b-111">For example, if you are using RRAS on Windows Server 2012, you can use the following PowerShell command to display error event information for the RRAS service:</span></span>

```PowerShell
Get-EventLog -LogName System -EntryType Error -Source RemoteAccess | Format-List -Property *
```

<span data-ttu-id="3b61b-112">每个条目的 Message 属性提供错误的说明。</span><span class="sxs-lookup"><span data-stu-id="3b61b-112">The *Message* property of each entry provides a description of the error.</span></span> <span data-ttu-id="3b61b-113">一些常见示例包括：</span><span class="sxs-lookup"><span data-stu-id="3b61b-113">Some common examples are:</span></span>

- <span data-ttu-id="3b61b-114">无法进行连接，可能是因为在 RRAS VPN 网络接口配置中为 Azure VPN 网关指定的 IP 地址不正确。</span><span class="sxs-lookup"><span data-stu-id="3b61b-114">Inability to connect, possibly due to an incorrect IP address specified for the Azure VPN gateway in the RRAS VPN network interface configuration.</span></span>

  ```console
  EventID            : 20111
  MachineName        : on-premises-vm
  Data               : {41, 3, 0, 0}
  Index              : 14231
  Category           : (0)
  CategoryNumber     : 0
  EntryType          : Error
  Message            : RoutingDomainID- {00000000-0000-0000-0000-000000000000}: A demand dial connection to the remote
                          interface AzureGateway on port VPN2-4 was successfully initiated but failed to complete
                          successfully because of the  following error: The network connection between your computer and
                          the VPN server could not be established because the remote server is not responding. This could
                          be because one of the network devices (for example, firewalls, NAT, routers, and so on) between your computer
                          and the remote server is not configured to allow VPN connections. Please contact your
                          Administrator or your service provider to determine which device may be causing the problem.
  Source             : RemoteAccess
  ReplacementStrings : {{00000000-0000-0000-0000-000000000000}, AzureGateway, VPN2-4, The network connection between
                          your computer and the VPN server could not be established because the remote server is not
                          responding. This could be because one of the network devices (for example, firewalls, NAT, routers, and so on)
                          between your computer and the remote server is not configured to allow VPN connections. Please
                          contact your Administrator or your service provider to determine which device may be causing the
                          problem.}
  InstanceId         : 20111
  TimeGenerated      : 3/18/2016 1:26:02 PM
  TimeWritten        : 3/18/2016 1:26:02 PM
  UserName           :
  Site               :
  Container          :
  ```

- <span data-ttu-id="3b61b-115">在 RRAS VPN 网络接口配置中指定了错误的共享密钥。</span><span class="sxs-lookup"><span data-stu-id="3b61b-115">The wrong shared key being specified in the RRAS VPN network interface configuration.</span></span>

  ```console
  EventID            : 20111
  MachineName        : on-premises-vm
  Data               : {233, 53, 0, 0}
  Index              : 14245
  Category           : (0)
  CategoryNumber     : 0
  EntryType          : Error
  Message            : RoutingDomainID- {00000000-0000-0000-0000-000000000000}: A demand dial connection to the remote
                          interface AzureGateway on port VPN2-4 was successfully initiated but failed to complete
                          successfully because of the  following error: Internet key exchange (IKE) authentication credentials are unacceptable.

  Source             : RemoteAccess
  ReplacementStrings : {{00000000-0000-0000-0000-000000000000}, AzureGateway, VPN2-4, IKE authentication credentials are
                          unacceptable.
                          }
  InstanceId         : 20111
  TimeGenerated      : 3/18/2016 1:34:22 PM
  TimeWritten        : 3/18/2016 1:34:22 PM
  UserName           :
  Site               :
  Container          :
  ```

<span data-ttu-id="3b61b-116">还可以使用以下 PowerShell 命令获取有关通过 RRAS 服务尝试连接的事件日志信息：</span><span class="sxs-lookup"><span data-stu-id="3b61b-116">You can also obtain event log information about attempts to connect through the RRAS service using the following PowerShell command:</span></span>

```powershell
Get-EventLog -LogName Application -Source RasClient | Format-List -Property *
```

<span data-ttu-id="3b61b-117">如果出现连接故障，则此日志会包含类似于以下内容的错误：</span><span class="sxs-lookup"><span data-stu-id="3b61b-117">In the event of a failure to connect, this log will contain errors that look similar to the following:</span></span>

```console
EventID            : 20227
MachineName        : on-premises-vm
Data               : {}
Index              : 4203
Category           : (0)
CategoryNumber     : 0
EntryType          : Error
Message            : CoId={B4000371-A67F-452F-AA4C-3125AA9CFC78}: The user SYSTEM dialed a connection named
                        AzureGateway that has failed. The error code returned on failure is 809.
Source             : RasClient
ReplacementStrings : {{B4000371-A67F-452F-AA4C-3125AA9CFC78}, SYSTEM, AzureGateway, 809}
InstanceId         : 20227
TimeGenerated      : 3/18/2016 1:29:21 PM
TimeWritten        : 3/18/2016 1:29:21 PM
UserName           :
Site               :
Container          :
```

## <a name="verify-connectivity"></a><span data-ttu-id="3b61b-118">验证连接性</span><span class="sxs-lookup"><span data-stu-id="3b61b-118">Verify connectivity</span></span>

<span data-ttu-id="3b61b-119">**验证跨 VPN 网关的连接和路由。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-119">**Verify connectivity and routing across the VPN gateway.**</span></span> <span data-ttu-id="3b61b-120">VPN 设备可能无法通过 Azure VPN 网关正确路由流量。</span><span class="sxs-lookup"><span data-stu-id="3b61b-120">The VPN appliance may not be correctly routing traffic through the Azure VPN Gateway.</span></span> <span data-ttu-id="3b61b-121">使用 [PsPing][psping] 这类工具可验证跨 VPN 网关的连接和路由。</span><span class="sxs-lookup"><span data-stu-id="3b61b-121">Use a tool such as [PsPing][psping] to verify connectivity and routing across the VPN gateway.</span></span> <span data-ttu-id="3b61b-122">例如，若要测试从本地计算机到位于 VNet 上的 Web 服务器的连接，请运行以下命令（将 `<<web-server-address>>` 替换为 Web 服务器的地址）：</span><span class="sxs-lookup"><span data-stu-id="3b61b-122">For example, to test connectivity from an on-premises machine to a web server located on the VNet, run the following command (replacing `<<web-server-address>>` with the address of the web server):</span></span>

```console
PsPing -t <<web-server-address>>:80
```

<span data-ttu-id="3b61b-123">如果本地计算机可以将流量路由到 Web 服务器，则你应看到类似于以下内容的输出：</span><span class="sxs-lookup"><span data-stu-id="3b61b-123">If the on-premises machine can route traffic to the web server, you should see output similar to the following:</span></span>

```console
D:\PSTools>psping -t 10.20.0.5:80

PsPing v2.01 - PsPing - ping, latency, bandwidth measurement utility
Copyright (C) 2012-2014 Mark Russinovich
Sysinternals - www.sysinternals.com

TCP connect to 10.20.0.5:80:
Infinite iterations (warmup 1) connecting test:
Connecting to 10.20.0.5:80 (warmup): 6.21ms
Connecting to 10.20.0.5:80: 3.79ms
Connecting to 10.20.0.5:80: 3.44ms
Connecting to 10.20.0.5:80: 4.81ms

    Sent = 3, Received = 3, Lost = 0 (0% loss),
    Minimum = 3.44ms, Maximum = 4.81ms, Average = 4.01ms
```

<span data-ttu-id="3b61b-124">如果本地计算机无法与指定目标进行通信，则你会看到如下消息：</span><span class="sxs-lookup"><span data-stu-id="3b61b-124">If the on-premises machine cannot communicate with the specified destination, you will see messages like this:</span></span>

```console
D:\PSTools>psping -t 10.20.1.6:80

PsPing v2.01 - PsPing - ping, latency, bandwidth measurement utility
Copyright (C) 2012-2014 Mark Russinovich
Sysinternals - www.sysinternals.com

TCP connect to 10.20.1.6:80:
Infinite iterations (warmup 1) connecting test:
Connecting to 10.20.1.6:80 (warmup): This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80: This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80: This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80: This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80:
    Sent = 3, Received = 0, Lost = 3 (100% loss),
    Minimum = 0.00ms, Maximum = 0.00ms, Average = 0.00ms
```

<span data-ttu-id="3b61b-125">**验证本地防火墙是否允许 VPN 流量通过以及正确的端口是否打开。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-125">**Verify that the on-premises firewall allows VPN traffic to pass and that the correct ports are opened.**</span></span>

<span data-ttu-id="3b61b-126">**验证本地 VPN 设备使用的加密方法是否与 Azure VPN 网关兼容。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-126">**Verify that the on-premises VPN appliance uses an encryption method that is compatible with the Azure VPN gateway.**</span></span> <span data-ttu-id="3b61b-127">对于基于策略的路由，Azure VPN 网关支持 AES256、AES128 和 3DES 加密算法。</span><span class="sxs-lookup"><span data-stu-id="3b61b-127">For policy-based routing, the Azure VPN gateway supports the AES256, AES128, and 3DES encryption algorithms.</span></span> <span data-ttu-id="3b61b-128">基于路由的网关支持 AES256 和 3DES。</span><span class="sxs-lookup"><span data-stu-id="3b61b-128">Route-based gateways support AES256 and 3DES.</span></span> <span data-ttu-id="3b61b-129">有关详细信息，请参阅[关于用于站点到站点 VPN 网关连接的 VPN 设备和 IPsec/IKE 参数][vpn-appliance]。</span><span class="sxs-lookup"><span data-stu-id="3b61b-129">For more information, see [About VPN devices and IPsec/IKE parameters for Site-to-Site VPN Gateway connections][vpn-appliance].</span></span>

## <a name="check-for-problems-with-the-azure-vpn-gateway"></a><span data-ttu-id="3b61b-130">检查 Azure VPN 网关是否存在问题</span><span class="sxs-lookup"><span data-stu-id="3b61b-130">Check for problems with the Azure VPN gateway</span></span>

<span data-ttu-id="3b61b-131">以下建议可用于确定是否存在与 Azure VPN 网关有关的问题：</span><span class="sxs-lookup"><span data-stu-id="3b61b-131">The following recommendations are useful for determining if there is a problem with the Azure VPN gateway:</span></span>

<span data-ttu-id="3b61b-132">**在 Azure VPN 网关诊断日志中检查是否存在潜在问题。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-132">**Examine Azure VPN gateway diagnostic logs for potential issues.**</span></span> <span data-ttu-id="3b61b-133">请参阅[分步指南：捕获 Azure 资源管理器 VNET 网关诊断日志][gateway-diagnostic-logs]。</span><span class="sxs-lookup"><span data-stu-id="3b61b-133">See [Step-by-Step: Capturing Azure Resource Manager VNET Gateway Diagnostic Logs][gateway-diagnostic-logs].</span></span>

<span data-ttu-id="3b61b-134">**验证 Azure VPN 网关和本地 VPN 设备是否使用相同的共享身份验证密钥进行配置。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-134">**Verify that the Azure VPN gateway and on-premises VPN appliance are configured with the same shared authentication key.**</span></span> <span data-ttu-id="3b61b-135">可以使用以下 Azure CLI 命令查看 Azure VPN 网关存储的共享密钥：</span><span class="sxs-lookup"><span data-stu-id="3b61b-135">You can view the shared key stored by the Azure VPN gateway using the following Azure CLI command:</span></span>

```azurecli
azure network vpn-connection shared-key show <<resource-group>> <<vpn-connection-name>>
```

<span data-ttu-id="3b61b-136">使用适合于本地 VPN 设备的命令显示为该设备配置的共享密钥。</span><span class="sxs-lookup"><span data-stu-id="3b61b-136">Use the command appropriate for your on-premises VPN appliance to show the shared key configured for that appliance.</span></span>

<span data-ttu-id="3b61b-137">验证包含 Azure VPN 网关的 GatewaySubnet 子网是否不与 NSG 关联。</span><span class="sxs-lookup"><span data-stu-id="3b61b-137">Verify that the *GatewaySubnet* subnet holding the Azure VPN gateway is not associated with an NSG.</span></span>

<span data-ttu-id="3b61b-138">可以使用以下 Azure CLI 命令查看子网详细信息：</span><span class="sxs-lookup"><span data-stu-id="3b61b-138">You can view the subnet details using the following Azure CLI command:</span></span>

```azurecli
azure network vnet subnet show -g <<resource-group>> -e <<vnet-name>> -n GatewaySubnet
```

<span data-ttu-id="3b61b-139">确保没有名为 *Network Security Group ID* 的数据字段。</span><span class="sxs-lookup"><span data-stu-id="3b61b-139">Ensure there is no data field named *Network Security Group ID*.</span></span> <span data-ttu-id="3b61b-140">以下示例显示分配了 NSG (VPN-Gateway-Group) 的 GatewaySubnet 实例的结果。</span><span class="sxs-lookup"><span data-stu-id="3b61b-140">The following example shows the results for an instance of the *GatewaySubnet* that has an assigned NSG (*VPN-Gateway-Group*).</span></span> <span data-ttu-id="3b61b-141">如果没有为此 NSG 定义任何规则，则这可能会阻止网关正常工作。</span><span class="sxs-lookup"><span data-stu-id="3b61b-141">This can prevent the gateway from working correctly if there are any rules defined for this NSG.</span></span>

```console
C:\>azure network vnet subnet show -g profx-prod-rg -e profx-vnet -n GatewaySubnet
    info:    Executing command network vnet subnet show
    + Looking up virtual network "profx-vnet"
    + Looking up the subnet "GatewaySubnet"
    data:    Id                              : /subscriptions/########-####-####-####-############/resourceGroups/profx-prod-rg/providers/Microsoft.Network/virtualNetworks/profx-vnet/subnets/GatewaySubnet
    data:    Name                            : GatewaySubnet
    data:    Provisioning state              : Succeeded
    data:    Address prefix                  : 10.20.3.0/27
    data:    Network Security Group id       : /subscriptions/########-####-####-####-############/resourceGroups/profx-prod-rg/providers/Microsoft.Network/networkSecurityGroups/VPN-Gateway-Group
    info:    network vnet subnet show command OK
```

<span data-ttu-id="3b61b-142">**验证 Azure VNet 中的虚拟机是否配置为允许来自 VNet 外部的流量进入。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-142">**Verify that the virtual machines in the Azure VNet are configured to permit traffic coming in from outside the VNet.**</span></span> <span data-ttu-id="3b61b-143">检查与包含这些虚拟机的子网关联的任何 NSG 规则。</span><span class="sxs-lookup"><span data-stu-id="3b61b-143">Check any NSG rules associated with subnets containing these virtual machines.</span></span> <span data-ttu-id="3b61b-144">可以使用以下 Azure CLI 命令查看所有 NSG 规则：</span><span class="sxs-lookup"><span data-stu-id="3b61b-144">You can view all NSG rules using the following Azure CLI command:</span></span>

```azurecli
azure network nsg show -g <<resource-group>> -n <<nsg-name>>
```

<span data-ttu-id="3b61b-145">**验证 Azure VPN 网关是否已连接。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-145">**Verify that the Azure VPN gateway is connected.**</span></span> <span data-ttu-id="3b61b-146">可以使用以下 Azure PowerShell 命令检查 Azure VPN 连接的当前状态。</span><span class="sxs-lookup"><span data-stu-id="3b61b-146">You can use the following Azure PowerShell command to check the current status of the Azure VPN connection.</span></span> <span data-ttu-id="3b61b-147">`<<connection-name>>` 参数是链接虚拟网络网关和本地网关的 Azure VPN 连接的名称。</span><span class="sxs-lookup"><span data-stu-id="3b61b-147">The `<<connection-name>>` parameter is the name of the Azure VPN connection that links the virtual network gateway and the local gateway.</span></span>

```powershell
Get-AzureRmVirtualNetworkGatewayConnection -Name <<connection-name>> - ResourceGroupName <<resource-group>>
```

<span data-ttu-id="3b61b-148">以下代码片段突出显示在网关已连接（第一个示例）和断开连接（第二个示例）时生成的输出：</span><span class="sxs-lookup"><span data-stu-id="3b61b-148">The following snippets highlight the output generated if the gateway is connected (the first example), and disconnected (the second example):</span></span>

```powershell
PS C:\> Get-AzureRmVirtualNetworkGatewayConnection -Name profx-gateway-connection -ResourceGroupName profx-prod-rg

AuthorizationKey           :
VirtualNetworkGateway1     : Microsoft.Azure.Commands.Network.Models.PSVirtualNetworkGateway
VirtualNetworkGateway2     :
LocalNetworkGateway2       : Microsoft.Azure.Commands.Network.Models.PSLocalNetworkGateway
Peer                       :
ConnectionType             : IPsec
RoutingWeight              : 0
SharedKey                  : ####################################
ConnectionStatus           : Connected
EgressBytesTransferred     : 55254803
IngressBytesTransferred    : 32227221
ProvisioningState          : Succeeded
...
```

```powershell
PS C:\> Get-AzureRmVirtualNetworkGatewayConnection -Name profx-gateway-connection2 -ResourceGroupName profx-prod-rg

AuthorizationKey           :
VirtualNetworkGateway1     : Microsoft.Azure.Commands.Network.Models.PSVirtualNetworkGateway
VirtualNetworkGateway2     :
LocalNetworkGateway2       : Microsoft.Azure.Commands.Network.Models.PSLocalNetworkGateway
Peer                       :
ConnectionType             : IPsec
RoutingWeight              : 0
SharedKey                  : ####################################
ConnectionStatus           : NotConnected
EgressBytesTransferred     : 0
IngressBytesTransferred    : 0
ProvisioningState          : Succeeded
...
```

## <a name="miscellaneous-issues"></a><span data-ttu-id="3b61b-149">其他问题</span><span class="sxs-lookup"><span data-stu-id="3b61b-149">Miscellaneous issues</span></span>

<span data-ttu-id="3b61b-150">以下建议可用于确定主机 VM 配置、网络带宽利用率或应用程序性能是否存在问题：</span><span class="sxs-lookup"><span data-stu-id="3b61b-150">The following recommendations are useful for determining if there is an issue with Host VM configuration, network bandwidth utilization, or application performance:</span></span>

<span data-ttu-id="3b61b-151">**验证防火墙配置。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-151">**Verify firewall configuration.**</span></span> <span data-ttu-id="3b61b-152">验证在子网中 Azure VM 上运行的来宾操作系统中的防火墙是否正确配置为允许来自本地 IP 范围的流量。</span><span class="sxs-lookup"><span data-stu-id="3b61b-152">Verify that the firewall in the guest operating system running on the Azure VMs in the subnet is configured correctly to allow permitted traffic from the on-premises IP ranges.</span></span>

<span data-ttu-id="3b61b-153">**验证流量是否未接近可供 Azure VPN 网关使用的带宽限制。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-153">**Verify that the volume of traffic is not close to the limit of the bandwidth available to the Azure VPN gateway.**</span></span> <span data-ttu-id="3b61b-154">如何进行验证取决于在本地运行的 VPN 设备。</span><span class="sxs-lookup"><span data-stu-id="3b61b-154">How to verify this depends on the VPN appliance running on-premises.</span></span> <span data-ttu-id="3b61b-155">例如，如果在 Windows Server 2012 上使用 RRAS，则可以使用性能监视器跟踪通过 VPN 连接接收和传输的数据量。</span><span class="sxs-lookup"><span data-stu-id="3b61b-155">For example, if you are using RRAS on Windows Server 2012, you can use Performance Monitor to track the volume of data being received and transmitted over the VPN connection.</span></span> <span data-ttu-id="3b61b-156">使用 RAS Total 对象，选择 Bytes Received/Sec 和 Bytes Transmitted/Sec 计数器：</span><span class="sxs-lookup"><span data-stu-id="3b61b-156">Using the *RAS Total* object, select the *Bytes Received/Sec* and *Bytes Transmitted/Sec* counters:</span></span>

![用于监视 VPN 网络流量的性能计数器](../_images/guidance-hybrid-network-vpn/RRAS-perf-counters.png)

<span data-ttu-id="3b61b-158">应该将结果与 VPN 网关可用的带宽（从基本 SKU 提供的 100 Mbps，到 VpnGw3 SKU 提供的 1.25 Gbps）进行比较：</span><span class="sxs-lookup"><span data-stu-id="3b61b-158">You should compare the results with the bandwidth available to the VPN gateway (from 100 Mbps for the Basic SKU to 1.25 Gbps for VpnGw3 SKU):</span></span>

![示例 VPN 网络性能图](../_images/guidance-hybrid-network-vpn/RRAS-perf-graph.png)

<span data-ttu-id="3b61b-160">**验证是否已为应用程序负载部署了正确数量和大小的 VM。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-160">**Verify that you have deployed the right number and size of VMs for your application load.**</span></span> <span data-ttu-id="3b61b-161">确定 Azure VNet 中是否有任何虚拟机运行缓慢。</span><span class="sxs-lookup"><span data-stu-id="3b61b-161">Determine if any of the virtual machines in the Azure VNet are running slowly.</span></span> <span data-ttu-id="3b61b-162">如果有，则它们可能过载、可能数量太少而无法处理负载或负载均衡器未正确配置。</span><span class="sxs-lookup"><span data-stu-id="3b61b-162">If so, they may be overloaded, there may be too few to handle the load, or the load-balancers may not be configured correctly.</span></span> <span data-ttu-id="3b61b-163">若要确定这种情况，请[捕获并分析诊断信息][azure-vm-diagnostics]。</span><span class="sxs-lookup"><span data-stu-id="3b61b-163">To determine this, [capture and analyze diagnostic information][azure-vm-diagnostics].</span></span> <span data-ttu-id="3b61b-164">可以使用 Azure 门户检查结果，不过还有许多可以提供有关性能数据的详细深入信息的第三方工具可用。</span><span class="sxs-lookup"><span data-stu-id="3b61b-164">You can examine the results using the Azure portal, but many third-party tools are also available that can provide detailed insights into the performance data.</span></span>

<span data-ttu-id="3b61b-165">**验证该应用程序是否在高效使用云资源。**</span><span class="sxs-lookup"><span data-stu-id="3b61b-165">**Verify that the application is making efficient use of cloud resources.**</span></span> <span data-ttu-id="3b61b-166">检测每个 VM 上运行的应用程序代码以确定应用程序是否在充分利用资源。</span><span class="sxs-lookup"><span data-stu-id="3b61b-166">Instrument application code running on each VM to determine whether applications are making the best use of resources.</span></span> <span data-ttu-id="3b61b-167">可以使用 [Application Insights][application-insights] 这类工具。</span><span class="sxs-lookup"><span data-stu-id="3b61b-167">You can use tools such as [Application Insights][application-insights].</span></span>

<!-- links -->

[application-insights]: /azure/application-insights/app-insights-overview-usage
[azure-vm-diagnostics]: https://azure.microsoft.com/blog/windows-azure-virtual-machine-monitoring-with-wad-extension/
[gateway-diagnostic-logs]: https://blogs.technet.microsoft.com/keithmayer/2016/10/12/step-by-step-capturing-azure-resource-manager-arm-vnet-gateway-diagnostic-logs/
[psping]: https://technet.microsoft.com/sysinternals/jj729731.aspx
[troubleshooting-vpn-errors]: https://blogs.technet.microsoft.com/rrasblog/2009/08/12/troubleshooting-common-vpn-related-errors/
[vpn-appliance]: /azure/vpn-gateway/vpn-gateway-about-vpn-devices
